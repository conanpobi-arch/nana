<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì˜¤ëŠ˜ì˜ ê¸°ë„</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;600;700&family=Cinzel:wght@400;600&family=Noto+Sans+KR:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #c9a84c;
    --gold-light: #e8d5a3;
    --white: rgba(255,255,255,0.92);
    --shadow: rgba(0,0,0,0.55);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body, html {
    width: 100%; height: 100%;
    overflow: hidden;
    font-family: 'Noto Serif KR', serif;
    background: #111;
  }

  #bg-layer {
    position: fixed; inset: 0; z-index: 0;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    transition: opacity 2s ease;
  }
  #bg-layer-next {
    position: fixed; inset: 0; z-index: 1;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0;
    transition: opacity 2.5s ease;
  }

  #overlay {
    position: fixed; inset: 0; z-index: 2;
    background: linear-gradient(
      to bottom,
      rgba(0,0,0,0.25) 0%,
      rgba(0,0,0,0.1) 30%,
      rgba(0,0,0,0.15) 60%,
      rgba(0,0,0,0.65) 100%
    );
  }

  #light-ray {
    position: fixed; inset: 0; z-index: 3;
    background: radial-gradient(ellipse at 50% 20%, rgba(201,168,76,0.08) 0%, transparent 60%);
    pointer-events: none;
    animation: lightPulse 8s ease-in-out infinite;
  }
  @keyframes lightPulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
  }

  #main {
    position: fixed; inset: 0; z-index: 10;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 40px 20px;
  }

  .cross-deco {
    color: var(--gold);
    font-size: 22px;
    letter-spacing: 12px;
    margin-bottom: 10px;
    opacity: 0.8;
    text-shadow: 0 0 20px rgba(201,168,76,0.6);
    animation: fadeInDown 1.5s ease forwards;
  }

  #date-label {
    font-family: 'Cinzel', serif;
    font-size: clamp(11px, 2vw, 13px);
    color: var(--gold-light);
    letter-spacing: 5px;
    text-transform: uppercase;
    margin-bottom: 6px;
    opacity: 0;
    animation: fadeInDown 1.5s ease 0.3s forwards;
    text-shadow: 0 2px 8px var(--shadow);
  }

  #main-title {
    font-family: 'Noto Serif KR', serif;
    font-size: clamp(24px, 5vw, 38px);
    font-weight: 700;
    color: #fff;
    text-shadow: 0 2px 20px var(--shadow), 0 0 40px rgba(201,168,76,0.2);
    margin-bottom: 30px;
    opacity: 0;
    animation: fadeInDown 1.5s ease 0.5s forwards;
    letter-spacing: 3px;
  }

  .divider {
    display: flex; align-items: center; gap: 14px;
    margin-bottom: 28px;
    opacity: 0;
    animation: fadeIn 1.5s ease 0.8s forwards;
    width: min(560px, 90vw);
  }
  .divider-line {
    flex: 1; height: 1px;
    background: linear-gradient(to right, transparent, var(--gold), transparent);
  }
  .divider-icon { color: var(--gold); font-size: 14px; opacity: 0.9; }

  #prayer-box {
    width: min(620px, 92vw);
    height: 45vh;
    overflow: hidden;
    background: rgba(0,0,0,0.38);
    border: 1px solid rgba(201,168,76,0.25);
    border-radius: 4px;
    padding: 0 36px;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    opacity: 0;
    animation: fadeInUp 1.5s ease 1s forwards;
    position: relative;
  }
  #prayer-box::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 60px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.38), transparent);
    z-index: 2;
    pointer-events: none;
  }
  #prayer-box::after {
    content: '';
    position: absolute; bottom: 0; left: 0; right: 0;
    height: 60px;
    background: linear-gradient(to top, rgba(0,0,0,0.38), transparent);
    z-index: 2;
    pointer-events: none;
  }
  #prayer-scroll-wrap {
    display: flex;
    flex-direction: column;
    animation: none;
  }

  #prayer-text {
    font-size: clamp(14px, 2.5vw, 17px);
    line-height: 2.4;
    color: var(--white);
    font-weight: 300;
    text-align: center;
    white-space: pre-line;
    text-shadow: 0 1px 6px rgba(0,0,0,0.7);
    letter-spacing: 0.5px;
  }

  #prayer-edit {
    display: none;
    width: 100%; min-height: 200px;
    background: transparent;
    border: none; outline: none;
    font-family: 'Noto Serif KR', serif;
    font-size: clamp(14px, 2.5vw, 17px);
    line-height: 2.4;
    color: var(--white);
    font-weight: 300;
    text-align: center;
    resize: none;
    text-shadow: 0 1px 6px rgba(0,0,0,0.7);
    caret-color: var(--gold);
  }

  #bottom-bar {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
    padding: 18px 30px 24px;
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
    display: flex; align-items: center; justify-content: space-between;
    gap: 14px;
    opacity: 0;
    animation: fadeIn 2s ease 1.5s forwards;
  }

  #yt-section {
    display: flex; align-items: center; gap: 10px;
    flex: 1;
  }
  #yt-input {
    flex: 1;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 30px;
    color: #fff;
    padding: 9px 18px;
    font-size: 12px;
    font-family: 'Noto Sans KR', sans-serif;
    outline: none;
    transition: border-color 0.3s;
    max-width: 280px;
  }
  #yt-input::placeholder { color: rgba(255,255,255,0.3); }
  #yt-input:focus { border-color: var(--gold); }

  .ctrl-btn {
    width: 42px; height: 42px;
    border-radius: 50%;
    border: 1px solid rgba(201,168,76,0.4);
    background: rgba(0,0,0,0.45);
    color: var(--gold-light);
    font-size: 17px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    backdrop-filter: blur(8px);
    flex-shrink: 0;
  }
  .ctrl-btn:hover { background: rgba(201,168,76,0.2); border-color: var(--gold); transform: scale(1.05); }
  .ctrl-btn.active { background: rgba(201,168,76,0.25); border-color: var(--gold); }

  #right-btns { display: flex; gap: 10px; align-items: center; }

  #photo-credit {
    position: fixed; bottom: 80px; right: 18px; z-index: 20;
    font-size: 10px; color: rgba(255,255,255,0.3);
    font-family: 'Noto Sans KR', sans-serif;
    text-align: right;
    opacity: 0;
    transition: opacity 0.5s;
  }
  #photo-credit a { color: rgba(255,255,255,0.35); text-decoration: none; }

  #yt-frame { position: fixed; top: -9999px; left: -9999px; width: 1px; height: 1px; }

  .home-btn {
    position: fixed;
    top: 20px; left: 20px;
    z-index: 9000;
    font-size: 26px;
    text-decoration: none;
    color: rgba(201,168,76,0.7);
    transition: 0.3s;
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(201,168,76,0.2);
    backdrop-filter: blur(8px);
  }
  .home-btn:hover {
    color: #fff;
    background: rgba(201,168,76,0.2);
    border-color: rgba(201,168,76,0.6);
    transform: scale(1.1);
    text-shadow: 0 0 15px rgba(201,168,76,0.8), 0 0 30px rgba(201,168,76,0.4);
  }

  /* ìŒì•… ì¬ìƒ ì¤‘ í‘œì‹œ */
  #music-indicator {
    position: fixed; top: 20px; right: 20px; z-index: 9000;
    display: none;
    align-items: center; gap: 8px;
    background: rgba(0,0,0,0.5);
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 20px;
    padding: 8px 14px;
    font-size: 12px;
    color: var(--gold-light);
    font-family: 'Noto Sans KR', sans-serif;
    backdrop-filter: blur(8px);
  }
  .music-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--gold);
    animation: musicPulse 1.2s ease-in-out infinite;
  }
  @keyframes musicPulse { 0%,100%{opacity:0.3;transform:scale(0.8)} 50%{opacity:1;transform:scale(1.2)} }

  #loading-screen {
    position: fixed; inset: 0; z-index: 9999;
    background: #0a0a0a;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 20px;
    transition: opacity 1s ease;
  }
  .loading-cross { font-size: 40px; animation: pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:0.4} 50%{opacity:1} }
  .loading-text {
    font-family: 'Cinzel', serif;
    color: var(--gold);
    font-size: 13px;
    letter-spacing: 5px;
    opacity: 0.7;
  }

  #edit-hint {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    z-index: 20;
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.4);
    border-radius: 20px;
    padding: 8px 20px;
    font-size: 12px;
    color: var(--gold-light);
    font-family: 'Noto Sans KR', sans-serif;
    display: none;
    animation: fadeIn 0.5s ease;
  }

  @keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes bgKenBurns {
    0% { transform: scale(1); }
    100% { transform: scale(1.06); }
  }
  #bg-layer, #bg-layer-next {
    animation: bgKenBurns 30s ease-in-out alternate infinite;
  }
</style>
</head>
<body>

<a href="index.html" class="home-btn">ğŸ </a>

<!-- ìŒì•… ì¬ìƒ ì¤‘ í‘œì‹œ -->
<div id="music-indicator">
  <div class="music-dot"></div>
  <span id="music-indicator-text">ìŒì•… ì¬ìƒ ì¤‘</span>
</div>

<div id="loading-screen">
  <div class="loading-cross">âœ</div>
  <div class="loading-text">PREPARING YOUR PRAYER</div>
</div>

<div id="bg-layer"></div>
<div id="bg-layer-next"></div>
<div id="overlay"></div>
<div id="light-ray"></div>

<div id="photo-credit"></div>
<div id="edit-hint">âœï¸ ê¸°ë„ë¬¸ì„ ììœ ë¡­ê²Œ ìˆ˜ì •í•˜ì„¸ìš” â€” ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ ì™„ë£Œ</div>

<div id="main">
  <div class="cross-deco">âœ¦ âœ âœ¦</div>
  <div id="date-label"></div>
  <div id="main-title">ì˜¤ëŠ˜ì˜ ê¸°ë„</div>

  <div class="divider">
    <div class="divider-line"></div>
    <div class="divider-icon">âœ¦</div>
    <div class="divider-line"></div>
  </div>

  <div id="prayer-box">
    <div id="prayer-scroll-wrap">
      <div id="prayer-text"></div>
    </div>
    <textarea id="prayer-edit" spellcheck="false"></textarea>
  </div>
</div>

<div id="bottom-bar">
  <div id="yt-section">
    <span style="font-size:18px;">ğŸµ</span>
    <input id="yt-input" type="text" placeholder="ìœ íŠœë¸Œ ë§í¬ ë˜ëŠ” ì˜ìƒ ID ì…ë ¥...">
    <div class="ctrl-btn" onclick="playYoutube()" title="ì¬ìƒ">â–¶</div>
    <div class="ctrl-btn" id="mute-btn" onclick="toggleMute()" title="ìŒì†Œê±°">ğŸ”Š</div>
  </div>
  <div id="right-btns">
    <div class="ctrl-btn" onclick="refreshBg()" title="ë°°ê²½ ë³€ê²½">ğŸŒ„</div>
    <div class="ctrl-btn" id="edit-btn" onclick="toggleEdit()" title="ê¸°ë„ë¬¸ í¸ì§‘">âœï¸</div>
  </div>
</div>

<iframe id="yt-frame" allow="autoplay"></iframe>

<script>
  const DEFAULT_PRAYERS = [
    `ì£¼ë‹˜,
ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì£¼ì‹¬ì— ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.

ì´ ì•„ë¦„ë‹¤ìš´ í”¼ì¡°ì„¸ê³„ ì•ì— ì„œì„œ
ë‹¹ì‹ ì˜ ìœ„ëŒ€í•˜ì‹¬ì„ ê³ ë°±í•©ë‹ˆë‹¤.

ì–´ì œì˜ ë¬´ê±°ì›€ì€ ë‚´ë ¤ë†“ê³ 
ì˜¤ëŠ˜ì˜ ì€í˜œë¡œ ë‹¤ì‹œ ì¼ì–´ì„œê²Œ í•˜ì†Œì„œ.

ë‘ë ¤ì›€ì´ ì•„ë‹Œ ë¯¿ìŒìœ¼ë¡œ
ê±±ì •ì´ ì•„ë‹Œ ê°ì‚¬ë¡œ
ì´ í•˜ë£¨ë¥¼ ê±¸ì–´ê°€ê²Œ í•˜ì†Œì„œ.

ë‹¹ì‹ ì˜ í‰í™”ê°€
ì´ ë§ˆìŒì— ê°€ë“í•˜ê¸°ë¥¼ ê¸°ë„í•©ë‹ˆë‹¤.

ì•„ë©˜.`,
    `í•˜ë‚˜ë‹˜ ì•„ë²„ì§€,
ì´ ê³ ìš”í•œ ì•„ì¹¨ì— ë¬´ë¦ ê¿‡ìŠµë‹ˆë‹¤.

ì €ë¥¼ ë¶€ë¥´ì‹  ëœ»ëŒ€ë¡œ
ì‚¬ë‘í•˜ë©° ì‚´ê²Œ í•˜ì†Œì„œ.

ì—°ì•½í•  ë•Œ ê°•í•˜ê²Œ í•˜ì‹œê³ 
í™€ë¡œì¼ ë•Œ í•¨ê»˜í•˜ì‹œë©°
ê¸¸ì„ ìƒì„ ë•Œ ë¹›ì´ ë˜ì–´ì£¼ì†Œì„œ.

ì˜¤ëŠ˜ ë§Œë‚˜ëŠ” ëª¨ë“  ì´ë“¤ì—ê²Œ
ë‹¹ì‹ ì˜ ì‚¬ë‘ì„ ì „í•˜ëŠ”
í†µë¡œê°€ ë˜ê²Œ í•˜ì†Œì„œ.

ì•„ë©˜.`,
    `ì£¼ë‹˜,
ë‹¹ì‹ ì´ ë§Œë“œì‹  ì´ ì„¸ìƒì´
ì–¼ë§ˆë‚˜ ì•„ë¦„ë‹¤ìš´ì§€ìš”.

ì‚°ê³¼ ë“¤, ë°”ë‹¤ì™€ í•˜ëŠ˜
ê·¸ ëª¨ë“  ê²ƒì´ ë‹¹ì‹ ì˜ ì†œì”¨ì…ë‹ˆë‹¤.

ì´ ì•„ë¦„ë‹¤ì›€ì„ ë³´ëŠ” ëˆˆê³¼
ê°ì‚¬í•  ìˆ˜ ìˆëŠ” ë§ˆìŒì„ ì£¼ì…”ì„œ
ê°ì‚¬í•©ë‹ˆë‹¤.

ì˜¤ëŠ˜ë„ ë‹¹ì‹ ì˜ ì°½ì¡° ì•ˆì—ì„œ
ê¸°ì¨ìœ¼ë¡œ ì‚´ì•„ê°€ê²Œ í•˜ì†Œì„œ.

ì•„ë©˜.`
  ];

  // â”€â”€ Supabase ì„¤ì • (config APIì—ì„œ ë¡œë“œ) â”€â”€
  let SUPABASE_URL = '', SUPABASE_KEY = '';
  let currentPrayer = '';
  let isEditing = false;
  let isMuted = false;
  let bgIndex = 0;

  async function initSupabase() {
    try {
      const r = await fetch('/api/config');
      if (!r.ok) throw new Error('config ì˜¤ë¥˜');
      const cfg = await r.json();
      SUPABASE_URL = cfg.supabaseUrl;
      SUPABASE_KEY = cfg.supabaseKey;
    } catch(e) {
      console.warn('Supabase ì´ˆê¸°í™” ì‹¤íŒ¨, localStorageë§Œ ì‚¬ìš©:', e.message);
    }
  }

  function sbH() {
    return { 'Content-Type':'application/json', 'apikey': SUPABASE_KEY, 'Authorization':'Bearer '+SUPABASE_KEY };
  }

  // â”€â”€ ì„¤ì • ì €ì¥ (Supabase ìš°ì„ , fallback localStorage) â”€â”€
  async function saveSetting(key, value) {
    localStorage.setItem(key, value); // í•­ìƒ ë¡œì»¬ì—ë„ ì €ì¥
    if (!SUPABASE_URL) return;
    try {
      // upsert: keyê°€ ìˆìœ¼ë©´ update, ì—†ìœ¼ë©´ insert
      await fetch(SUPABASE_URL + '/rest/v1/app_settings', {
        method: 'POST',
        headers: Object.assign({}, sbH(), { 'Prefer': 'resolution=merge-duplicates' }),
        body: JSON.stringify({ key, value })
      });
    } catch(e) { console.warn('ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', e.message); }
  }

  // â”€â”€ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° (Supabase ìš°ì„ , fallback localStorage) â”€â”€
  async function loadSetting(key) {
    if (SUPABASE_URL) {
      try {
        const r = await fetch(SUPABASE_URL + '/rest/v1/app_settings?key=eq.' + key + '&select=value', { headers: sbH() });
        if (r.ok) {
          const data = await r.json();
          if (data && data[0]) return data[0].value;
        }
      } catch(e) { console.warn('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e.message); }
    }
    return localStorage.getItem(key); // fallback
  }

  // â”€â”€ Bing ì›”í˜ì´í¼ â”€â”€
  async function getBingImageUrl() {
    try {
      const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=8&mkt=ko-KR');
      const res = await fetch(proxyUrl);
      const json = await res.json();
      const data = JSON.parse(json.contents);
      const img = data.images[bgIndex % data.images.length];
      return 'https://www.bing.com' + img.url;
    } catch(e) {
      const id = [15, 28, 37, 40, 42, 57, 62, 70][bgIndex % 8];
      const w = Math.min(Math.round(window.innerWidth * (window.devicePixelRatio || 1)), 2400);
      const h = Math.min(Math.round(window.innerHeight * (window.devicePixelRatio || 1)), 1600);
      return `https://picsum.photos/${w}/${h}?image=${id}`;
    }
  }

  async function loadBg(first) {
    const url = await getBingImageUrl();
    bgIndex++;
    const img = new Image();
    img.onload = function() {
      if (first) {
        document.getElementById('bg-layer').style.backgroundImage = `url(${url})`;
        hideLanding();
      } else {
        const next = document.getElementById('bg-layer-next');
        next.style.backgroundImage = `url(${url})`;
        next.style.opacity = '1';
        setTimeout(() => {
          document.getElementById('bg-layer').style.backgroundImage = `url(${url})`;
          next.style.transition = 'none';
          next.style.opacity = '0';
          setTimeout(() => { next.style.transition = 'opacity 2.5s ease'; }, 50);
        }, 2600);
      }
      const credit = document.getElementById('photo-credit');
      credit.innerHTML = `ğŸ“· <a href="https://www.bing.com" target="_blank">Bing ì˜¤ëŠ˜ì˜ ë°°ê²½</a>`;
      credit.style.opacity = '1';
      setTimeout(() => { credit.style.opacity = '0'; }, 4000);
    };
    img.onerror = function() {
      const fallbacks = [
        'linear-gradient(135deg, #1a3a5c 0%, #0d1f35 50%, #2c1810 100%)',
        'linear-gradient(135deg, #1a2c1a 0%, #0d1f0d 50%, #1a2c35 100%)',
        'linear-gradient(135deg, #3a2c1a 0%, #1a1a2c 50%, #0d1f35 100%)',
      ];
      if (first) {
        document.getElementById('bg-layer').style.background = fallbacks[bgIndex % fallbacks.length];
        hideLanding();
      }
    };
    img.src = url;
  }

  function refreshBg() { loadBg(false); }

  function hideLanding() {
    const ls = document.getElementById('loading-screen');
    ls.style.opacity = '0';
    setTimeout(() => { ls.style.display = 'none'; }, 1000);
  }

  function setDate() {
    const now = new Date();
    const days = ['ì£¼ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
    document.getElementById('date-label').textContent =
      `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›” ${now.getDate()}ì¼ ${days[now.getDay()]}`;
  }

  async function loadPrayer() {
    const saved = await loadSetting('daily_prayer_custom');
    currentPrayer = saved || DEFAULT_PRAYERS[new Date().getDay() % DEFAULT_PRAYERS.length];
    document.getElementById('prayer-text').textContent = currentPrayer;
    document.getElementById('prayer-edit').value = currentPrayer;
  }

  // â”€â”€ ìë™ ìŠ¤í¬ë¡¤ â”€â”€
  let scrollAnim = null, scrollPos = 0, scrollSpeed = 0.5, scrollPaused = false;

  function startAutoScroll() {
    const wrap = document.getElementById('prayer-scroll-wrap');
    const box  = document.getElementById('prayer-box');
    if (!wrap || !box) return;
    const totalH = wrap.scrollHeight, boxH = box.clientHeight;
    if (totalH <= boxH) return;
    scrollPos = 0;
    wrap.style.transform = 'translateY(0px)';
    function step() {
      if (scrollPaused) { scrollAnim = requestAnimationFrame(step); return; }
      scrollPos += scrollSpeed;
      if (scrollPos >= totalH - boxH + 60) {
        scrollPos = 0;
        wrap.style.transition = 'none';
        wrap.style.transform = 'translateY(0px)';
        setTimeout(() => { wrap.style.transition = ''; scrollAnim = requestAnimationFrame(step); }, 2000);
        return;
      }
      wrap.style.transform = `translateY(-${scrollPos}px)`;
      scrollAnim = requestAnimationFrame(step);
    }
    setTimeout(() => { scrollAnim = requestAnimationFrame(step); }, 2000);
  }

  function stopAutoScroll() {
    if (scrollAnim) cancelAnimationFrame(scrollAnim);
    scrollPos = 0;
    const wrap = document.getElementById('prayer-scroll-wrap');
    if (wrap) wrap.style.transform = 'translateY(0px)';
  }

  document.getElementById('prayer-box').addEventListener('mouseenter', () => { scrollPaused = true; });
  document.getElementById('prayer-box').addEventListener('mouseleave', () => { scrollPaused = false; });

  // â”€â”€ í¸ì§‘ ëª¨ë“œ â”€â”€
  function toggleEdit() {
    isEditing = !isEditing;
    const btn  = document.getElementById('edit-btn');
    const hint = document.getElementById('edit-hint');
    const wrap = document.getElementById('prayer-scroll-wrap');
    const pEdit = document.getElementById('prayer-edit');
    const box  = document.getElementById('prayer-box');

    if (isEditing) {
      stopAutoScroll();
      wrap.style.display = 'none';
      box.style.overflow = 'auto';
      box.style.padding  = '30px 36px';
      pEdit.style.display = 'block';
      pEdit.value = currentPrayer;
      pEdit.focus();
      btn.textContent = 'ğŸ’¾';
      btn.classList.add('active');
      hint.style.display = 'block';
    } else {
      currentPrayer = pEdit.value;
      saveSetting('daily_prayer_custom', currentPrayer);
      document.getElementById('prayer-text').textContent = currentPrayer;
      pEdit.style.display = 'none';
      box.style.overflow = 'hidden';
      box.style.padding  = '0 36px';
      wrap.style.display = 'flex';
      btn.textContent = 'âœï¸';
      btn.classList.remove('active');
      hint.style.display = 'none';
      setTimeout(startAutoScroll, 500);
    }
  }

  // â”€â”€ ìœ íŠœë¸Œ ì¬ìƒ â”€â”€
  function getYtId(input) {
    input = input.trim();
    const patterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
      /^([a-zA-Z0-9_-]{11})$/
    ];
    for (const p of patterns) {
      const m = input.match(p);
      if (m) return m[1];
    }
    return null;
  }

  function playYoutube() {
    const input = document.getElementById('yt-input').value;
    const id = getYtId(input);
    if (!id) { alert('ì˜¬ë°”ë¥¸ ìœ íŠœë¸Œ ë§í¬ ë˜ëŠ” ì˜ìƒ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

    // ë§í¬ì™€ ID ëª¨ë‘ ì €ì¥ (Supabase + localStorage)
    saveSetting('prayer_yt_link', input);
    saveSetting('prayer_yt_id', id);

    const frame = document.getElementById('yt-frame');
    frame.src = `https://www.youtube.com/embed/${id}?autoplay=1&loop=1&playlist=${id}&controls=0&mute=${isMuted ? 1 : 0}`;

    // ì¬ìƒ ì¤‘ í‘œì‹œ
    showMusicIndicator();
  }

  function showMusicIndicator() {
    const ind = document.getElementById('music-indicator');
    ind.style.display = 'flex';
  }

  function toggleMute() {
    isMuted = !isMuted;
    saveSetting('prayer_muted', isMuted ? '1' : '0');
    document.getElementById('mute-btn').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
    const frame = document.getElementById('yt-frame');
    if (frame.src && frame.src.includes('youtube')) {
      frame.src = frame.src.replace(/mute=\d/, `mute=${isMuted ? 1 : 0}`);
    }
  }

  // â”€â”€ ë°°ê²½ ìë™ ë³€ê²½ (30ë¶„) â”€â”€
  setInterval(refreshBg, 30 * 60 * 1000);

  // â”€â”€ ë©”ì¸ ì´ˆê¸°í™” (async) â”€â”€
  async function startApp() {
    // 1. Supabase ì—°ê²°
    await initSupabase();

    // 2. ë‚ ì§œ + ê¸°ë„ë¬¸ + ë°°ê²½
    setDate();
    await loadPrayer();
    loadBg(true);
    setTimeout(startAutoScroll, 3000);

    // 3. ìŒì†Œê±° ìƒíƒœ ë³µì›
    const savedMuted = await loadSetting('prayer_muted');
    if (savedMuted === '1') {
      isMuted = true;
      document.getElementById('mute-btn').textContent = 'ğŸ”‡';
    }

    // 4. ìœ íŠœë¸Œ ë§í¬ ë³µì› (Supabase or localStorage)
    const savedYt = await loadSetting('prayer_yt_link');
    if (savedYt) {
      document.getElementById('yt-input').value = savedYt;
      // PC: ìë™ ì¬ìƒ / ëª¨ë°”ì¼: ë§í¬ë§Œ í‘œì‹œ (ë¸Œë¼ìš°ì € ì •ì±…ìƒ ìë™ì¬ìƒ ë¶ˆê°€)
      setTimeout(() => { playYoutube(); }, 2000);
    }
  }

  startApp();
</script>
</body>
</html>
