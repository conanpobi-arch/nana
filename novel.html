<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>NANA NOVEL : ULTIMATE</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@300;400;500&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root { --neon: #00ffcc; --bg: #000b1a; --border: rgba(0,255,204,0.2); }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body, html { width: 100%; height: 100%; background: #000; color: #fff; font-family: 'Noto Sans KR', sans-serif; overflow-x: hidden; }
    #galaxy-bg { position: fixed; inset: 0; z-index: 0; background: radial-gradient(ellipse at bottom, #0d1d31 0%, #0c0d13 100%); }
    #main-view { position: relative; z-index: 2; max-width: 850px; margin: 0 auto; min-height: 100vh; padding: 2vh 20px 40px; }
    
    /* í—¤ë” */
    .nav-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; margin-bottom: 15px; }
    .home-icon { cursor: pointer; font-size: 26px; color: var(--neon); transition: 0.3s; }
    .engine-title { font-family: 'Orbitron'; color: var(--neon); font-size: 15px; font-weight: bold; letter-spacing: 2px; text-shadow: 0 0 10px var(--neon); }
    .trash-icon { cursor: pointer; font-size: 26px; opacity: 0.6; }

    /* íƒ­ */
    .tab-bar { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; }
    .tab-btn { flex: 1; min-width: 80px; padding: 12px 5px; background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 12px; color: #aaa; font-family: 'Orbitron'; font-size: 10px; cursor: pointer; text-align: center; }
    .tab-btn.active { background: rgba(0,255,204,0.15); border-color: var(--neon); color: var(--neon); }
    
    .card { background: rgba(0,15,35,0.75); border: 1px solid var(--border); border-radius: 20px; padding: 20px; backdrop-filter: blur(15px); margin-bottom: 16px; }
    textarea, .modal-input, .novel-select { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 15px; font-size: 14px; outline: none; margin-bottom: 12px; }
    .btn-fire { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 15px; font-weight: 900; font-family: 'Orbitron'; cursor: pointer; font-size: 13px; }
    
    /* ë¦¬ìŠ¤íŠ¸ */
    .novel-card { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 14px; }
    .novel-info { flex: 1; cursor: pointer; }
    .novel-btns { display: flex; gap: 12px; }
    .n-icon-btn { cursor: pointer; font-size: 18px; opacity: 0.7; }

    /* ì±•í„°/í•©ë³¸ ë·°ì–´ (ìˆ˜ì •ë¨) */
    #chapter-view { display: none; position: fixed; inset: 0; z-index: 500; background: #000b1a; overflow-y: auto; padding: 20px; }
    .ch-header { position: sticky; top: 0; background: #000b1a; display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); margin-bottom: 15px; z-index: 10; }
    .reader-content { font-family: 'Noto Serif KR', serif; line-height: 1.8; color: #ddd; font-size: 16px; padding: 10px; white-space: pre-wrap; }

    /* ì†Œì„¤ ì¶”ê°€ ëª¨ë‹¬ */
    #add-modal { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
  </style>
</head>
<body>
<div id="galaxy-bg"></div>

<div id="add-modal">
  <div class="card" style="width: 90%; max-width: 400px;">
    <h3 style="margin-bottom:15px; color:var(--neon); font-family:Orbitron;">NEW NOVEL</h3>
    <input class="modal-input" id="new-title" placeholder="ì†Œì„¤ ì œëª©">
    <input class="modal-input" id="new-author" placeholder="ì‘ê°€ëª…">
    <button class="btn-fire" onclick="addNewNovel()">ìƒì„±í•˜ê¸°</button>
    <button onclick="document.getElementById('add-modal').style.display='none'" style="width:100%; background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">ë‹«ê¸°</button>
  </div>
</div>

<div id="main-view">
  <div class="nav-header">
    <div class="home-icon" onclick="goHome()">ğŸ </div>
    <div class="engine-title">NANA : ULTIMATE</div>
    <div class="trash-icon" onclick="clearAll()">ğŸ—‘ï¸</div>
  </div>

  <div class="tab-bar">
    <div class="tab-btn active" id="tab-translate" onclick="switchTab('translate')">ğŸ”„ ë²ˆì—­</div>
    <div class="tab-btn" id="tab-auto" onclick="switchTab('auto')">ğŸ›°ï¸ ì—”ì§„</div>
    <div class="tab-btn" id="tab-progress" onclick="switchTab('progress')">âœï¸ ì§„í–‰</div>
    <div class="tab-btn" id="tab-done" onclick="switchTab('done')">ğŸ“š ì„œì¬</div>
  </div>

  <div id="panel-translate">
    <div class="card">
        <div style="display:flex; gap:8px;">
            <select class="novel-select" id="quick-novel-select"></select>
            <button onclick="document.getElementById('add-modal').style.display='flex'" style="height:48px; width:50px; background:none; border:1px solid var(--neon); color:var(--neon); border-radius:12px; font-size:20px; cursor:pointer;">+</button>
        </div>
        <textarea id="mainInput" placeholder="ì›ë¬¸ ì…ë ¥..." style="height:200px;"></textarea>
        <button class="btn-fire">ğŸ”¥ ë²ˆì—­ ì‹œì‘</button>
    </div>
  </div>

  <div id="panel-auto" style="display:none;">
    <div class="card">
      <input class="modal-input" id="auto-base-url" placeholder="ì£¼ì†Œ íŒ¨í„´">
      <select class="novel-select" id="auto-novel-select"></select>
      <button class="btn-fire" onclick="alert('íŒ¨í‚· ë³µì‚¬ ê¸°ëŠ¥ì„ ì‹¤í–‰í•˜ì„¸ìš”')">ğŸš€ ì—”ì§„ ì í™”</button>
    </div>
  </div>
  <div id="panel-progress" style="display:none;"><div id="novel-list-progress"></div></div>
  <div id="panel-done" style="display:none;"><div id="novel-list-done"></div></div>
</div>

<div id="chapter-view">
  <div class="ch-header">
    <div class="home-icon" onclick="closeChapterView()">â†</div>
    <div id="ch-novel-title" class="engine-title" style="font-size:13px;"></div>
    <div id="compile-area"></div>
  </div>
  <div id="reader-container">
    <div id="chapter-list"></div> <div id="full-reader" class="reader-content" style="display:none;"></div> </div>
</div>

<script>
  const SUPABASE_URL = 'https://hbfvyhlrnccccerzbami.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiZnZ5aGxybmNjY2NlcnpiYW1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODc2NzIsImV4cCI6MjA4NzE2MzY3Mn0.V9LJZAzCGinYmwzvWGLbfLhAFRnz4pDG_rVaTwTg74A';
  const sbH = () => ({ 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY });

  let currentNovel = null;

  function goHome() { location.href = 'index.html'; }
  function clearAll() { if(confirm("ì´ˆê¸°í™”?")) document.querySelectorAll('input,textarea').forEach(i=>i.value=''); }

  function switchTab(tab) {
    ['translate', 'auto', 'progress', 'done'].forEach(t => {
      document.getElementById('tab-'+t).classList.toggle('active', t===tab);
      document.getElementById('panel-'+t).style.display = t===tab ? 'block' : 'none';
    });
    if(tab==='progress' || tab==='done') loadNovels(tab);
    updateSelectors();
  }

  async function updateSelectors() {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novels?status=eq.progress`, { headers: sbH() });
    const data = await res.json();
    const opts = '<option value="">ì†Œì„¤ ì„ íƒ...</option>' + data.map(n=>`<option value="${n.id}">${n.title}</option>`).join('');
    document.getElementById('quick-novel-select').innerHTML = opts;
    document.getElementById('auto-novel-select').innerHTML = opts;
  }

  async function addNewNovel() {
    const title = document.getElementById('new-title').value;
    const author = document.getElementById('new-author').value;
    if(!title) return alert("ì œëª© ì…ë ¥!");
    await fetch(`${SUPABASE_URL}/rest/v1/novels`, {
      method:'POST', headers:sbH(),
      body: JSON.stringify({ title, author, status:'progress', cover_emoji:'ğŸ“–' })
    });
    document.getElementById('add-modal').style.display='none';
    updateSelectors();
    switchTab('progress');
  }

  async function loadNovels(status) {
    const list = document.getElementById('novel-list-'+status);
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novels?status=eq.${status}&order=created_at.desc`, { headers: sbH() });
    const data = await res.json();
    list.innerHTML = data.map(n => `
      <div class="novel-card">
        <div class="novel-info" onclick="openReader('${n.id}', '${n.title}', '${n.status}')">
          <div style="font-weight:bold;">${n.cover_emoji || 'ğŸ“–'} ${n.title}</div>
          <div style="font-size:11px; color:#888;">${n.author || 'ì‘ê°€ë¯¸ìƒ'}</div>
        </div>
        <div class="novel-btns">
          <div class="n-icon-btn" onclick="deleteNovel('${n.id}')">ğŸ—‘ï¸</div>
        </div>
      </div>
    `).join('');
  }

  async function openReader(id, title, status) {
    currentNovel = { id, title };
    document.getElementById('ch-novel-title').textContent = title;
    document.getElementById('chapter-view').style.display = 'block';
    
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novel_chapters?novel_id=eq.${id}&order=chapter_num.asc`, { headers: sbH() });
    const data = await res.json();

    if(status === 'done') {
      // ì„œì¬(í•©ë³¸) íŒŒì¼ì¸ ê²½ìš°: ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹ˆë¼ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ë°”ë¡œ ë³´ì—¬ì¤Œ
      document.getElementById('chapter-list').style.display = 'none';
      document.getElementById('full-reader').style.display = 'block';
      document.getElementById('full-reader').textContent = data.map(c => c.translated).join('\n\n');
      document.getElementById('compile-area').innerHTML = '';
    } else {
      // ì§„í–‰í˜•ì¸ ê²½ìš°: ì±•í„° ë¦¬ìŠ¤íŠ¸ì™€ í•©ë³¸ ë²„íŠ¼ ë³´ì—¬ì¤Œ
      document.getElementById('chapter-list').style.display = 'block';
      document.getElementById('full-reader').style.display = 'none';
      document.getElementById('compile-area').innerHTML = `<button onclick="compileToDone()" style="color:red; background:none; border:1px solid red; padding:4px 8px; border-radius:5px; font-size:10px;">ğŸ“• í•©ë³¸</button>`;
      document.getElementById('chapter-list').innerHTML = data.map(c => `
        <div style="padding:15px; border-bottom:1px solid #222;">
          <div style="color:var(--neon); font-size:12px;">CH ${c.chapter_num}</div>
          <div style="font-size:14px; color:#ccc; margin-top:5px;">${c.translated.substring(0,100)}...</div>
        </div>
      `).join('');
    }
  }

  function closeChapterView() { document.getElementById('chapter-view').style.display = 'none'; }

  async function compileToDone() {
    if(!confirm("í•©ë³¸í•˜ì—¬ ì„œì¬ë¡œ ë³´ë‚¼ê¹Œìš”?")) return;
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novel_chapters?novel_id=eq.${currentNovel.id}&order=chapter_num.asc`, { headers: sbH() });
    const chapters = await res.json();
    const fullText = chapters.map(c => `[CH ${c.chapter_num}]\n${c.translated}`).join('\n\n---\n\n');
    
    // 1. ì„œì¬ì— ğŸ“• ì†Œì„¤ ìƒì„±
    const novelRes = await fetch(`${SUPABASE_URL}/rest/v1/novels`, {
      method:'POST', headers: Object.assign({}, sbH(), { 'Prefer': 'return=representation' }),
      body: JSON.stringify({ title: currentNovel.title + " (í•©ë³¸)", status: 'done', cover_emoji: 'ğŸ“•' })
    });
    const newNovel = await novelRes.json();
    
    // 2. ë‚´ìš© ì…ë ¥
    await fetch(`${SUPABASE_URL}/rest/v1/novel_chapters`, {
      method:'POST', headers: sbH(),
      body: JSON.stringify({ novel_id: newNovel[0].id, chapter_num: 1, translated: fullText })
    });

    alert("í•©ë³¸ ì™„ë£Œ! ì„œì¬ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
    closeChapterView();
    switchTab('done');
  }

  async function deleteNovel(id) {
    if(confirm("ì‚­ì œ?")) {
      await fetch(`${SUPABASE_URL}/rest/v1/novels?id=eq.${id}`, { method:'DELETE', headers:sbH() });
      loadNovels('progress'); loadNovels('done');
    }
  }

  window.onload = () => { updateSelectors(); loadNovels('progress'); };
</script>
</body>
</html>
