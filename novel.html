<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>NANA NOVEL : ULTIMATE</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@300;400;500&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root { --neon: #00ffcc; --bg: #000b1a; --border: rgba(0,255,204,0.2); }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body, html { width: 100%; height: 100%; background: #000; color: #fff; font-family: 'Noto Sans KR', sans-serif; overflow-x: hidden; }
    #galaxy-bg { position: fixed; inset: 0; z-index: 0; background: radial-gradient(ellipse at bottom, #0d1d31 0%, #0c0d13 100%); }
    #main-view { position: relative; z-index: 2; max-width: 850px; margin: 0 auto; min-height: 100vh; padding: 2vh 20px 40px; }
    
    /* í—¤ë” */
    .nav-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; margin-bottom: 15px; }
    .home-icon { cursor: pointer; font-size: 26px; color: var(--neon); transition: 0.3s; }
    .engine-title { font-family: 'Orbitron'; color: var(--neon); font-size: 15px; font-weight: bold; letter-spacing: 2px; text-shadow: 0 0 10px var(--neon); }
    .trash-icon { cursor: pointer; font-size: 26px; transition: 0.3s; }

    /* íƒ­ */
    .tab-bar { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn { flex: 1; padding: 12px 5px; background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 12px; color: #aaa; font-family: 'Orbitron'; font-size: 10px; cursor: pointer; text-align: center; }
    .tab-btn.active { background: rgba(0,255,204,0.15); border-color: var(--neon); color: var(--neon); }
    
    .card { background: rgba(0,15,35,0.75); border: 1px solid var(--border); border-radius: 20px; padding: 20px; backdrop-filter: blur(15px); margin-bottom: 16px; }
    textarea, .modal-input, .novel-select { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 15px; font-size: 14px; outline: none; margin-bottom: 12px; }
    .btn-fire { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 15px; font-weight: 900; font-family: 'Orbitron'; cursor: pointer; font-size: 13px; }
    
    /* ë¦¬ìŠ¤íŠ¸ ë° ì•„ì´ì½˜ */
    .novel-card { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 14px; }
    .novel-info { flex: 1; cursor: pointer; overflow: hidden; }
    .novel-title-text { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .novel-btns { display: flex; gap: 12px; }
    .n-icon-btn { cursor: pointer; font-size: 18px; opacity: 0.7; transition: 0.2s; }
    .n-icon-btn:hover { opacity: 1; transform: scale(1.1); }

    /* ì±•í„° ë·° */
    #chapter-view { display: none; position: fixed; inset: 0; z-index: 500; background: #000b1a; overflow-y: auto; padding: 20px; }
    .ch-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .compile-btn-sm { font-size: 12px; color: var(--neon); border: 1px solid var(--border); padding: 6px 12px; border-radius: 8px; font-family: 'Orbitron'; cursor: pointer; }

    #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    #strategy-log { width: 85%; max-width: 400px; background: #000; padding: 15px; color: #0f0; border: 1px solid var(--border); height: 200px; overflow-y: auto; font-size: 11px; font-family: monospace; }
  </style>
</head>
<body>
<div id="galaxy-bg"></div>

<div id="loading-overlay">
  <div style="color:var(--neon); font-family:Orbitron; margin-bottom:10px;" id="loader-status">SYSTEM WORKING...</div>
  <div id="strategy-log"></div>
  <button class="btn-fire" id="copy-cmd-btn" style="width:200px; margin-top:10px; display:none;" onclick="copyAiCommand()">ğŸ“‹ ëª…ë ¹ ë³µì‚¬</button>
  <button class="btn-fire" style="width:200px; margin-top:10px; background:#444; color:#fff;" onclick="document.getElementById('loading-overlay').style.display='none'">ë‹«ê¸°</button>
</div>

<div id="main-view">
  <div class="nav-header">
    <div class="home-icon" onclick="goHome()">ğŸ </div>
    <div class="engine-title">NANA : ULTIMATE</div>
    <div class="trash-icon" onclick="clearAll()">ğŸ—‘ï¸</div>
  </div>

  <div class="tab-bar">
    <div class="tab-btn active" id="tab-translate" onclick="switchTab('translate')">ğŸ”„ ë²ˆì—­</div>
    <div class="tab-btn" id="tab-auto" onclick="switchTab('auto')">ğŸ›°ï¸ ì—”ì§„</div>
    <div class="tab-btn" id="tab-progress" onclick="switchTab('progress')">âœï¸ ì§„í–‰</div>
    <div class="tab-btn" id="tab-done" onclick="switchTab('done')">ğŸ“š ì„œì¬</div>
  </div>

  <div id="panel-translate">
    <div class="card">
        <select class="novel-select" id="quick-novel-select"></select>
        <textarea id="mainInput" placeholder="ì›ë¬¸ ì…ë ¥..." style="height:200px;"></textarea>
        <button class="btn-fire" onclick="alert('ì¤€ë¹„ì¤‘')">ğŸ”¥ ë²ˆì—­ ì‹œì‘</button>
    </div>
  </div>

  <div id="panel-auto" style="display:none;">
    <div class="card">
      <input class="modal-input" id="auto-base-url" placeholder="ì£¼ì†Œ íŒ¨í„´">
      <div style="display:flex; gap:10px;">
        <input type="number" class="modal-input" id="page-start" placeholder="ì‹œì‘">
        <input type="number" class="modal-input" id="page-end" placeholder="ì¢…ë£Œ">
      </div>
      <select class="novel-select" id="auto-novel-select"></select>
      <button class="btn-fire" onclick="startAutoEngine()">ğŸš€ ì—”ì§„ ì í™”</button>
    </div>
  </div>

  <div id="panel-progress" style="display:none;"><div id="novel-list-progress"></div></div>
  <div id="panel-done" style="display:none;"><div id="novel-list-done"></div></div>
</div>

<div id="chapter-view">
  <div class="ch-header">
    <div style="display:flex; align-items:center; gap:10px;">
        <div class="home-icon" onclick="closeChapterView()">â†</div>
        <div id="ch-novel-title" class="engine-title" style="font-size:13px;"></div>
    </div>
    <div class="compile-btn-sm" id="compile-btn-ui" onclick="compileToDone()">ğŸ“• í•©ë³¸ ì œì‘</div>
  </div>
  <div id="chapter-list"></div>
</div>

<script>
  const SUPABASE_URL = 'https://hbfvyhlrnccccerzbami.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiZnZ5aGxybmNjY2NlcnpiYW1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODc2NzIsImV4cCI6MjA4NzE2MzY3Mn0.V9LJZAzCGinYmwzvWGLbfLhAFRnz4pDG_rVaTwTg74A';
  const sbH = () => ({ 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY });

  let currentNovel = null;
  let lastPacket = null;

  function goHome() { location.href = 'index.html'; }
  function clearAll() { if(confirm("ì´ˆê¸°í™”?")) document.querySelectorAll('input,textarea').forEach(i=>i.value=''); }

  function switchTab(tab) {
    ['translate', 'auto', 'progress', 'done'].forEach(t => {
      document.getElementById('tab-'+t).classList.toggle('active', t===tab);
      document.getElementById('panel-'+t).style.display = t===tab ? 'block' : 'none';
    });
    if(tab==='progress' || tab==='done') loadNovels(tab);
    updateSelectors();
  }

  async function updateSelectors() {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novels?status=eq.progress`, { headers: sbH() });
    const data = await res.json();
    const opts = '<option value="">ì†Œì„¤ ì„ íƒ...</option>' + data.map(n=>`<option value="${n.id}">${n.title}</option>`).join('');
    document.getElementById('quick-novel-select').innerHTML = opts;
    document.getElementById('auto-novel-select').innerHTML = opts;
  }

  async function loadNovels(status) {
    const list = document.getElementById('novel-list-'+status);
    list.innerHTML = 'ë¡œë”© ì¤‘...';
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novels?status=eq.${status}&order=created_at.desc`, { headers: sbH() });
    const data = await res.json();
    list.innerHTML = data.map(n => `
      <div class="novel-card">
        <div class="novel-info" onclick="openChapterView('${n.id}', '${n.title}', '${n.author}')">
          <div class="novel-title-text">${n.cover_emoji || 'ğŸ“–'} ${n.title}</div>
          <div style="font-size:11px; color:#888;">${n.author || 'ì‘ê°€ë¯¸ìƒ'}</div>
        </div>
        <div class="novel-btns">
          <div class="n-icon-btn" onclick="toggleStatus('${n.id}', '${n.status}')">${n.status==='done'?'âœï¸':'ğŸ“š'}</div>
          <div class="n-icon-btn" onclick="deleteNovel('${n.id}')" style="color:#ff4444;">ğŸ—‘ï¸</div>
        </div>
      </div>
    `).join('');
  }

  async function toggleStatus(id, cur) {
    await fetch(`${SUPABASE_URL}/rest/v1/novels?id=eq.${id}`, { method:'PATCH', headers:sbH(), body:JSON.stringify({status:cur==='done'?'progress':'done'}) });
    loadNovels(cur);
  }

  async function deleteNovel(id) {
    if(confirm("ì‚­ì œ?")) {
      await fetch(`${SUPABASE_URL}/rest/v1/novels?id=eq.${id}`, { method:'DELETE', headers:sbH() });
      loadNovels('progress'); loadNovels('done');
    }
  }

  async function openChapterView(id, title, author) {
    currentNovel = { id, title, author };
    document.getElementById('ch-novel-title').textContent = title;
    document.getElementById('chapter-view').style.display = 'block';
    // í•©ë³¸ ë²„íŠ¼ì€ 'ì§„í–‰ ì¤‘'ì¼ ë•Œë§Œ ë³´ì´ê²Œ í•˜ê±°ë‚˜ í•­ìƒ ë‘ê±°ë‚˜ ì„ íƒ (ì—¬ê¸°ì„  í•­ìƒ ë…¸ì¶œ)
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novel_chapters?novel_id=eq.${id}&order=chapter_num.asc`, { headers: sbH() });
    const data = await res.json();
    document.getElementById('chapter-list').innerHTML = data.map(c=>`
      <div style="padding:15px; border-bottom:1px solid #222;">
        <div style="color:var(--neon); font-size:12px; font-family:Orbitron;">CH ${c.chapter_num}</div>
        <div style="font-size:13px; color:#ccc; margin-top:5px;">${(c.translated || '').substring(0,80)}...</div>
      </div>
    `).join('');
  }

  function closeChapterView() { document.getElementById('chapter-view').style.display = 'none'; }

  // ğŸ“• [í•µì‹¬] í•©ë³¸ ì œì‘ ê¸°ëŠ¥ ë˜ì‚´ë¦¬ê¸°
  async function compileToDone() {
    if(!currentNovel) return;
    if(!confirm("ëª¨ë“  ì±•í„°ë¥¼ í•©ì³ì„œ ì„œì¬ë¡œ ë³´ë‚¼ê¹Œìš”?")) return;
    
    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('strategy-log').innerHTML = `> [ì‹œìŠ¤í…œ] í•©ë³¸ í”„ë¡œì„¸ìŠ¤ ì‹œì‘: ${currentNovel.title}\n`;

    try {
      // 1. ëª¨ë“  ì±•í„° ê°€ì ¸ì˜¤ê¸°
      const res = await fetch(`${SUPABASE_URL}/rest/v1/novel_chapters?novel_id=eq.${currentNovel.id}&order=chapter_num.asc`, { headers: sbH() });
      const chapters = await res.json();
      
      if(chapters.length === 0) throw new Error("í•©ì¹  ì±•í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

      // 2. í…ìŠ¤íŠ¸ ë³‘í•© (ê°€ë…ì„± ìˆê²Œ í¸ì§‘)
      let compiledBody = `[ ${currentNovel.title} - í•©ë³¸ ]\nì‘ê°€: ${currentNovel.author || 'ë¯¸ìƒ'}\n\n`;
      chapters.forEach(c => {
        compiledBody += `\n------------------------------\n   ç¬¬ ${c.chapter_num} ç« \n------------------------------\n\n${c.translated}\n\n`;
      });

      // 3. ì„œì¬ì— ìƒˆ ì†Œì„¤ ìƒì„± (ğŸ“• ì•„ì´ì½˜)
      const novelRes = await fetch(`${SUPABASE_URL}/rest/v1/novels`, {
        method:'POST', headers: Object.assign({}, sbH(), { 'Prefer': 'return=representation' }),
        body: JSON.stringify({ 
            title: currentNovel.title + " (í•©ë³¸)", 
            author: currentNovel.author, 
            cover_emoji: 'ğŸ“•', 
            status: 'done' 
        })
      });
      const newNovel = await novelRes.json();
      const newId = newNovel[0].id;

      // 4. í•©ì³ì§„ ë‚´ìš©ì„ ë‹¨ì¼ ì±•í„°ë¡œ ì €ì¥
      await fetch(`${SUPABASE_URL}/rest/v1/novel_chapters`, {
        method:'POST', headers: sbH(),
        body: JSON.stringify({ novel_id: newId, chapter_num: 1, translated: compiledBody })
      });

      document.getElementById('strategy-log').innerHTML += `> [ì„±ê³µ] ğŸ“• í•©ë³¸ì´ ì„œì¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n`;
      setTimeout(() => {
        document.getElementById('loading-overlay').style.display = 'none';
        closeChapterView();
        switchTab('done');
      }, 1500);

    } catch(e) {
      alert("í•©ë³¸ ì‹¤íŒ¨: " + e.message);
      document.getElementById('loading-overlay').style.display = 'none';
    }
  }

  function startAutoEngine() {
    const url = document.getElementById('auto-base-url').value;
    const nid = document.getElementById('auto-novel-select').value;
    if(!url || !nid) return alert("ì…ë ¥ í™•ì¸!");
    lastPacket = `í¬ë¹„ë‹¤. ìˆ˜ì§‘ ì‹œì‘.\n[ID] ${nid}\n[URL] ${url}\nDB ì§ì†¡í•´ë¼.`;
    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('strategy-log').innerHTML = `> íŒ¨í‚· ìƒì„± ì™„ë£Œ\n> ëª…ë ¹ ë³µì‚¬ ëŒ€ê¸° ì¤‘...`;
    document.getElementById('copy-cmd-btn').style.display = 'block';
  }

  function copyAiCommand() {
    navigator.clipboard.writeText(lastPacket).then(()=>alert("ë³µì‚¬ì™„ë£Œ!"));
  }

  window.onload = updateSelectors;
</script>
</body>
</html>
