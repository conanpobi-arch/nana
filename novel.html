<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>NANA LAB - ì†Œì„¤ ë²ˆì—­ê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root { --neon: #00ffcc; --border: rgba(0,255,204,0.2); }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html { background: #000; }
    body { min-height: 100vh; background: #000; color: #fff; font-family: 'Noto Sans KR', sans-serif; }
    #galaxy-bg { position: fixed; inset: 0; z-index: 0; background: radial-gradient(circle at center, #001220 0%, #000 100%); pointer-events: none; }
    .home-btn { position: fixed; top: 20px; left: 20px; text-decoration: none; font-size: 24px; color: var(--neon); z-index: 100; transition: 0.3s; }
    .home-btn:hover { transform: scale(1.1); text-shadow: 0 0 15px var(--neon); }

    .container { position: relative; z-index: 2; max-width: 700px; margin: 0 auto; padding: 70px 20px 40px; }

    .header { text-align: center; margin-bottom: 22px; }
    .page-title { font-family: 'Orbitron'; color: var(--neon); text-shadow: 0 0 15px var(--neon); font-size: 1.6rem; letter-spacing: 6px; }
    .page-sub { font-size: 11px; color: rgba(0,255,204,0.5); margin-top: 8px; letter-spacing: 2px; font-family: 'Orbitron'; }

    /* íƒ­ */
    .tab-bar { display: flex; gap: 8px; margin-bottom: 18px; }
    .tab-btn { flex: 1; padding: 10px; background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 12px; color: #aaa; font-family: 'Orbitron'; font-size: 11px; letter-spacing: 1px; cursor: pointer; transition: 0.2s; text-align: center; user-select: none; }
    .tab-btn.active { background: rgba(0,255,204,0.15); border-color: var(--neon); color: var(--neon); }

    /* ì†Œì„¤ ì¹´ë“œ */
    .novel-card { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 16px; padding: 18px; margin-bottom: 12px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 16px; }
    .novel-card:hover { border-color: var(--neon); background: rgba(0,255,204,0.08); }
    .novel-emoji { font-size: 36px; flex-shrink: 0; }
    .novel-info { flex: 1; }
    .novel-title { font-size: 16px; color: #eee; font-weight: 700; margin-bottom: 4px; }
    .novel-author { font-size: 12px; color: #888; margin-bottom: 6px; }
    .novel-meta { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .novel-chapters { font-size: 11px; color: var(--neon); font-family: 'Orbitron'; letter-spacing: 1px; }
    .novel-date { font-size: 10px; color: rgba(255,255,255,0.25); }
    .status-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
    .status-progress { background: rgba(0,255,204,0.1); color: var(--neon); border: 1px solid var(--border); }
    .status-done { background: rgba(255,215,0,0.1); color: #ffd700; border: 1px solid rgba(255,215,0,0.3); }
    .novel-actions { display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
    .novel-icon-btn { font-size: 16px; cursor: pointer; color: rgba(255,255,255,0.2); padding: 4px; transition: 0.2s; text-align: center; }
    .novel-icon-btn:hover { color: var(--neon); }
    .novel-icon-btn.done-btn:hover { color: #ffd700; }
    .novel-icon-btn.del-btn:hover { color: #ff4444; }

    .empty-state { text-align: center; color: rgba(255,255,255,0.3); font-size: 13px; padding: 60px 0; font-family: 'Orbitron'; letter-spacing: 2px; }

    .add-fab { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, var(--neon), #00b4ff); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; box-shadow: 0 5px 20px rgba(0,255,204,0.4); z-index: 50; color: #000; font-weight: 900; transition: 0.2s; border: none; }
    .add-fab:active { transform: scale(0.93); }

    /* ì±•í„° ë·° */
    #chapter-view { display: none; position: fixed; inset: 0; z-index: 200; background: #000; overflow-y: auto; padding: 20px; }
    .chapter-header { display: flex; align-items: center; gap: 14px; margin-bottom: 24px; padding-top: 10px; }
    .back-btn { font-size: 24px; cursor: pointer; color: var(--neon); flex-shrink: 0; }
    .chapter-novel-title { font-family: 'Orbitron'; color: var(--neon); font-size: 14px; letter-spacing: 3px; }
    .chapter-list { max-width: 700px; margin: 0 auto; }
    .chapter-card { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 10px; transition: 0.2s; }
    .chapter-card:hover { border-color: var(--neon); }
    .chapter-num { font-family: 'Orbitron'; font-size: 11px; color: var(--neon); letter-spacing: 2px; margin-bottom: 8px; }
    .chapter-preview { font-size: 13px; color: #aaa; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; cursor: pointer; }
    .chapter-actions { display: flex; gap: 8px; margin-top: 10px; }
    .ch-btn { flex: 1; padding: 7px; border-radius: 8px; font-size: 11px; cursor: pointer; border: 1px solid var(--border); background: rgba(255,255,255,0.04); color: #aaa; text-align: center; transition: 0.2s; }
    .ch-btn:hover { border-color: var(--neon); color: var(--neon); }
    .ch-btn.del:hover { border-color: #ff4444; color: #ff4444; }

    .add-chapter-btn { width: 100%; padding: 14px; border-radius: 14px; background: rgba(0,255,204,0.08); border: 1px dashed var(--border); color: var(--neon); font-size: 14px; cursor: pointer; text-align: center; transition: 0.2s; margin-bottom: 40px; font-family: 'Orbitron'; letter-spacing: 2px; }
    .add-chapter-btn:hover { background: rgba(0,255,204,0.15); border-color: var(--neon); }

    /* ë²ˆì—­ ì—ë””í„° ë·° */
    #editor-view { display: none; position: fixed; inset: 0; z-index: 300; background: #000; overflow-y: auto; padding: 20px; }
    .editor-wrap { max-width: 700px; margin: 0 auto; padding-bottom: 40px; }
    .editor-header { display: flex; align-items: center; gap: 14px; margin-bottom: 20px; padding-top: 10px; }
    .editor-title { font-family: 'Orbitron'; color: var(--neon); font-size: 13px; letter-spacing: 2px; }
    .editor-label { font-size: 11px; color: rgba(0,255,204,0.7); font-family: 'Orbitron'; letter-spacing: 2px; margin-bottom: 8px; }
    .editor-textarea { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 14px; color: #fff; padding: 16px; font-size: 14px; outline: none; resize: none; font-family: 'Noto Sans KR'; line-height: 1.8; transition: border-color 0.3s; min-height: 200px; margin-bottom: 16px; }
    .editor-textarea:focus { border-color: var(--neon); }
    .editor-textarea::placeholder { color: rgba(255,255,255,0.2); }
    .translate-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 14px; font-weight: 900; font-family: 'Orbitron'; cursor: pointer; font-size: 13px; letter-spacing: 2px; margin-bottom: 16px; }
    .result-box { background: rgba(0,15,35,0.7); border: 1px solid var(--border); border-radius: 14px; padding: 20px; font-size: 15px; line-height: 1.9; color: #ececec; white-space: pre-wrap; word-break: keep-all; min-height: 100px; margin-bottom: 16px; display: none; }
    .save-chapter-btn { width: 100%; padding: 14px; background: rgba(0,255,204,0.1); border: 1px solid var(--neon); color: var(--neon); border-radius: 14px; font-weight: 900; font-family: 'Orbitron'; cursor: pointer; font-size: 13px; letter-spacing: 2px; display: none; }

    /* ì±•í„° ì „ì²´ ë³´ê¸° */
    #chapter-detail { display: none; position: fixed; inset: 0; z-index: 400; background: #050a14; overflow-y: auto; padding: 30px 20px 60px; }
    .chapter-detail-wrap { max-width: 700px; margin: 0 auto; }
    .chapter-detail-num { font-family: 'Orbitron'; color: var(--neon); font-size: 12px; letter-spacing: 3px; margin-bottom: 16px; }
    .chapter-detail-text { font-size: 16px; line-height: 2.1; color: #ececec; white-space: pre-wrap; word-break: keep-all; }
    .chapter-detail-close { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 14px 40px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 14px; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; font-size: 13px; }

    /* ëª¨ë‹¬ */
    .modal-overlay { display: none; position: fixed; inset: 0; z-index: 8000; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); align-items: flex-end; justify-content: center; }
    .modal-sheet { width: 100%; max-width: 700px; background: rgba(0,15,35,0.98); border: 1px solid var(--border); border-radius: 24px 24px 0 0; padding: 28px 24px 50px; }
    .modal-title { font-family: 'Orbitron'; color: var(--neon); font-size: 13px; letter-spacing: 3px; margin-bottom: 20px; text-align: center; }
    .modal-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 13px 15px; font-size: 14px; outline: none; font-family: 'Noto Sans KR'; margin-bottom: 12px; transition: border-color 0.3s; }
    .modal-input:focus { border-color: var(--neon); }
    .modal-input::placeholder { color: rgba(255,255,255,0.25); }
    .emoji-select { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .emoji-btn { width: 44px; height: 44px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.04); font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .emoji-btn.active { border-color: var(--neon); background: rgba(0,255,204,0.15); }
    .modal-btns { display: flex; gap: 10px; }
    .modal-cancel { flex: 1; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: transparent; color: #aaa; font-size: 13px; cursor: pointer; font-family: 'Orbitron'; }
    .modal-save { flex: 2; padding: 14px; border-radius: 12px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; font-weight: 900; font-size: 13px; cursor: pointer; font-family: 'Orbitron'; }

    #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; gap: 16px; }
    .loader { width: 46px; height: 46px; border: 3px solid rgba(0,255,204,0.1); border-top: 3px solid var(--neon); border-radius: 50%; animation: spin 1s infinite linear; }
    .load-text { color: var(--neon); font-family: 'Orbitron'; font-size: 13px; letter-spacing: 2px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div id="galaxy-bg"></div>
<a href="index.html" class="home-btn">ğŸ </a>
<div id="loading-overlay"><div class="loader"></div><div class="load-text">TRANSLATING...</div></div>

<!-- ë©”ì¸ -->
<div class="container" id="main-view">
  <div class="header">
    <div class="page-title">NOVEL</div>
    <div class="page-sub">TRANSLATION LIBRARY</div>
  </div>
  <div class="tab-bar">
    <div class="tab-btn active" id="tab-progress" onclick="switchTab('progress')">âœï¸ ì§„í–‰ ì¤‘</div>
    <div class="tab-btn" id="tab-done" onclick="switchTab('done')">ğŸ“š ì„œì¬</div>
  </div>
  <div id="novel-list"><div class="empty-state">LOADING...</div></div>
</div>

<button class="add-fab" id="add-fab" onclick="openNovelModal()">+</button>

<!-- ì±•í„° ëª©ë¡ ë·° -->
<div id="chapter-view">
  <div style="max-width:700px;margin:0 auto;">
    <div class="chapter-header">
      <div class="back-btn" onclick="closeChapterView()">â†</div>
      <div>
        <div class="chapter-novel-title" id="chapter-novel-title"></div>
        <div style="font-size:11px;color:#888;margin-top:2px;" id="chapter-novel-author"></div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;">
        <div onclick="moveToLibrary()" style="font-size:12px;color:#ffd700;cursor:pointer;font-family:'Orbitron';border:1px solid rgba(255,215,0,0.3);padding:6px 10px;border-radius:8px;">ğŸ“š ì„œì¬</div>
      </div>
    </div>
    <div class="chapter-list" id="chapter-list"></div>
    <div class="add-chapter-btn" onclick="openEditor(null)">+ ìƒˆ ì±•í„° ë²ˆì—­í•˜ê¸°</div>
  </div>
</div>

<!-- ë²ˆì—­ ì—ë””í„° ë·° -->
<div id="editor-view">
  <div class="editor-wrap">
    <div class="editor-header">
      <div class="back-btn" onclick="closeEditor()">â†</div>
      <div class="editor-title" id="editor-title"></div>
    </div>
    <div class="editor-label">ğŸ“ ì›ë¬¸ ì…ë ¥</div>
    <textarea class="editor-textarea" id="original-input" placeholder="ë²ˆì—­í•  ì›ë¬¸ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
    <button class="translate-btn" onclick="doTranslate()">ğŸ”„ AI ë²ˆì—­ ì‹œì‘</button>
    <div class="editor-label" id="result-label" style="display:none;">âœ… ë²ˆì—­ ê²°ê³¼</div>
    <div class="result-box" id="result-box"></div>
    <button class="save-chapter-btn" id="save-chapter-btn" onclick="saveChapter()">ğŸ’¾ ì´ ì±•í„° ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<!-- ì±•í„° ì „ì²´ ë³´ê¸° -->
<div id="chapter-detail">
  <div class="chapter-detail-wrap">
    <div class="chapter-detail-num" id="detail-num"></div>
    <div class="chapter-detail-text" id="detail-text"></div>
  </div>
  <button class="chapter-detail-close" onclick="document.getElementById('chapter-detail').style.display='none'">âœ• ë‹«ê¸°</button>
</div>

<!-- ìƒˆ ì†Œì„¤ ëª¨ë‹¬ -->
<div id="novel-modal" class="modal-overlay" onclick="closeNovelModal()">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“– ìƒˆ ì†Œì„¤ í”„ë¡œì íŠ¸</div>
    <input class="modal-input" id="novel-title-input" placeholder="ì†Œì„¤ ì œëª©">
    <input class="modal-input" id="novel-author-input" placeholder="ì‘ê°€ (ì„ íƒì‚¬í•­)">
    <div style="font-size:11px;color:rgba(0,255,204,0.7);font-family:'Orbitron';letter-spacing:2px;margin-bottom:10px;">í‘œì§€ ì´ëª¨ì§€ ì„ íƒ</div>
    <div class="emoji-select" id="emoji-select">
      <div class="emoji-btn active" data-emoji="ğŸ“–">ğŸ“–</div>
      <div class="emoji-btn" data-emoji="ğŸ“š">ğŸ“š</div>
      <div class="emoji-btn" data-emoji="ğŸ”®">ğŸ”®</div>
      <div class="emoji-btn" data-emoji="âš”ï¸">âš”ï¸</div>
      <div class="emoji-btn" data-emoji="ğŸŒ™">ğŸŒ™</div>
      <div class="emoji-btn" data-emoji="ğŸ‰">ğŸ‰</div>
      <div class="emoji-btn" data-emoji="ğŸ•µï¸">ğŸ•µï¸</div>
      <div class="emoji-btn" data-emoji="ğŸ’€">ğŸ’€</div>
      <div class="emoji-btn" data-emoji="ğŸŒ¹">ğŸŒ¹</div>
      <div class="emoji-btn" data-emoji="ğŸš€">ğŸš€</div>
    </div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeNovelModal()">ì·¨ì†Œ</button>
      <button class="modal-save" onclick="saveNovel()">ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://hbfvyhlrnccccerzbami.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiZnZ5aGxybmNjY2NlcnpiYW1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODc2NzIsImV4cCI6MjA4NzE2MzY3Mn0.V9LJZAzCGinYmwzvWGLbfLhAFRnz4pDG_rVaTwTg74A';

  let currentTab = 'progress';
  let currentNovel = null;
  let currentChapters = [];
  let selectedEmoji = 'ğŸ“–';
  let editingChapterId = null;
  let translatedText = '';

  function sbH() {
    return { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY };
  }

  // â”€â”€ íƒ­ ì „í™˜ â”€â”€
  function switchTab(tab) {
    currentTab = tab;
    document.getElementById('tab-progress').classList.toggle('active', tab === 'progress');
    document.getElementById('tab-done').classList.toggle('active', tab === 'done');
    loadNovels();
  }

  // â”€â”€ ì†Œì„¤ ëª©ë¡ ë¡œë“œ â”€â”€
  async function loadNovels() {
    var listEl = document.getElementById('novel-list');
    listEl.innerHTML = '<div class="empty-state">LOADING...</div>';
    try {
      var res = await fetch(SUPABASE_URL + '/rest/v1/novels?order=created_at.desc', { headers: sbH() });
      var novels = await res.json();
      var filtered = novels.filter(function(n) { return n.status === currentTab; });
      if (!filtered.length) {
        listEl.innerHTML = '<div class="empty-state">' + (currentTab === 'progress' ? 'ì§„í–‰ ì¤‘ì¸ ì†Œì„¤ì´ ì—†ì–´ìš”' : 'ì„œì¬ê°€ ë¹„ì–´ìˆì–´ìš”') + '</div>';
        return;
      }
      listEl.innerHTML = '';
      filtered.forEach(function(novel) { listEl.appendChild(makeNovelCard(novel)); });
    } catch(e) {
      listEl.innerHTML = '<div class="empty-state">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    }
  }

  function makeNovelCard(novel) {
    var card = document.createElement('div');
    card.className = 'novel-card';
    var date = new Date(novel.created_at).toLocaleDateString('ko-KR');
    card.innerHTML =
      '<div class="novel-emoji">' + (novel.cover_emoji || 'ğŸ“–') + '</div>' +
      '<div class="novel-info">' +
        '<div class="novel-title">' + novel.title.replace(/</g,'&lt;') + '</div>' +
        (novel.author ? '<div class="novel-author">' + novel.author.replace(/</g,'&lt;') + '</div>' : '') +
        '<div class="novel-meta">' +
          '<span class="novel-chapters" id="chap-count-' + novel.id + '">... ì±•í„°</span>' +
          '<span class="novel-date">' + date + '</span>' +
          '<span class="status-badge ' + (novel.status === 'done' ? 'status-done' : 'status-progress') + '">' + (novel.status === 'done' ? 'âœ… ì™„ë£Œ' : 'âœï¸ ì§„í–‰ì¤‘') + '</span>' +
        '</div>' +
      '</div>' +
      '<div class="novel-actions">' +
        '<div class="novel-icon-btn done-btn" title="' + (novel.status === 'done' ? 'ì§„í–‰ì¤‘ìœ¼ë¡œ' : 'ì„œì¬ë¡œ') + '">ğŸ“š</div>' +
        '<div class="novel-icon-btn del-btn">ğŸ—‘ï¸</div>' +
      '</div>';

    // ì±•í„° ìˆ˜ ë¡œë“œ
    fetchChapterCount(novel.id);

    card.querySelector('.novel-info').addEventListener('click', function() { openChapterView(novel); });
    card.querySelector('.novel-emoji').addEventListener('click', function() { openChapterView(novel); });
    card.querySelector('.done-btn').addEventListener('click', function(e) { e.stopPropagation(); toggleStatus(novel); });
    card.querySelector('.del-btn').addEventListener('click', function(e) { e.stopPropagation(); deleteNovel(novel.id); });
    return card;
  }

  async function fetchChapterCount(novelId) {
    try {
      var res = await fetch(SUPABASE_URL + '/rest/v1/novel_chapters?novel_id=eq.' + novelId + '&select=id', { headers: sbH() });
      var data = await res.json();
      var el = document.getElementById('chap-count-' + novelId);
      if (el) el.textContent = data.length + ' ì±•í„°';
    } catch(e) {}
  }

  // â”€â”€ ìƒíƒœ ë³€ê²½ â”€â”€
  async function toggleStatus(novel) {
    var newStatus = novel.status === 'done' ? 'progress' : 'done';
    var msg = newStatus === 'done' ? 'ì„œì¬ë¡œ ì´ë™í• ê¹Œìš”?' : 'ì§„í–‰ ì¤‘ìœ¼ë¡œ ë˜ëŒë¦´ê¹Œìš”?';
    if (!confirm(msg)) return;
    try {
      await fetch(SUPABASE_URL + '/rest/v1/novels?id=eq.' + novel.id, {
        method: 'PATCH', headers: sbH(), body: JSON.stringify({ status: newStatus })
      });
      loadNovels();
    } catch(e) {}
  }

  // â”€â”€ ì‚­ì œ â”€â”€
  async function deleteNovel(id) {
    if (!confirm('ì†Œì„¤ê³¼ ëª¨ë“  ì±•í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      await fetch(SUPABASE_URL + '/rest/v1/novels?id=eq.' + id, { method: 'DELETE', headers: sbH() });
      loadNovels();
    } catch(e) {}
  }

  // â”€â”€ ìƒˆ ì†Œì„¤ ëª¨ë‹¬ â”€â”€
  function openNovelModal() {
    document.getElementById('novel-title-input').value = '';
    document.getElementById('novel-author-input').value = '';
    selectedEmoji = 'ğŸ“–';
    document.querySelectorAll('.emoji-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.emoji === 'ğŸ“–'); });
    document.getElementById('novel-modal').style.display = 'flex';
    setTimeout(function() { document.getElementById('novel-title-input').focus(); }, 200);
  }
  function closeNovelModal() { document.getElementById('novel-modal').style.display = 'none'; }

  document.querySelectorAll('.emoji-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.emoji-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      selectedEmoji = btn.dataset.emoji;
    });
  });

  async function saveNovel() {
    var title = document.getElementById('novel-title-input').value.trim();
    if (!title) { alert('ì†Œì„¤ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
    var author = document.getElementById('novel-author-input').value.trim() || null;
    try {
      var res = await fetch(SUPABASE_URL + '/rest/v1/novels', {
        method: 'POST',
        headers: Object.assign({}, sbH(), { 'Prefer': 'return=representation' }),
        body: JSON.stringify({ title: title, author: author, cover_emoji: selectedEmoji, status: 'progress' })
      });
      var data = await res.json();
      closeNovelModal();
      loadNovels();
      if (data && data[0]) openChapterView(data[0]);
    } catch(e) { alert('ì €ì¥ ì‹¤íŒ¨'); }
  }

  // â”€â”€ ì±•í„° ëª©ë¡ ë·° â”€â”€
  function openChapterView(novel) {
    currentNovel = novel;
    document.getElementById('chapter-novel-title').textContent = novel.title;
    document.getElementById('chapter-novel-author').textContent = novel.author || '';
    document.getElementById('chapter-view').style.display = 'block';
    document.getElementById('main-view').style.display = 'none';
    document.getElementById('add-fab').style.display = 'none';
    loadChapters();
  }

  function closeChapterView() {
    document.getElementById('chapter-view').style.display = 'none';
    document.getElementById('main-view').style.display = 'block';
    document.getElementById('add-fab').style.display = 'flex';
    currentNovel = null;
  }

  async function loadChapters() {
    var listEl = document.getElementById('chapter-list');
    listEl.innerHTML = '<div class="empty-state" style="padding:30px 0">LOADING...</div>';
    try {
      var res = await fetch(SUPABASE_URL + '/rest/v1/novel_chapters?novel_id=eq.' + currentNovel.id + '&order=chapter_num.asc', { headers: sbH() });
      currentChapters = await res.json();
      if (!currentChapters.length) {
        listEl.innerHTML = '<div class="empty-state" style="padding:30px 0">ì•„ì§ ë²ˆì—­í•œ ì±•í„°ê°€ ì—†ì–´ìš”</div>';
        return;
      }
      listEl.innerHTML = '';
      currentChapters.forEach(function(ch) { listEl.appendChild(makeChapterCard(ch)); });
    } catch(e) {}
  }

  function makeChapterCard(ch) {
    var card = document.createElement('div');
    card.className = 'chapter-card';
    card.innerHTML =
      '<div class="chapter-num">CHAPTER ' + ch.chapter_num + '</div>' +
      '<div class="chapter-preview">' + (ch.translated || ch.original || '').replace(/</g,'&lt;') + '</div>' +
      '<div class="chapter-actions">' +
        '<div class="ch-btn view">ğŸ“– ë³´ê¸°</div>' +
        '<div class="ch-btn edit">âœï¸ ìˆ˜ì •</div>' +
        '<div class="ch-btn del">ğŸ—‘ï¸ ì‚­ì œ</div>' +
      '</div>';

    card.querySelector('.view').addEventListener('click', function() { showChapterDetail(ch); });
    card.querySelector('.chapter-preview').addEventListener('click', function() { showChapterDetail(ch); });
    card.querySelector('.edit').addEventListener('click', function() { openEditor(ch); });
    card.querySelector('.del').addEventListener('click', function() { deleteChapter(ch.id); });
    return card;
  }

  function showChapterDetail(ch) {
    document.getElementById('detail-num').textContent = 'CHAPTER ' + ch.chapter_num;
    document.getElementById('detail-text').textContent = ch.translated || ch.original || '';
    document.getElementById('chapter-detail').style.display = 'block';
  }

  async function deleteChapter(id) {
    if (!confirm('ì´ ì±•í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      await fetch(SUPABASE_URL + '/rest/v1/novel_chapters?id=eq.' + id, { method: 'DELETE', headers: sbH() });
      loadChapters();
    } catch(e) {}
  }

  async function moveToLibrary() {
    if (!confirm('ì„œì¬ë¡œ ì´ë™í• ê¹Œìš”?')) return;
    try {
      await fetch(SUPABASE_URL + '/rest/v1/novels?id=eq.' + currentNovel.id, {
        method: 'PATCH', headers: sbH(), body: JSON.stringify({ status: 'done' })
      });
      closeChapterView();
      loadNovels();
    } catch(e) {}
  }

  // â”€â”€ ë²ˆì—­ ì—ë””í„° â”€â”€
  function openEditor(chapter) {
    editingChapterId = chapter ? chapter.id : null;
    translatedText = '';
    var nextNum = chapter ? chapter.chapter_num : (currentChapters.length + 1);
    document.getElementById('editor-title').textContent = currentNovel.title + ' â€” CHAPTER ' + nextNum;
    document.getElementById('original-input').value = chapter ? (chapter.original || '') : '';
    document.getElementById('result-box').style.display = 'none';
    document.getElementById('result-box').textContent = '';
    document.getElementById('result-label').style.display = 'none';
    document.getElementById('save-chapter-btn').style.display = 'none';
    document.getElementById('editor-view').style.display = 'block';
    document.getElementById('chapter-view').style.display = 'none';
    if (chapter && chapter.translated) {
      document.getElementById('result-box').textContent = chapter.translated;
      document.getElementById('result-box').style.display = 'block';
      document.getElementById('result-label').style.display = 'block';
      document.getElementById('save-chapter-btn').style.display = 'block';
      translatedText = chapter.translated;
    }
  }

  function closeEditor() {
    document.getElementById('editor-view').style.display = 'none';
    document.getElementById('chapter-view').style.display = 'block';
    loadChapters();
  }

  async function doTranslate() {
    var original = document.getElementById('original-input').value.trim();
    if (!original) { alert('ì›ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
    document.getElementById('loading-overlay').style.display = 'flex';
    try {
      var res = await fetch('/api/translate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: original })
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      var data = await res.json();
      translatedText = data.result;
      document.getElementById('result-box').textContent = translatedText;
      document.getElementById('result-box').style.display = 'block';
      document.getElementById('result-label').style.display = 'block';
      document.getElementById('save-chapter-btn').style.display = 'block';
    } catch(e) { alert('ë²ˆì—­ ì‹¤íŒ¨: ' + e.message); }
    document.getElementById('loading-overlay').style.display = 'none';
  }

  async function saveChapter() {
    var original = document.getElementById('original-input').value.trim();
    var nextNum = editingChapterId ? null : (currentChapters.length + 1);
    try {
      document.getElementById('loading-overlay').style.display = 'flex';
      if (editingChapterId) {
        await fetch(SUPABASE_URL + '/rest/v1/novel_chapters?id=eq.' + editingChapterId, {
          method: 'PATCH', headers: sbH(),
          body: JSON.stringify({ original: original, translated: translatedText })
        });
      } else {
        await fetch(SUPABASE_URL + '/rest/v1/novel_chapters', {
          method: 'POST', headers: sbH(),
          body: JSON.stringify({ novel_id: currentNovel.id, chapter_num: nextNum, original: original, translated: translatedText })
        });
      }
      document.getElementById('loading-overlay').style.display = 'none';
      alert('ì €ì¥ ì™„ë£Œ!');
      closeEditor();
    } catch(e) {
      document.getElementById('loading-overlay').style.display = 'none';
      alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
    }
  }

  loadNovels();
</script>
</body>
</html>
