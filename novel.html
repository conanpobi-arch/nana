<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>NANA NOVEL ENGINE</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@300;400;500&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root { --neon: #00ffcc; --bg: #000b1a; --border: rgba(0,255,204,0.2); }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body, html { width: 100%; height: 100%; background: #000; color: #fff; font-family: 'Noto Sans KR', sans-serif; }

    #galaxy-bg { position: fixed; inset: 0; z-index: 0; background: radial-gradient(ellipse at bottom, #0d1d31 0%, #0c0d13 100%); }
    #star-field { position: fixed; inset: 0; z-index: 1; background-image: radial-gradient(white, rgba(255,255,255,0.2) 2px, transparent 40px); background-size: 150px 150px; opacity: 0.1; }

    /* â”€â”€ ë©”ì¸ ë·° â”€â”€ */
    #main-view { position: relative; z-index: 2; max-width: 850px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding: 2vh 20px 40px; }
    .nav-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; margin-bottom: 15px; }
    .home-icon { cursor: pointer; font-size: 26px; transition: 0.3s; color: var(--neon); }
    .home-icon:hover { transform: scale(1.1); text-shadow: 0 0 15px var(--neon), 0 0 30px var(--neon); }
    .engine-title { font-family: 'Orbitron'; color: var(--neon); font-size: 15px; font-weight: bold; letter-spacing: 2px; text-shadow: 0 0 10px var(--neon); }

    /* íƒ­ */
    .tab-bar { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn { flex: 1; padding: 10px; background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 12px; color: #aaa; font-family: 'Orbitron'; font-size: 11px; letter-spacing: 1px; cursor: pointer; transition: 0.2s; text-align: center; user-select: none; }
    .tab-btn.active { background: rgba(0,255,204,0.15); border-color: var(--neon); color: var(--neon); }

    .card { background: rgba(0,15,35,0.75); border: 1px solid var(--border); border-radius: 20px; padding: 20px; backdrop-filter: blur(15px); margin-bottom: 16px; }
    textarea { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 15px; font-size: 14px; outline: none; margin-bottom: 15px; height: 220px; resize: none; transition: all 0.4s ease; line-height: 1.6; font-family: 'Noto Sans KR'; }
    textarea:focus { border-color: var(--neon); }
    .master-api { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; color: var(--neon); padding: 12px; font-size: 12px; outline: none; margin-bottom: 12px; text-align: center; font-family: 'Orbitron'; }
    .master-api:focus { border-color: var(--neon); }
    .master-api::placeholder { color: rgba(0,255,204,0.3); }

    /* ì†Œì„¤ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
    .novel-select-row { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
    .novel-select { flex: 1; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 12px 15px; font-size: 13px; outline: none; font-family: 'Noto Sans KR'; appearance: none; }
    .novel-select:focus { border-color: var(--neon); }
    .new-novel-btn { padding: 11px 14px; background: rgba(0,255,204,0.1); border: 1px solid var(--neon); border-radius: 12px; color: var(--neon); font-size: 18px; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
    .new-novel-btn:hover { background: rgba(0,255,204,0.2); }

    .btn-fire { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 15px; font-weight: 900; font-family: 'Orbitron'; cursor: pointer; font-size: 14px; box-shadow: 0 5px 15px rgba(0,255,204,0.3); letter-spacing: 1px; }

    /* â”€â”€ ì†Œì„¤ ëª©ë¡/ì„œì¬ â”€â”€ */
    .novel-card { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 14px; transition: 0.2s; }
    .novel-card:hover { border-color: var(--neon); background: rgba(0,255,204,0.08); }
    .novel-emoji { font-size: 34px; flex-shrink: 0; cursor: pointer; }
    .novel-info { flex: 1; cursor: pointer; }
    .novel-title-text { font-size: 15px; color: #eee; font-weight: 700; margin-bottom: 4px; }
    .novel-author-text { font-size: 12px; color: #888; margin-bottom: 5px; }
    .novel-meta-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .novel-chap-count { font-size: 11px; color: var(--neon); font-family: 'Orbitron'; }
    .novel-date-text { font-size: 10px; color: rgba(255,255,255,0.25); }
    .status-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
    .status-progress { background: rgba(0,255,204,0.1); color: var(--neon); border: 1px solid var(--border); }
    .status-done { background: rgba(255,215,0,0.1); color: #ffd700; border: 1px solid rgba(255,215,0,0.3); }
    .novel-btns { display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
    .n-icon-btn { font-size: 16px; cursor: pointer; color: rgba(255,255,255,0.2); padding: 4px; transition: 0.2s; }
    .n-icon-btn:hover { color: var(--neon); }
    .n-icon-btn.del:hover { color: #ff4444; }
    .empty-state { text-align: center; color: rgba(255,255,255,0.3); font-size: 13px; padding: 50px 0; font-family: 'Orbitron'; letter-spacing: 2px; }

    /* â”€â”€ ì±•í„° ëª©ë¡ ë·° â”€â”€ */
    #chapter-view { display: none; position: fixed; inset: 0; z-index: 200; background: #000b1a; overflow-y: auto; padding: 20px; }
    .ch-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; max-width: 850px; margin-left: auto; margin-right: auto; padding-top: 10px; }
    .back-btn { font-size: 26px; cursor: pointer; color: var(--neon); flex-shrink: 0; }
    .ch-novel-title { font-family: 'Orbitron'; color: var(--neon); font-size: 13px; letter-spacing: 2px; }
    .ch-list-wrap { max-width: 850px; margin: 0 auto; }
    .chapter-card { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 10px; }
    .chapter-num-label { font-family: 'Orbitron'; font-size: 11px; color: var(--neon); letter-spacing: 2px; margin-bottom: 8px; }
    .chapter-preview-text { font-size: 13px; color: #aaa; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; cursor: pointer; }
    .chapter-action-row { display: flex; gap: 8px; margin-top: 10px; }
    .ch-act-btn { flex: 1; padding: 7px; border-radius: 8px; font-size: 11px; cursor: pointer; border: 1px solid var(--border); background: rgba(255,255,255,0.04); color: #aaa; text-align: center; transition: 0.2s; }
    .ch-act-btn:hover { border-color: var(--neon); color: var(--neon); }
    .ch-act-btn.del:hover { border-color: #ff4444; color: #ff4444; }
    .library-btn-sm { font-size: 12px; color: #ffd700; cursor: pointer; font-family: 'Orbitron'; border: 1px solid rgba(255,215,0,0.3); padding: 6px 10px; border-radius: 8px; margin-left: auto; white-space: nowrap; }

    /* â”€â”€ ê²°ê³¼ ë°•ìŠ¤ â”€â”€ */
    #res-box { display: none; position: fixed; inset: 0; background: #050a14; z-index: 5000; overflow-y: auto; padding: 60px 30px 160px; font-family: 'Noto Serif KR', serif; line-height: 2.2; font-size: 18px; color: #ececec; text-align: justify; word-break: break-all; letter-spacing: -0.01em; -webkit-overflow-scrolling: touch; }
    .trans-paragraph { display: block; margin-bottom: 35px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,255,204,0.05); }

    #result-bottom-bar { display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 5001; background: rgba(0,10,25,0.98); border-top: 1px solid var(--border); backdrop-filter: blur(25px); padding: 20px 25px; align-items: center; gap: 12px; flex-wrap: wrap; }
    .copy-icon-btn { width: 56px; height: 56px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; flex-shrink: 0; }
    .save-chap-btn { flex: 1; height: 56px; background: rgba(0,255,204,0.1); border: 1px solid var(--neon); color: var(--neon); border-radius: 14px; font-family: 'Orbitron'; font-size: 12px; font-weight: 900; cursor: pointer; letter-spacing: 1px; min-width: 100px; }
    .back-main-btn { flex: 1; height: 56px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 14px; font-weight: 900; font-family: 'Orbitron'; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    /* â”€â”€ ë¡œë”© â”€â”€ */
    #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    .main-loader { width: 50px; height: 50px; border: 4px solid rgba(0,255,204,0.1); border-top: 4px solid var(--neon); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 20px; }
    #engine-status-text { color: var(--neon); font-size: 16px; margin-bottom: 15px; letter-spacing: 1px; font-weight: bold; text-shadow: 0 0 10px var(--neon); }
    #strategy-log { color: #fff; font-size: 11px; width: 340px; text-align: left; background: rgba(0,20,40,0.8); padding: 15px; border-radius: 12px; font-family: monospace; border: 1px solid var(--border); max-height: 200px; overflow-y: auto; line-height: 1.5; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
    .modal-overlay { display: none; position: fixed; inset: 0; z-index: 8000; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); align-items: center; justify-content: center; padding: 20px; }
    .modal-sheet { width: 100%; max-width: 500px; background: rgba(0,15,35,0.98); border: 1px solid var(--border); border-radius: 24px; padding: 28px 24px 32px; }
    .modal-title { font-family: 'Orbitron'; color: var(--neon); font-size: 13px; letter-spacing: 3px; margin-bottom: 20px; text-align: center; }
    .modal-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 13px 15px; font-size: 14px; outline: none; font-family: 'Noto Sans KR'; margin-bottom: 12px; transition: border-color 0.3s; }
    .modal-input:focus { border-color: var(--neon); }
    .modal-input::placeholder { color: rgba(255,255,255,0.25); }
    .emoji-select { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .emoji-btn { width: 44px; height: 44px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.04); font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .emoji-btn.active { border-color: var(--neon); background: rgba(0,255,204,0.15); }
    .modal-btns { display: flex; gap: 10px; }
    .modal-cancel { flex: 1; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: transparent; color: #aaa; font-size: 13px; cursor: pointer; font-family: 'Orbitron'; }
    .modal-save-btn { flex: 2; padding: 14px; border-radius: 12px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; font-weight: 900; font-size: 13px; cursor: pointer; font-family: 'Orbitron'; }

    /* ì±•í„° ì „ì²´ ì½ê¸° */
    #chapter-detail { display: none; position: fixed; inset: 0; z-index: 5500; background: #050a14; overflow-y: auto; padding: 60px 30px 120px; font-family: 'Noto Serif KR', serif; font-size: 18px; line-height: 2.2; color: #ececec; }
    .detail-wrap { max-width: 750px; margin: 0 auto; }
    .detail-num { font-family: 'Orbitron'; color: var(--neon); font-size: 12px; letter-spacing: 3px; margin-bottom: 24px; }
    .detail-close { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 14px 40px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 14px; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; font-size: 13px; }
  </style>
</head>
<body>
<div id="galaxy-bg"></div>
<div id="star-field"></div>

<!-- ë¡œë”© -->
<div id="loading-overlay">
  <div class="main-loader"></div>
  <div id="engine-status-text">INITIALIZING...</div>
  <div id="strategy-log"></div>
</div>

<!-- ê²°ê³¼ ë°•ìŠ¤ -->
<div id="res-box"></div>
<div id="result-bottom-bar">
  <div class="copy-icon-btn" onclick="copyResult()">ğŸ“‹</div>
  <button class="save-chap-btn" onclick="openSaveModal()">ğŸ’¾ ì €ì¥</button>
  <button class="back-main-btn" onclick="closeResult()">â† ëŒì•„ê°€ê¸°</button>
</div>

<!-- ì±•í„° ì „ì²´ ì½ê¸° -->
<div id="chapter-detail">
  <div class="detail-wrap">
    <div class="detail-num" id="detail-num"></div>
    <div id="detail-text"></div>
  </div>
  <button class="detail-close" onclick="document.getElementById('chapter-detail').style.display='none'">âœ• ë‹«ê¸°</button>
</div>

<!-- ì±•í„° ëª©ë¡ ë·° -->
<div id="chapter-view">
  <div class="ch-list-wrap">
    <div class="ch-header">
      <div class="back-btn" onclick="closeChapterView()">â†</div>
      <div>
        <div class="ch-novel-title" id="ch-novel-title"></div>
        <div style="font-size:11px;color:#888;margin-top:2px;" id="ch-novel-author"></div>
      </div>
      <div class="library-btn-sm" onclick="moveToLibrary()">ğŸ“š ì„œì¬ë¡œ</div>
    </div>
    <div id="chapter-list"></div>
  </div>
</div>

<!-- ìƒˆ ì†Œì„¤ ëª¨ë‹¬ -->
<div id="novel-modal" class="modal-overlay" onclick="closeNovelModal()">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“– ìƒˆ ì†Œì„¤ í”„ë¡œì íŠ¸</div>
    <input class="modal-input" id="novel-title-input" placeholder="ì†Œì„¤ ì œëª©">
    <input class="modal-input" id="novel-author-input" placeholder="ì‘ê°€ (ì„ íƒì‚¬í•­)">
    <div style="font-size:11px;color:rgba(0,255,204,0.7);font-family:'Orbitron';letter-spacing:2px;margin-bottom:10px;">í‘œì§€ ì´ëª¨ì§€</div>
    <div class="emoji-select" id="emoji-select">
      <div class="emoji-btn active" data-emoji="ğŸ“–">ğŸ“–</div>
      <div class="emoji-btn" data-emoji="ğŸ“š">ğŸ“š</div>
      <div class="emoji-btn" data-emoji="ğŸ”®">ğŸ”®</div>
      <div class="emoji-btn" data-emoji="âš”ï¸">âš”ï¸</div>
      <div class="emoji-btn" data-emoji="ğŸŒ™">ğŸŒ™</div>
      <div class="emoji-btn" data-emoji="ğŸ‰">ğŸ‰</div>
      <div class="emoji-btn" data-emoji="ğŸ•µï¸">ğŸ•µï¸</div>
      <div class="emoji-btn" data-emoji="ğŸ’€">ğŸ’€</div>
      <div class="emoji-btn" data-emoji="ğŸŒ¹">ğŸŒ¹</div>
      <div class="emoji-btn" data-emoji="ğŸš€">ğŸš€</div>
    </div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeNovelModal()">ì·¨ì†Œ</button>
      <button class="modal-save-btn" onclick="saveNovel()">ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- ì±•í„° ì €ì¥ ëª¨ë‹¬ -->
<div id="save-modal" class="modal-overlay" onclick="closeSaveModal()">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ’¾ ì±•í„° ì €ì¥</div>
    <select id="save-novel-select" style="width:100%;background:rgba(0,0,0,0.5);border:1px solid var(--border);border-radius:12px;color:#fff;padding:13px 15px;font-size:14px;outline:none;font-family:'Noto Sans KR';margin-bottom:12px;appearance:none;"></select>
    <div style="font-size:11px;color:rgba(0,255,204,0.5);margin-bottom:18px;text-align:center;font-family:'Orbitron';" id="save-chapter-num-label"></div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeSaveModal()">ì·¨ì†Œ</button>
      <button class="modal-save-btn" onclick="confirmSaveChapter()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ë©”ì¸ ë·° -->
<div id="main-view">
  <div class="nav-header">
    <div class="home-icon" onclick="location.href='index.html'">ğŸ </div>
    <div class="engine-title">NANA NOVEL</div>
    <div onclick="document.getElementById('mainInput').value=''" style="cursor:pointer;font-size:26px;">ğŸ—‘ï¸</div>
  </div>

  <!-- íƒ­ -->
  <div class="tab-bar">
    <div class="tab-btn active" id="tab-translate" onclick="switchTab('translate')">ğŸ”„ ë²ˆì—­</div>
    <div class="tab-btn" id="tab-progress" onclick="switchTab('progress')">âœï¸ ì§„í–‰ ì¤‘</div>
    <div class="tab-btn" id="tab-done" onclick="switchTab('done')">ğŸ“š ì„œì¬</div>
  </div>

  <!-- ë²ˆì—­ íƒ­ -->
  <div id="panel-translate">
    <div class="card">
      <input class="master-api" id="apiKeyInput" placeholder="GEMINI API KEY" type="password">
      <div class="novel-select-row">
        <select class="novel-select" id="quick-novel-select">
          <option value="">ì €ì¥í•  ì†Œì„¤ ì„ íƒ (ì„ íƒì‚¬í•­)...</option>
        </select>
        <div class="new-novel-btn" onclick="openNovelModal()" title="ìƒˆ ì†Œì„¤ ì¶”ê°€">ï¼‹</div>
      </div>
      <textarea id="mainInput" placeholder="ğŸ“Œ ì†Œì„¤ URL ë˜ëŠ” ì›ë¬¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
      <button class="btn-fire" onclick="fireEngine()">ğŸ”¥ ë²ˆì—­ ì‹œì‘</button>
    </div>
  </div>

  <!-- ì§„í–‰ ì¤‘ íƒ­ -->
  <div id="panel-progress" style="display:none;">
    <div id="novel-list-progress"><div class="empty-state">LOADING...</div></div>
  </div>

  <!-- ì„œì¬ íƒ­ -->
  <div id="panel-done" style="display:none;">
    <div id="novel-list-done"><div class="empty-state">LOADING...</div></div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://hbfvyhlrnccccerzbami.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiZnZ5aGxybmNjY2NlcnpiYW1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODc2NzIsImV4cCI6MjA4NzE2MzY3Mn0.V9LJZAzCGinYmwzvWGLbfLhAFRnz4pDG_rVaTwTg74A';

  const keyInput = document.getElementById('apiKeyInput');
  const statusText = document.getElementById('engine-status-text');

  let currentTab = 'translate';
  let currentNovel = null;
  let allNovels = [];
  let selectedEmoji = 'ğŸ“–';
  let lastTranslated = '';
  let lastOriginal = '';

  // API í‚¤ localStorage ì €ì¥
  const SAVED_KEY = localStorage.getItem('nana_gemini_key') || '';
  if (SAVED_KEY) keyInput.value = SAVED_KEY;
  keyInput.addEventListener('change', () => {
    if (keyInput.value.trim().length > 10) localStorage.setItem('nana_gemini_key', keyInput.value.trim());
  });

  function sbH() {
    return { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY };
  }

  // â”€â”€ íƒ­ ì „í™˜ â”€â”€
  function switchTab(tab) {
    currentTab = tab;
    ['translate','progress','done'].forEach(t => {
      document.getElementById('tab-' + t).classList.toggle('active', t === tab);
      document.getElementById('panel-' + t).style.display = t === tab ? 'block' : 'none';
    });
    if (tab === 'progress') loadNovels('progress');
    if (tab === 'done') loadNovels('done');
  }

  // â”€â”€ ì†Œì„¤ ë¡œë“œ â”€â”€
  async function loadNovels(status) {
    var listEl = document.getElementById('novel-list-' + status);
    listEl.innerHTML = '<div class="empty-state">LOADING...</div>';
    try {
      var res = await fetch(SUPABASE_URL + '/rest/v1/novels?order=created_at.desc', { headers: sbH() });
      allNovels = await res.json();
      var filtered = allNovels.filter(n => n.status === status);
      updateQuickSelects(allNovels.filter(n => n.status === 'progress'));
      if (!filtered.length) {
        listEl.innerHTML = '<div class="empty-state">' + (status === 'progress' ? 'ì§„í–‰ ì¤‘ì¸ ì†Œì„¤ ì—†ìŒ' : 'ì„œì¬ê°€ ë¹„ì–´ìˆì–´ìš”') + '</div>';
        return;
      }
      listEl.innerHTML = '';
      filtered.forEach(n => listEl.appendChild(makeNovelCard(n)));
    } catch(e) { listEl.innerHTML = '<div class="empty-state">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>'; }
  }

  function updateQuickSelects(novels) {
    ['quick-novel-select','save-novel-select'].forEach(id => {
      var sel = document.getElementById(id);
      var prev = sel.value;
      var firstOpt = id === 'quick-novel-select' ? '<option value="">ì €ì¥í•  ì†Œì„¤ ì„ íƒ (ì„ íƒì‚¬í•­)...</option>' : '<option value="">ì†Œì„¤ ì„ íƒ...</option>';
      sel.innerHTML = firstOpt;
      novels.forEach(n => {
        var opt = document.createElement('option');
        opt.value = n.id;
        opt.textContent = (n.cover_emoji || 'ğŸ“–') + ' ' + n.title;
        sel.appendChild(opt);
      });
      if (prev) sel.value = prev;
    });
  }

  function makeNovelCard(novel) {
    var card = document.createElement('div');
    card.className = 'novel-card';
    card.innerHTML =
      '<div class="novel-emoji">' + (novel.cover_emoji || 'ğŸ“–') + '</div>' +
      '<div class="novel-info">' +
        '<div class="novel-title-text">' + novel.title.replace(/</g,'&lt;') + '</div>' +
        (novel.author ? '<div class="novel-author-text">' + novel.author.replace(/</g,'&lt;') + '</div>' : '') +
        '<div class="novel-meta-row">' +
          '<span class="novel-chap-count" id="cc-' + novel.id + '">... ì±•í„°</span>' +
          '<span class="status-badge ' + (novel.status==='done'?'status-done':'status-progress') + '">' + (novel.status==='done'?'âœ… ì™„ë£Œ':'âœï¸ ì§„í–‰ì¤‘') + '</span>' +
        '</div>' +
      '</div>' +
      '<div class="novel-btns">' +
        '<div class="n-icon-btn lib">ğŸ“š</div>' +
        '<div class="n-icon-btn del">ğŸ—‘ï¸</div>' +
      '</div>';

    fetchChapCount(novel.id);
    card.querySelector('.novel-info').addEventListener('click', () => openChapterView(novel));
    card.querySelector('.novel-emoji').addEventListener('click', () => openChapterView(novel));
    card.querySelector('.lib').addEventListener('click', e => { e.stopPropagation(); toggleStatus(novel); });
    card.querySelector('.del').addEventListener('click', e => { e.stopPropagation(); deleteNovel(novel.id); });
    return card;
  }

  async function fetchChapCount(id) {
    try {
      var res = await fetch(SUPABASE_URL + '/rest/v1/novel_chapters?novel_id=eq.' + id + '&select=id', { headers: sbH() });
      var data = await res.json();
      var el = document.getElementById('cc-' + id);
      if (el) el.textContent = data.length + ' ì±•í„°';
    } catch(e) {}
  }

  async function toggleStatus(novel) {
    var ns = novel.status === 'done' ? 'progress' : 'done';
    if (!confirm(ns === 'done' ? 'ì„œì¬ë¡œ ì´ë™í• ê¹Œìš”?' : 'ì§„í–‰ ì¤‘ìœ¼ë¡œ ë˜ëŒë¦´ê¹Œìš”?')) return;
    await fetch(SUPABASE_URL + '/rest/v1/novels?id=eq.' + novel.id, { method:'PATCH', headers:sbH(), body:JSON.stringify({status:ns}) });
    loadNovels(currentTab);
  }

  async function deleteNovel(id) {
    if (!confirm('ì†Œì„¤ê³¼ ëª¨ë“  ì±•í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) return;
    await fetch(SUPABASE_URL + '/rest/v1/novels?id=eq.' + id, { method:'DELETE', headers:sbH() });
    loadNovels(currentTab);
  }

  // â”€â”€ ìƒˆ ì†Œì„¤ ëª¨ë‹¬ â”€â”€
  function openNovelModal() {
    selectedEmoji = 'ğŸ“–';
    document.getElementById('novel-title-input').value = '';
    document.getElementById('novel-author-input').value = '';
    document.querySelectorAll('.emoji-btn').forEach(b => b.classList.toggle('active', b.dataset.emoji === 'ğŸ“–'));
    document.getElementById('novel-modal').style.display = 'flex';
    setTimeout(() => document.getElementById('novel-title-input').focus(), 200);
  }
  function closeNovelModal() { document.getElementById('novel-modal').style.display = 'none'; }

  document.querySelectorAll('.emoji-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedEmoji = btn.dataset.emoji;
    });
  });

  async function saveNovel() {
    var title = document.getElementById('novel-title-input').value.trim();
    if (!title) { alert('ì†Œì„¤ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
    var author = document.getElementById('novel-author-input').value.trim() || null;
    var res = await fetch(SUPABASE_URL + '/rest/v1/novels', {
      method:'POST', headers:Object.assign({},sbH(),{'Prefer':'return=representation'}),
      body:JSON.stringify({title, author, cover_emoji: selectedEmoji, status:'progress'})
    });
    var data = await res.json();
    closeNovelModal();
    // ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
    var novels = allNovels.filter(n => n.status === 'progress');
    if (data && data[0]) novels.push(data[0]);
    updateQuickSelects(novels);
    if (currentTab !== 'translate') loadNovels(currentTab);
  }

  // â”€â”€ ì±•í„° ëª©ë¡ ë·° â”€â”€
  function openChapterView(novel) {
    currentNovel = novel;
    document.getElementById('ch-novel-title').textContent = novel.title;
    document.getElementById('ch-novel-author').textContent = novel.author || '';
    document.getElementById('chapter-view').style.display = 'block';
    loadChapters();
  }

  function closeChapterView() {
    document.getElementById('chapter-view').style.display = 'none';
    currentNovel = null;
  }

  async function loadChapters() {
    var listEl = document.getElementById('chapter-list');
    listEl.innerHTML = '<div class="empty-state" style="padding:30px 0">LOADING...</div>';
    var res = await fetch(SUPABASE_URL + '/rest/v1/novel_chapters?novel_id=eq.' + currentNovel.id + '&order=chapter_num.asc', { headers: sbH() });
    var chapters = await res.json();
    if (!chapters.length) { listEl.innerHTML = '<div class="empty-state" style="padding:30px 0">ì•„ì§ ì €ì¥ëœ ì±•í„°ê°€ ì—†ì–´ìš”</div>'; return; }
    listEl.innerHTML = '';
    chapters.forEach(ch => {
      var card = document.createElement('div');
      card.className = 'chapter-card';
      card.innerHTML =
        '<div class="chapter-num-label">CHAPTER ' + ch.chapter_num + '</div>' +
        '<div class="chapter-preview-text">' + (ch.translated || ch.original || '').replace(/</g,'&lt;') + '</div>' +
        '<div class="chapter-action-row">' +
          '<div class="ch-act-btn view">ğŸ“– ë³´ê¸°</div>' +
          '<div class="ch-act-btn del">ğŸ—‘ï¸ ì‚­ì œ</div>' +
        '</div>';
      card.querySelector('.view').addEventListener('click', () => showChapterDetail(ch));
      card.querySelector('.chapter-preview-text').addEventListener('click', () => showChapterDetail(ch));
      card.querySelector('.del').addEventListener('click', () => deleteChapter(ch.id));
      listEl.appendChild(card);
    });
  }

  function showChapterDetail(ch) {
    document.getElementById('detail-num').textContent = 'CHAPTER ' + ch.chapter_num;
    var wrap = document.getElementById('detail-text');
    var text = ch.translated || ch.original || '';
    wrap.innerHTML = renderParagraphs(text);
    document.getElementById('chapter-detail').style.display = 'block';
    document.getElementById('chapter-detail').scrollTop = 0;
  }

  async function deleteChapter(id) {
    if (!confirm('ì´ ì±•í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
    await fetch(SUPABASE_URL + '/rest/v1/novel_chapters?id=eq.' + id, { method:'DELETE', headers:sbH() });
    loadChapters();
  }

  async function moveToLibrary() {
    if (!confirm('ì„œì¬ë¡œ ì´ë™í• ê¹Œìš”?')) return;
    await fetch(SUPABASE_URL + '/rest/v1/novels?id=eq.' + currentNovel.id, { method:'PATCH', headers:sbH(), body:JSON.stringify({status:'done'}) });
    closeChapterView();
  }

  // â”€â”€ ë²ˆì—­ ì—”ì§„ (ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ) â”€â”€
  function setStatus(txt) { statusText.innerText = txt; }
  function logStep(msg, type) {
    var log = document.getElementById('strategy-log');
    var color = type === 'success' ? '#00ffcc' : type === 'fail' ? '#ff4444' : '#ccc';
    log.innerHTML += '<span style="color:' + color + '">' + msg + '</span>\n';
    log.scrollTop = log.scrollHeight;
  }

  function renderParagraphs(text) {
    var escaped = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return escaped.split(/\n{2,}/).map(para => {
      var clean = para.replace(/\n/g,'<br>').trim();
      return clean ? '<p class="trans-paragraph">' + clean + '</p>' : '';
    }).filter(p => p).join('');
  }

  function copyResult() {
    var rb = document.getElementById('res-box');
    var text = rb.innerText || rb.textContent;
    navigator.clipboard.writeText(text).then(() => {
      var btn = document.querySelector('.copy-icon-btn');
      btn.innerText = 'âœ…';
      setTimeout(() => { btn.innerText = 'ğŸ“‹'; }, 1500);
    });
  }

  function closeResult() {
    document.getElementById('res-box').style.display = 'none';
    document.getElementById('result-bottom-bar').style.display = 'none';
  }

  function extractTextFromDoc(doc) {
    // ë…¸ì´ì¦ˆ ì œê±°
    doc.querySelectorAll('script, style, ins, iframe, noscript, svg, header, footer, nav, aside, .ads, .ad, .banner, .menu, .comment, #comment, .sidebar').forEach(e => e.remove());

    // ixdzs.tw ì „ìš©: ë³¸ë¬¸ ì»¨í…Œì´ë„ˆ ìš°ì„  ì‹œë„
    var contentSelectors = [
      '#content', '.content', '#chaptercontent', '.chapter-content',
      '#bookcontent', '.book-content', '#articlecontent', '.article-content',
      '#novel-content', '.novel-content', '#text', '.text-content',
      'article', 'main', '.main-content', '#main'
    ];
    var bodyEl = null;
    for (var sel of contentSelectors) {
      var el = doc.querySelector(sel);
      if (el && el.innerText && el.innerText.trim().length > 200) {
        bodyEl = el;
        break;
      }
    }

    // ë³¸ë¬¸ ì»¨í…Œì´ë„ˆ ëª» ì°¾ìœ¼ë©´ body ì „ì²´ ì‚¬ìš©
    if (!bodyEl) bodyEl = doc.body;

    bodyEl.querySelectorAll('p, div, br, li, h3, h4, h5, h6, tr, blockquote').forEach(el => {
      el.insertAdjacentText('beforebegin', el.tagName === 'BR' ? '\n' : '\n\n');
      if (el.tagName !== 'BR') el.insertAdjacentText('afterend', '\n\n');
    });

    return (bodyEl.innerText || bodyEl.textContent || '')
      .replace(/\t/g,' ').replace(/\r\n/g,'\n').replace(/\r/g,'\n')
      .replace(/[ \t]{2,}/g,' ').replace(/\n{4,}/g,'\n\n\n').trim();
  }

  const CRAWL_STRATEGIES = [
    { name:'CorsProxy.io', url: u => `https://corsproxy.io/?${encodeURIComponent(u)}` },
    { name:'AllOrigins',   url: u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}` },
    { name:'CodeTabs',     url: u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}` }
  ];

  async function fireEngine() {
    const key = keyInput.value.trim();
    const input = document.getElementById('mainInput').value.trim();
    if (!key || !input) { alert('API í‚¤ì™€ ì›ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('strategy-log').innerHTML = '';
    let rawData = input;

    try {
      if (input.startsWith('http')) {
        setStatus("ë°ì´í„° ì¶”ì¶œ ì¤‘...");
        let success = false;
        for (let s of CRAWL_STRATEGIES) {
          logStep(`PROXY: ${s.name} ì—°ê²°...`);
          try {
            const res = await fetch(s.url(input));
            let text = s.name === 'AllOrigins' ? (await res.json()).contents : await res.text();
            if (text && text.length > 200) {
              const doc = new DOMParser().parseFromString(text, 'text/html');
              rawData = extractTextFromDoc(doc);
              logStep(`SUCCESS: ${s.name} â€” ${rawData.length}ì íšë“`, 'success');
              success = true;
              break;
            }
          } catch(e) { logStep(`BLOCK: ${s.name} ì‹¤íŒ¨ â€” ${e.message}`, 'fail'); }
        }
        if (!success) throw new Error("ëª¨ë“  í”„ë¡ì‹œ í¬ë¡¤ë§ ì‹¤íŒ¨");
      }

      setStatus("ì œë¯¸ë‚˜ì´ ê°ë…ê´€ ëª¨ë“œ ê°€ë™...");
      logStep("API: í¬ë¹„ë‹˜ ì§€ì¹¨ ë™ê¸°í™”...");

      const geminiRes = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: `ë‹¹ì‹ ì€ ì½”ë‚œí¬ë¹„ë‹˜ì˜ ì „ë‹´ ì†Œì„¤ ì „ë¬¸ ë²ˆì—­ê°€ì´ì ì—„ê²©í•œ ê°ë…ê´€ì…ë‹ˆë‹¤. ë‹¤ìŒ [ê°ë…ê´€ ì§€ì¹¨]ì„ ì² ì €íˆ ì¤€ìˆ˜í•˜ì‹­ì‹œì˜¤.

[ê°ë…ê´€ ì§€ì¹¨]:
1. [No Omission]: ë‹¨ í•˜ë‚˜ì˜ ë¬¸ì¥ë„ ëˆ„ë½í•˜ê±°ë‚˜ ìš”ì•½í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ì›ë¬¸ ë¬¸ì¥ ê°œìˆ˜ì™€ ë²ˆì—­ë¬¸ ê°œìˆ˜ë¥¼ ì •í™•íˆ ë§ì¶”ì‹­ì‹œì˜¤.
2. [Authentic Style]: ì œë¯¸ë‚˜ì´ íŠ¹ìœ ì˜ ìœ ë ¤í•˜ê³  í’ë¶€í•œ ë¬¸í•™ì  í‘œí˜„ë ¥ì„ ë°œíœ˜í•˜ì‹­ì‹œì˜¤.
3. [Cultural Context]: í˜„ëŒ€ì–´ë¥¼ ë‚¨ë°œí•˜ì§€ ë§ê³  ì†Œì„¤ ë‹¹ëŒ€ì˜ ë¬¸í™”ì™€ ì–¸ì–´ì  ìƒ‰ì±„ë¥¼ ì‚´ë¦¬ì‹­ì‹œì˜¤. ì¡´ëŒ“ë§ê³¼ ë°˜ë§ì€ ê°€ì¡±ê´€ê³„, ì¹œë¶„ì •ë„, ë‚¨ë…€ê´€ê³„, ê³ ëŒ€ì¤‘êµ­ì˜ ì˜ˆë²•ì— ë”°ë¼ ì¼ê´€ë˜ê²Œ ì ìš©í•˜ì‹­ì‹œì˜¤.
4. [Anti-China]: ì¤‘êµ­ ë°œìŒì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ëª¨ë“  í•œìëŠ” ëŒ€í•œë¯¼êµ­ í•œììŒ(í•œêµ­ì‹ ì½ê¸°)ìœ¼ë¡œë§Œ í‘œê¸°í•˜ì‹­ì‹œì˜¤.
5. [Crucial Structure]: ë¬¸ë‹¨ ì‚¬ì´ì—ëŠ” ë°˜ë“œì‹œ ë¹ˆ ì¤„(\\n\\n)ì„ ì‚½ì…í•˜ì—¬ ë¬¸ë‹¨ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ì‹­ì‹œì˜¤. ë‹¨ë½ êµ¬ë¶„ì„ ì ˆëŒ€ ìƒëµí•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
6. ë³¸ë¬¸ í…ìŠ¤íŠ¸ë§Œ ë²ˆì—­í•˜ì‹­ì‹œì˜¤.

ì›ë¬¸:
${rawData}`
              }]
            }],
            generationConfig: { temperature: 0.25, topP: 0.95, maxOutputTokens: 8192 }
          })
        }
      );

      if (!geminiRes.ok) throw new Error(`Gemini HTTP ${geminiRes.status}`);
      const data = await geminiRes.json();
      const translated = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!translated) throw new Error("ë²ˆì—­ ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");

      logStep("SUCCESS: ê°ë…ê´€ ê²€ìˆ˜ ì™„ë£Œ.", 'success');
      lastTranslated = translated;
      lastOriginal = rawData;

      var rb = document.getElementById('res-box');
      rb.innerHTML = renderParagraphs(translated);
      rb.style.display = 'block';
      rb.scrollTop = 0;
      document.getElementById('result-bottom-bar').style.display = 'flex';
      document.getElementById('loading-overlay').style.display = 'none';

    } catch(e) {
      setStatus("ì—”ì§„ ì¤‘ë‹¨ë¨");
      logStep(`ERROR: ${e.message}`, 'fail');
      document.getElementById('loading-overlay').style.display = 'none';
    }
  }

  // â”€â”€ ì±•í„° ì €ì¥ ëª¨ë‹¬ â”€â”€
  async function openSaveModal() {
    // DBì—ì„œ ì§ì ‘ ìµœì‹  ì†Œì„¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    try {
      var res = await fetch(SUPABASE_URL + '/rest/v1/novels?status=eq.progress&order=created_at.desc', { headers: sbH() });
      var novels = await res.json();
      var sel = document.getElementById('save-novel-select');
      sel.innerHTML = '<option value="">ì†Œì„¤ ì„ íƒ...</option>';
      novels.forEach(n => {
        var opt = document.createElement('option');
        opt.value = n.id;
        opt.textContent = (n.cover_emoji || 'ğŸ“–') + ' ' + n.title;
        sel.appendChild(opt);
      });
      // ë²ˆì—­ íƒ­ì—ì„œ ì„ íƒí•œ ì†Œì„¤ ìë™ ì„ íƒ
      var qSel = document.getElementById('quick-novel-select').value;
      if (qSel) sel.value = qSel;
    } catch(e) {}
    document.getElementById('save-modal').style.display = 'flex';
  }
  function closeSaveModal() { document.getElementById('save-modal').style.display = 'none'; }

  async function confirmSaveChapter() {
    var novelId = document.getElementById('save-novel-select').value;
    if (!novelId) { alert('ì†Œì„¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
    try {
      // ì±•í„° ë²ˆí˜¸ ê³„ì‚°
      var res = await fetch(SUPABASE_URL + '/rest/v1/novel_chapters?novel_id=eq.' + novelId + '&select=id', { headers: sbH() });
      var existing = await res.json();
      var nextNum = existing.length + 1;
      document.getElementById('save-chapter-num-label').textContent = 'CHAPTER ' + nextNum + 'ë¡œ ì €ì¥ë©ë‹ˆë‹¤';

      await fetch(SUPABASE_URL + '/rest/v1/novel_chapters', {
        method:'POST', headers:sbH(),
        body:JSON.stringify({ novel_id: parseInt(novelId), chapter_num: nextNum, original: lastOriginal, translated: lastTranslated })
      });
      closeSaveModal();
      alert('CHAPTER ' + nextNum + ' ì €ì¥ ì™„ë£Œ! âœ…');
    } catch(e) { alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
  }

  // ì´ˆê¸° ë¡œë“œ
  async function init() {
    var res = await fetch(SUPABASE_URL + '/rest/v1/novels?order=created_at.desc', { headers: sbH() });
    allNovels = await res.json();
    updateQuickSelects(allNovels.filter(n => n.status === 'progress'));
  }
  init();
</script>
</body>
</html>
