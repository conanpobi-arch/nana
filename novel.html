<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>NANA NOVEL : TOTAL ENGINE</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@300;400;500&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root { --neon: #00ffcc; --bg: #000b1a; --border: rgba(0,255,204,0.2); }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body, html { width: 100%; height: 100%; background: #000; color: #fff; font-family: 'Noto Sans KR', sans-serif; overflow-x: hidden; }
    #galaxy-bg { position: fixed; inset: 0; z-index: 0; background: radial-gradient(ellipse at bottom, #0d1d31 0%, #0c0d13 100%); }
    #main-view { position: relative; z-index: 2; max-width: 850px; margin: 0 auto; min-height: 100vh; padding: 2vh 20px 40px; }
    
    /* í—¤ë” ìŠ¤íƒ€ì¼ */
    .nav-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; margin-bottom: 15px; }
    .home-icon { cursor: pointer; font-size: 26px; color: var(--neon); text-shadow: 0 0 10px var(--neon); }
    .engine-title { font-family: 'Orbitron'; color: var(--neon); font-size: 15px; font-weight: bold; letter-spacing: 2px; }
    .trash-icon { cursor: pointer; font-size: 26px; opacity: 0.6; }

    /* íƒ­ ìŠ¤íƒ€ì¼ */
    .tab-bar { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; }
    .tab-btn { flex: 1; min-width: 80px; padding: 12px 5px; background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 12px; color: #aaa; font-family: 'Orbitron'; font-size: 10px; cursor: pointer; text-align: center; }
    .tab-btn.active { background: rgba(0,255,204,0.15); border-color: var(--neon); color: var(--neon); }
    
    /* ì¹´ë“œ ë° ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    .card { background: rgba(0,15,35,0.75); border: 1px solid var(--border); border-radius: 20px; padding: 20px; backdrop-filter: blur(15px); margin-bottom: 16px; }
    textarea, .modal-input, .novel-select { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 15px; font-size: 14px; outline: none; margin-bottom: 12px; }
    .btn-fire { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 15px; font-weight: 900; font-family: 'Orbitron'; cursor: pointer; font-size: 13px; }
    
    /* ë¦¬ìŠ¤íŠ¸ ë° ì¹´ë“œ */
    .novel-card { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 14px; }
    .novel-info { flex: 1; cursor: pointer; }
    .novel-btns { display: flex; gap: 12px; }
    .n-icon-btn { cursor: pointer; font-size: 18px; opacity: 0.7; transition: 0.2s; }
    .n-icon-btn:hover { opacity: 1; transform: scale(1.1); }

    /* ë·°ì–´ & ë¡œë”© ë ˆì´ì–´ */
    #chapter-view { display: none; position: fixed; inset: 0; z-index: 500; background: #000b1a; overflow-y: auto; padding: 20px; }
    .ch-header { position: sticky; top: 0; background: #000b1a; display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); z-index: 10; }
    .reader-content { font-family: 'Noto Serif KR', serif; line-height: 1.8; color: #ddd; font-size: 16px; white-space: pre-wrap; padding-top: 20px; }
    #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    #strategy-log { width: 85%; max-width: 400px; background: #000; padding: 15px; color: #0f0; border: 1px solid var(--border); height: 200px; overflow-y: auto; font-size: 11px; margin-bottom: 15px; }

    /* ëª¨ë‹¬ */
    #add-modal { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
  </style>
</head>
<body>
<div id="galaxy-bg"></div>

<div id="add-modal">
  <div class="card" style="width: 90%; max-width: 400px;">
    <h3 style="margin-bottom:15px; color:var(--neon); font-family:Orbitron;">NEW NOVEL</h3>
    <input class="modal-input" id="new-title" placeholder="ì†Œì„¤ ì œëª©">
    <input class="modal-input" id="new-author" placeholder="ì‘ê°€ëª…">
    <button class="btn-fire" onclick="addNewNovel()">ìƒì„±í•˜ê¸°</button>
    <button onclick="document.getElementById('add-modal').style.display='none'" style="width:100%; background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">ë‹«ê¸°</button>
  </div>
</div>

<div id="loading-overlay">
  <div style="color:var(--neon); font-family:Orbitron; margin-bottom:10px;">DIRECT AI PACKET ENGINE</div>
  <div id="strategy-log"></div>
  <button class="btn-fire" id="copy-cmd-btn" style="width:200px; margin-bottom:10px; display:none;" onclick="copyAiCommand()">ğŸ“‹ ëª…ë ¹ ë³µì‚¬</button>
  <button class="btn-fire" style="width:200px; background:#444; color:#fff;" onclick="document.getElementById('loading-overlay').style.display='none'">ì°½ ë‹«ê¸°</button>
</div>

<div id="main-view">
  <div class="nav-header">
    <div class="home-icon" onclick="goHome()">ğŸ </div>
    <div class="engine-title">NANA : TOTAL</div>
    <div class="trash-icon" onclick="clearAll()">ğŸ—‘ï¸</div>
  </div>

  <div class="tab-bar">
    <div class="tab-btn active" id="tab-translate" onclick="switchTab('translate')">ğŸ”„ ë²ˆì—­</div>
    <div class="tab-btn" id="tab-auto" onclick="switchTab('auto')">ğŸ›°ï¸ ì—”ì§„</div>
    <div class="tab-btn" id="tab-progress" onclick="switchTab('progress')">âœï¸ ì§„í–‰</div>
    <div class="tab-btn" id="tab-done" onclick="switchTab('done')">ğŸ“š ì„œì¬</div>
  </div>

  <div id="panel-translate">
    <div class="card">
        <div style="display:flex; gap:8px;">
            <select class="novel-select" id="quick-novel-select"></select>
            <button onclick="document.getElementById('add-modal').style.display='flex'" style="height:48px; width:50px; background:none; border:1px solid var(--neon); color:var(--neon); border-radius:12px; font-size:20px; cursor:pointer;">+</button>
        </div>
        <textarea id="mainInput" placeholder="ì›ë¬¸ ë˜ëŠ” URLì„ ì…ë ¥í•˜ì„¸ìš”" style="height:200px;"></textarea>
        <button class="btn-fire" onclick="startDirectTranslation()">ğŸ”¥ ë²ˆì—­ ì‹œì‘</button>
    </div>
  </div>

  <div id="panel-auto" style="display:none;">
    <div class="card">
      <input class="modal-input" id="auto-base-url" placeholder="ì£¼ì†Œ íŒ¨í„´">
      <div style="display:flex; gap:10px;">
        <input type="number" class="modal-input" id="page-start" placeholder="ì‹œì‘">
        <input type="number" class="modal-input" id="page-end" placeholder="ì¢…ë£Œ">
      </div>
      <select class="novel-select" id="auto-novel-select"></select>
      <button class="btn-fire" onclick="startAutoEngine()">ğŸš€ íŒ¨í‚· ìƒì„±</button>
    </div>
  </div>

  <div id="panel-progress" style="display:none;"><div id="novel-list-progress"></div></div>
  <div id="panel-done" style="display:none;"><div id="novel-list-done"></div></div>
</div>

<div id="chapter-view">
  <div class="ch-header">
    <div class="home-icon" onclick="closeChapterView()">â†</div>
    <div id="ch-novel-title" class="engine-title" style="font-size:13px;"></div>
    <div id="compile-area"></div>
  </div>
  <div id="reader-container">
    <div id="chapter-list"></div>
    <div id="full-reader" class="reader-content" style="display:none;"></div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://hbfvyhlrnccccerzbami.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiZnZ5aGxybmNjY2NlcnpiYW1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODc2NzIsImV4cCI6MjA4NzE2MzY3Mn0.V9LJZAzCGinYmwzvWGLbfLhAFRnz4pDG_rVaTwTg74A';
  const sbH = () => ({ 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY });

  let lastPacket = "";
  let currentNovel = null;

  function goHome() { location.href = 'index.html'; }
  function clearAll() { if(confirm("ëª¨ë“  ì…ë ¥ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) document.querySelectorAll('input, textarea').forEach(i=>i.value=''); }

  // 1. ë²ˆì—­ ì‹œì‘ (íŒ¨í‚· ìƒì„±)
  function startDirectTranslation() {
    const input = document.getElementById('mainInput').value.trim();
    const novelId = document.getElementById('quick-novel-select').value;
    if(!input || !novelId) return alert("ì›ë¬¸ì´ë‚˜ URL, ì†Œì„¤ ì„ íƒì„ í™•ì¸í•˜ì„¸ìš”!");

    const overlay = document.getElementById('loading-overlay');
    const log = document.getElementById('strategy-log');
    const copyBtn = document.getElementById('copy-cmd-btn');

    overlay.style.display = 'flex';
    log.innerHTML = `> [ì‹œìŠ¤í…œ] ë²ˆì—­ ì‹œí€€ìŠ¤ ê°œì‹œ...\n`;
    
    if(input.startsWith('http')) {
        log.innerHTML += `> [ê°ì§€] URL í™•ì¸ë¨\n> [ì‘ì—…] í¬ë¡¤ë§ íŒ¨í‚· ìƒì„± ì™„ë£Œ\n`;
        lastPacket = `í¬ë¹„ë‹¤. ì™€íƒ•ì¹´! ì•„ë˜ ì£¼ì†Œë¥¼ í¬ë¡¤ë§ ë° ë²ˆì—­í•´ë¼.\n[URL] ${input}\n[ID] ${novelId}\nê²°ê³¼ëŠ” novel_chaptersì— ì§ì†¡í•´ë¼.`;
    } else {
        log.innerHTML += `> [ê°ì§€] í…ìŠ¤íŠ¸ í™•ì¸ë¨\n> [ì‘ì—…] ë²ˆì—­ íŒ¨í‚· ìƒì„± ì™„ë£Œ\n`;
        lastPacket = `í¬ë¹„ë‹¤. ì™€íƒ•ì¹´! ì•„ë˜ ë‚´ìš©ì„ ë²ˆì—­í•´ë¼.\n[ì›ë¬¸]\n${input.substring(0,1000)}\n[ID] ${novelId}\nê²°ê³¼ëŠ” novel_chaptersì— ì§ì†¡í•´ë¼.`;
    }
    log.innerHTML += `> [ëŒ€ê¸°] ëª…ë ¹ ë³µì‚¬ í›„ AIì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”.`;
    copyBtn.style.display = 'block';
  }

  function copyAiCommand() {
    navigator.clipboard.writeText(lastPacket).then(() => alert("ëª…ë ¹ íŒ¨í‚· ë³µì‚¬ ì™„ë£Œ!"));
  }

  // 2. íƒ­ ì „í™˜
  function switchTab(tab) {
    ['translate', 'auto', 'progress', 'done'].forEach(t => {
      document.getElementById('tab-'+t).classList.toggle('active', t===tab);
      document.getElementById('panel-'+t).style.display = t===tab ? 'block' : 'none';
    });
    if(tab==='progress' || tab==='done') loadNovels(tab);
    updateSelectors();
  }

  // 3. ë¦¬ìŠ¤íŠ¸ ë¡œë“œ (í•µì‹¬: ì§„í–‰ â†” ì„œì¬ ì „í™˜ ë²„íŠ¼ í¬í•¨)
  async function loadNovels(status) {
    const list = document.getElementById('novel-list-'+status);
    list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--neon);">ë°ì´í„° ë¡œë”© ì¤‘...</div>';
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novels?status=eq.${status}&order=created_at.desc`, { headers: sbH() });
    const data = await res.json();
    list.innerHTML = data.map(n => `
      <div class="novel-card">
        <div class="novel-info" onclick="openReader('${n.id}', '${n.title}', '${n.status}', '${n.author}')">
          <div style="font-weight:bold;">${n.cover_emoji || 'ğŸ“–'} ${n.title}</div>
          <div style="font-size:11px; color:#888;">${n.author || 'ì‘ê°€ë¯¸ìƒ'}</div>
        </div>
        <div class="novel-btns">
          <div class="n-icon-btn" onclick="toggleStatus('${n.id}', '${n.status}')" title="ìƒíƒœ ì „í™˜">
            ${n.status==='done' ? 'âœï¸' : 'ğŸ“š'}
          </div>
          <div class="n-icon-btn" onclick="deleteNovel('${n.id}')" style="color:#ff4444;">ğŸ—‘ï¸</div>
        </div>
      </div>
    `).join('');
  }

  // 4. ìƒíƒœ ì „í™˜ ë¡œì§ (ì§„í–‰ â†” ì„œì¬)
  async function toggleStatus(id, currentStatus) {
    const newStatus = currentStatus === 'done' ? 'progress' : 'done';
    const msg = newStatus === 'done' ? "ì„œì¬ë¡œ ë³´ë‚¼ê¹Œìš”?" : "ë‹¤ì‹œ ì§„í–‰ìœ¼ë¡œ ë³´ë‚¼ê¹Œìš”?";
    if(!confirm(msg)) return;
    
    await fetch(`${SUPABASE_URL}/rest/v1/novels?id=eq.${id}`, {
      method: 'PATCH',
      headers: sbH(),
      body: JSON.stringify({ status: newStatus })
    });
    loadNovels(currentStatus); // í˜„ì¬ íƒ­ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
  }

  // 5. ë…ì„œ ë·°ì–´ (ì„œì¬ í•©ë³¸ ì „ì²´ì½ê¸° ê¸°ëŠ¥ ë³´ì¡´)
  async function openReader(id, title, status, author) {
    currentNovel = { id, title, author };
    document.getElementById('ch-novel-title').textContent = title;
    document.getElementById('chapter-view').style.display = 'block';
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novel_chapters?novel_id=eq.${id}&order=chapter_num.asc`, { headers: sbH() });
    const data = await res.json();

    if(status === 'done') {
      document.getElementById('chapter-list').style.display = 'none';
      document.getElementById('full-reader').style.display = 'block';
      document.getElementById('full-reader').textContent = data.map(c => c.translated).join('\n\n');
      document.getElementById('compile-area').innerHTML = '';
    } else {
      document.getElementById('chapter-list').style.display = 'block';
      document.getElementById('full-reader').style.display = 'none';
      document.getElementById('compile-area').innerHTML = `<button onclick="compileToDone()" style="color:#ff4444; background:none; border:1px solid #ff4444; padding:5px 10px; border-radius:8px; font-size:11px; font-family:Orbitron; cursor:pointer;">ğŸ“• í•©ë³¸ ì œì‘</button>`;
      document.getElementById('chapter-list').innerHTML = data.map(c => `
        <div style="padding:15px; border-bottom:1px solid #222;">
          <div style="color:var(--neon); font-size:12px;">CH ${c.chapter_num}</div>
          <div style="font-size:14px; color:#ccc; margin-top:5px;">${c.translated.substring(0,100)}...</div>
        </div>`).join('');
    }
  }

  function closeChapterView() { document.getElementById('chapter-view').style.display = 'none'; }

  // 6. í•©ë³¸ ì œì‘ ë° ì†Œì„¤ ê´€ë¦¬
  async function compileToDone() {
    if(!confirm("í•©ë³¸ ì œì‘ í›„ ì„œì¬ë¡œ ë³´ë‚¼ê¹Œìš”?")) return;
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novel_chapters?novel_id=eq.${currentNovel.id}&order=chapter_num.asc`, { headers: sbH() });
    const chapters = await res.json();
    const fullText = chapters.map(c => `[CH ${c.chapter_num}]\n${c.translated}`).join('\n\n--------------------\n\n');
    
    const novelRes = await fetch(`${SUPABASE_URL}/rest/v1/novels`, {
      method:'POST', headers: Object.assign({}, sbH(), { 'Prefer': 'return=representation' }),
      body: JSON.stringify({ title: currentNovel.title + " (í•©ë³¸)", author: currentNovel.author, status: 'done', cover_emoji: 'ğŸ“•' })
    });
    const newNovel = await novelRes.json();
    await fetch(`${SUPABASE_URL}/rest/v1/novel_chapters`, {
      method:'POST', headers: sbH(),
      body: JSON.stringify({ novel_id: newNovel[0].id, chapter_num: 1, translated: fullText })
    });
    alert("ğŸ“• í•©ë³¸ ì™„ë£Œ!"); closeChapterView(); switchTab('done');
  }

  async function addNewNovel() {
    const title = document.getElementById('new-title').value;
    const author = document.getElementById('new-author').value;
    if(!title) return alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”!");
    await fetch(`${SUPABASE_URL}/rest/v1/novels`, { method:'POST', headers:sbH(), body: JSON.stringify({ title, author, status:'progress', cover_emoji:'ğŸ“–' }) });
    document.getElementById('add-modal').style.display='none';
    updateSelectors(); switchTab('progress');
  }

  async function updateSelectors() {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/novels?status=eq.progress`, { headers: sbH() });
    const data = await res.json();
    const opts = '<option value="">ì†Œì„¤ ì„ íƒ...</option>' + data.map(n=>`<option value="${n.id}">${n.title}</option>`).join('');
    document.getElementById('quick-novel-select').innerHTML = opts;
    document.getElementById('auto-novel-select').innerHTML = opts;
  }

  async function deleteNovel(id) {
    if(confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) {
      await fetch(`${SUPABASE_URL}/rest/v1/novels?id=eq.${id}`, { method:'DELETE', headers:sbH() });
      loadNovels('progress'); loadNovels('done');
    }
  }

  function startAutoEngine() {
    const url = document.getElementById('auto-base-url').value;
    const nid = document.getElementById('auto-novel-select').value;
    if(!url || !nid) return alert("ì…ë ¥ê°’ê³¼ ì†Œì„¤ ì„ íƒì„ í™•ì¸í•˜ì„¸ìš”!");
    lastPacket = `í¬ë¹„ë‹¤. ì™€íƒ•ì¹´! ì•„ë˜ ë²”ìœ„ ìˆ˜ì§‘/ë²ˆì—­í•´ë¼.\n[URL] ${url}\n[ID] ${nid}\nê²°ê³¼ëŠ” DB ì§ì†¡.`;
    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('strategy-log').innerHTML = `> ì—”ì§„ ê°€ë™... íŒ¨í‚· ìƒì„± ì™„ë£Œ.`;
    document.getElementById('copy-cmd-btn').style.display = 'block';
  }

  window.onload = () => { updateSelectors(); loadNovels('progress'); };
</script>
</body>
</html>
