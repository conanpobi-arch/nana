<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>NANA NOVEL ENGINE</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@300;400;500&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root { --neon: #00ffcc; --bg: #000b1a; --border: rgba(0,255,204,0.2); }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body, html { width: 100%; height: 100%; background: #000; color: #fff; font-family: 'Noto Sans KR', sans-serif; }

    #galaxy-bg { position: fixed; inset: 0; z-index: 0; background: radial-gradient(ellipse at bottom, #0d1d31 0%, #0c0d13 100%); }
    #star-field { position: fixed; inset: 0; z-index: 1; background-image: radial-gradient(white, rgba(255,255,255,0.2) 2px, transparent 40px); background-size: 150px 150px; opacity: 0.1; }

    #main-view { position: relative; z-index: 2; max-width: 850px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; padding: 2vh 20px 40px; }
    .nav-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; margin-bottom: 15px; }
    .home-icon { cursor: pointer; font-size: 26px; transition: 0.3s; color: var(--neon); }
    .home-icon:hover { transform: scale(1.1); text-shadow: 0 0 15px var(--neon); }
    .engine-title { font-family: 'Orbitron'; color: var(--neon); font-size: 15px; font-weight: bold; letter-spacing: 2px; text-shadow: 0 0 10px var(--neon); }

    .tab-bar { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab-btn { flex: 1; padding: 10px; background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 12px; color: #aaa; font-family: 'Orbitron'; font-size: 10px; letter-spacing: 1px; cursor: pointer; transition: 0.2s; text-align: center; user-select: none; }
    .tab-btn.active { background: rgba(0,255,204,0.15); border-color: var(--neon); color: var(--neon); }

    .card { background: rgba(0,15,35,0.75); border: 1px solid var(--border); border-radius: 20px; padding: 20px; backdrop-filter: blur(15px); margin-bottom: 16px; }
    textarea { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 15px; font-size: 14px; outline: none; margin-bottom: 15px; height: 220px; resize: none; line-height: 1.6; font-family: 'Noto Sans KR'; }
    textarea:focus { border-color: var(--neon); }
    .novel-select { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 12px 15px; font-size: 13px; outline: none; font-family: 'Noto Sans KR'; appearance: none; }
    .modal-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 13px 15px; font-size: 14px; outline: none; font-family: 'Noto Sans KR'; margin-bottom: 12px; transition: border-color 0.3s; }
    .modal-input:focus { border-color: var(--neon); }
    .modal-input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.25); }
    .novel-select-row { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
    .new-novel-btn { padding: 11px 14px; background: rgba(0,255,204,0.1); border: 1px solid var(--neon); border-radius: 12px; color: var(--neon); font-size: 18px; cursor: pointer; flex-shrink: 0; }
    .btn-fire { width: 100%; padding: 18px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 15px; font-weight: 900; font-family: 'Orbitron'; cursor: pointer; font-size: 14px; box-shadow: 0 5px 15px rgba(0,255,204,0.3); letter-spacing: 1px; }
    .btn-fire:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

    /* ì—”ì§„ íƒ­ */
    .engine-label { font-family: 'Orbitron'; font-size: 10px; color: rgba(0,255,204,0.6); letter-spacing: 2px; margin-bottom: 8px; }
    .page-range-row { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; width: 100%; }
    .page-range-label { font-family: 'Orbitron'; font-size: 10px; color: rgba(0,255,204,0.5); letter-spacing: 1px; margin-bottom: 4px; }
    .page-input-wrap { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .page-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 12px 8px; font-size: 18px; outline: none; text-align: center; font-family: 'Noto Sans KR'; font-weight: 700; -moz-appearance: textfield; }
    .page-input::-webkit-inner-spin-button, .page-input::-webkit-outer-spin-button { -webkit-appearance: none; }
    .page-input:focus { border-color: var(--neon); }
    .page-sep { color: #555; font-size: 20px; flex-shrink: 0; padding-top: 20px; }

    /* ì§„í–‰ íŒ¨ë„ */
    #engine-progress-panel { display: none; background: rgba(0,5,15,0.9); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 16px; }
    .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .progress-title { font-family: 'Orbitron'; font-size: 11px; color: var(--neon); letter-spacing: 2px; }
    .progress-fraction { font-family: 'Orbitron'; font-size: 11px; color: #888; }
    .progress-bar-wrap { background: rgba(255,255,255,0.05); border-radius: 10px; height: 8px; margin-bottom: 14px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--neon), #00b4ff); border-radius: 10px; transition: width 0.4s ease; width: 0%; }
    #engine-log { font-family: monospace; font-size: 11px; max-height: 240px; overflow-y: auto; line-height: 1.9; }
    #engine-log::-webkit-scrollbar { width: 4px; }
    #engine-log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    .log-success { color: #00ffcc; }
    .log-fail    { color: #ff5555; }
    .log-working { color: #ffd700; }
    .log-info    { color: #888; }

    /* ì†Œì„¤ ì¹´ë“œ */
    .novel-card { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 14px; transition: 0.2s; }
    .novel-card:hover { border-color: var(--neon); background: rgba(0,255,204,0.08); }
    .novel-emoji { font-size: 34px; flex-shrink: 0; cursor: pointer; }
    .novel-info { flex: 1; cursor: pointer; min-width: 0; }
    .novel-title-text { font-size: 15px; color: #eee; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .novel-author-text { font-size: 12px; color: #888; margin-bottom: 5px; }
    .novel-meta-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .novel-chap-count { font-size: 11px; color: var(--neon); font-family: 'Orbitron'; }
    .status-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
    .status-progress { background: rgba(0,255,204,0.1); color: var(--neon); border: 1px solid var(--border); }
    .status-done { background: rgba(255,215,0,0.1); color: #ffd700; border: 1px solid rgba(255,215,0,0.3); }
    .novel-btns { display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
    .n-icon-btn { font-size: 16px; cursor: pointer; color: rgba(255,255,255,0.2); padding: 4px; transition: 0.2s; }
    .n-icon-btn:hover { color: var(--neon); }
    .n-icon-btn.del:hover { color: #ff4444; }
    .empty-state { text-align: center; color: rgba(255,255,255,0.3); font-size: 13px; padding: 50px 0; font-family: 'Orbitron'; letter-spacing: 2px; }

    /* ì±•í„° ë·° */
    #chapter-view { display: none; position: fixed; inset: 0; z-index: 200; background: #000b1a; overflow-y: auto; padding: 20px; }
    .ch-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; max-width: 850px; margin-left: auto; margin-right: auto; padding-top: 10px; }
    .back-btn { font-size: 26px; cursor: pointer; color: var(--neon); flex-shrink: 0; }
    .ch-novel-title { font-family: 'Orbitron'; color: var(--neon); font-size: 13px; letter-spacing: 2px; }
    .ch-list-wrap { max-width: 850px; margin: 0 auto; }
    .chapter-card { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 10px; }
    .chapter-num-label { font-family: 'Orbitron'; font-size: 11px; color: var(--neon); letter-spacing: 2px; margin-bottom: 8px; }
    .chapter-preview-text { font-size: 13px; color: #aaa; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; cursor: pointer; }
    .chapter-action-row { display: flex; gap: 8px; margin-top: 10px; }
    .ch-act-btn { flex: 1; padding: 7px; border-radius: 8px; font-size: 11px; cursor: pointer; border: 1px solid var(--border); background: rgba(255,255,255,0.04); color: #aaa; text-align: center; transition: 0.2s; }
    .ch-act-btn:hover { border-color: var(--neon); color: var(--neon); }
    .ch-act-btn.del:hover { border-color: #ff4444; color: #ff4444; }
    .library-btn-sm { font-size: 12px; color: #ffd700; cursor: pointer; font-family: 'Orbitron'; border: 1px solid rgba(255,215,0,0.3); padding: 6px 10px; border-radius: 8px; margin-left: auto; white-space: nowrap; }

    /* ê²°ê³¼ ë°•ìŠ¤ */
    #res-box { display: none; position: fixed; inset: 0; background: #050a14; z-index: 5000; overflow-y: auto; padding: 60px 30px 160px; font-family: 'Noto Serif KR', serif; line-height: 2.2; font-size: 18px; color: #ececec; text-align: justify; word-break: break-all; -webkit-overflow-scrolling: touch; }
    .trans-paragraph { display: block; margin-bottom: 35px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,255,204,0.05); }
    #result-bottom-bar { display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 5001; background: rgba(0,10,25,0.98); border-top: 1px solid var(--border); backdrop-filter: blur(25px); padding: 20px 25px; align-items: center; gap: 12px; flex-wrap: wrap; }
    .copy-icon-btn { width: 56px; height: 56px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; flex-shrink: 0; }
    .save-chap-btn { flex: 1; height: 56px; background: rgba(0,255,204,0.1); border: 1px solid var(--neon); color: var(--neon); border-radius: 14px; font-family: 'Orbitron'; font-size: 12px; font-weight: 900; cursor: pointer; min-width: 100px; }
    .back-main-btn { flex: 1; height: 56px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 14px; font-weight: 900; font-family: 'Orbitron'; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    /* ë¡œë”© */
    #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    .main-loader { width: 50px; height: 50px; border: 4px solid rgba(0,255,204,0.1); border-top: 4px solid var(--neon); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 20px; }
    #engine-status-text { color: var(--neon); font-size: 16px; margin-bottom: 15px; letter-spacing: 1px; font-weight: bold; }
    #strategy-log { color: #fff; font-size: 11px; width: 340px; text-align: left; background: rgba(0,20,40,0.8); padding: 15px; border-radius: 12px; font-family: monospace; border: 1px solid var(--border); max-height: 200px; overflow-y: auto; line-height: 1.5; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ëª¨ë‹¬ */
    .modal-overlay { display: none; position: fixed; inset: 0; z-index: 8000; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); align-items: center; justify-content: center; padding: 20px; }
    .modal-sheet { width: 100%; max-width: 500px; background: rgba(0,15,35,0.98); border: 1px solid var(--border); border-radius: 24px; padding: 28px 24px 32px; }
    .modal-title { font-family: 'Orbitron'; color: var(--neon); font-size: 13px; letter-spacing: 3px; margin-bottom: 20px; text-align: center; }
    .emoji-select { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .emoji-btn { width: 44px; height: 44px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,0.04); font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .emoji-btn.active { border-color: var(--neon); background: rgba(0,255,204,0.15); }
    .modal-btns { display: flex; gap: 10px; }
    .modal-cancel { flex: 1; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: transparent; color: #aaa; font-size: 13px; cursor: pointer; font-family: 'Orbitron'; }
    .modal-save-btn { flex: 2; padding: 14px; border-radius: 12px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; font-weight: 900; font-size: 13px; cursor: pointer; font-family: 'Orbitron'; }

    /* ì±•í„° ìƒì„¸ */
    #chapter-detail { display: none; position: fixed; inset: 0; z-index: 5500; background: #050a14; overflow-y: auto; padding: 60px 30px 120px; font-family: 'Noto Serif KR', serif; font-size: 18px; line-height: 2.2; color: #ececec; }
    .detail-wrap { max-width: 750px; margin: 0 auto; }
    .detail-num { font-family: 'Orbitron'; color: var(--neon); font-size: 12px; letter-spacing: 3px; margin-bottom: 24px; }
    .compiled-chapter-divider { color: var(--neon); font-family: 'Orbitron'; font-size: 11px; letter-spacing: 3px; margin: 50px 0 20px; padding: 12px 0; border-top: 1px solid rgba(0,255,204,0.2); border-bottom: 1px solid rgba(0,255,204,0.2); text-align: center; }
    .compiled-title-block { text-align: center; margin-bottom: 50px; padding: 30px; border: 1px solid rgba(0,255,204,0.15); border-radius: 16px; background: rgba(0,255,204,0.03); }
    .compiled-title-text { font-size: 22px; color: var(--neon); font-weight: 700; margin-bottom: 10px; }
    .compiled-author-text { font-size: 14px; color: #888; }
    .detail-close { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 14px 40px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 14px; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; font-size: 13px; }

    /* ì´ˆê¸°í™” ìŠ¤í¬ë¦° */
    #init-screen { display: flex; position: fixed; inset: 0; z-index: 99999; background: #000b1a; flex-direction: column; align-items: center; justify-content: center; gap: 16px; }
    .init-loader { width: 40px; height: 40px; border: 3px solid rgba(0,255,204,0.1); border-top: 3px solid var(--neon); border-radius: 50%; animation: spin 1s infinite linear; }
    .init-text { font-family: 'Orbitron'; color: var(--neon); font-size: 12px; letter-spacing: 3px; }
  </style>
</head>
<body>
<div id="galaxy-bg"></div>
<div id="star-field"></div>

<div id="init-screen">
  <div class="init-loader"></div>
  <div class="init-text">INITIALIZING...</div>
</div>

<div id="loading-overlay">
  <div class="main-loader"></div>
  <div id="engine-status-text">TRANSLATING...</div>
  <div id="strategy-log"></div>
</div>

<div id="res-box"></div>
<div id="result-bottom-bar">
  <div class="copy-icon-btn" onclick="copyResult()">ğŸ“‹</div>
  <button class="save-chap-btn" onclick="openSaveModal()">ğŸ’¾ ì €ì¥</button>
  <button class="back-main-btn" onclick="closeResult()">â† ëŒì•„ê°€ê¸°</button>
</div>

<div id="chapter-detail">
  <div class="detail-wrap">
    <div class="detail-num" id="detail-num"></div>
    <div id="detail-text"></div>
  </div>
  <button class="detail-close" onclick="document.getElementById('chapter-detail').style.display='none'">âœ• ë‹«ê¸°</button>
</div>

<div id="chapter-view">
  <div class="ch-list-wrap">
    <div class="ch-header">
      <div class="back-btn" onclick="closeChapterView()">â†</div>
      <div>
        <div class="ch-novel-title" id="ch-novel-title"></div>
        <div style="font-size:11px;color:#888;margin-top:2px;" id="ch-novel-author"></div>
      </div>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <div class="library-btn-sm" onclick="compileToDone()" style="color:var(--neon);border-color:rgba(0,255,204,0.3);">ğŸ“• í•©ë³¸</div>
        <div class="library-btn-sm" onclick="moveToLibrary()">ğŸ“š ì„œì¬ë¡œ</div>
      </div>
    </div>
    <div id="chapter-list"></div>
  </div>
</div>

<div id="novel-modal" class="modal-overlay" onclick="closeNovelModal()">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“– ìƒˆ ì†Œì„¤ í”„ë¡œì íŠ¸</div>
    <input class="modal-input" id="novel-title-input" placeholder="ì†Œì„¤ ì œëª©">
    <input class="modal-input" id="novel-author-input" placeholder="ì‘ê°€ (ì„ íƒì‚¬í•­)">
    <div style="font-size:11px;color:rgba(0,255,204,0.7);font-family:'Orbitron';letter-spacing:2px;margin-bottom:10px;">í‘œì§€ ì´ëª¨ì§€</div>
    <div class="emoji-select" id="emoji-select">
      <div class="emoji-btn active" data-emoji="ğŸ“–">ğŸ“–</div>
      <div class="emoji-btn" data-emoji="ğŸ“š">ğŸ“š</div>
      <div class="emoji-btn" data-emoji="ğŸ”®">ğŸ”®</div>
      <div class="emoji-btn" data-emoji="âš”ï¸">âš”ï¸</div>
      <div class="emoji-btn" data-emoji="ğŸŒ™">ğŸŒ™</div>
      <div class="emoji-btn" data-emoji="ğŸ‰">ğŸ‰</div>
      <div class="emoji-btn" data-emoji="ğŸ•µï¸">ğŸ•µï¸</div>
      <div class="emoji-btn" data-emoji="ğŸ’€">ğŸ’€</div>
      <div class="emoji-btn" data-emoji="ğŸŒ¹">ğŸŒ¹</div>
      <div class="emoji-btn" data-emoji="ğŸš€">ğŸš€</div>
    </div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeNovelModal()">ì·¨ì†Œ</button>
      <button class="modal-save-btn" onclick="saveNovel()">ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>
</div>

<div id="save-modal" class="modal-overlay" onclick="closeSaveModal()">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ’¾ ì±•í„° ì €ì¥</div>
    <select id="save-novel-select" style="width:100%;background:rgba(0,0,0,0.5);border:1px solid var(--border);border-radius:12px;color:#fff;padding:13px 15px;font-size:14px;outline:none;font-family:'Noto Sans KR';margin-bottom:12px;appearance:none;"></select>
    <div style="font-size:11px;color:rgba(0,255,204,0.5);margin-bottom:18px;text-align:center;font-family:'Orbitron';" id="save-chapter-num-label">ì†Œì„¤ì„ ì„ íƒí•˜ë©´ ì±•í„° ë²ˆí˜¸ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeSaveModal()">ì·¨ì†Œ</button>
      <button class="modal-save-btn" onclick="confirmSaveChapter()">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="main-view">
  <div class="nav-header">
    <div class="home-icon" onclick="location.href='index.html'">ğŸ </div>
    <div class="engine-title">NANA NOVEL</div>
    <div onclick="document.getElementById('mainInput').value=''" style="cursor:pointer;font-size:26px;">ğŸ—‘ï¸</div>
  </div>

  <div class="tab-bar">
    <div class="tab-btn active" id="tab-translate" onclick="switchTab('translate')">ğŸ”„ ë²ˆì—­</div>
    <div class="tab-btn"        id="tab-engine"    onclick="switchTab('engine')">ğŸ›°ï¸ ì—”ì§„</div>
    <div class="tab-btn"        id="tab-progress"  onclick="switchTab('progress')">âœï¸ ì§„í–‰</div>
    <div class="tab-btn"        id="tab-done"      onclick="switchTab('done')">ğŸ“š ì„œì¬</div>
  </div>

  <!-- ë²ˆì—­ íƒ­ -->
  <div id="panel-translate">
    <div class="card">
      <div class="novel-select-row">
        <select class="novel-select" id="quick-novel-select">
          <option value="">ì €ì¥í•  ì†Œì„¤ ì„ íƒ (ì„ íƒì‚¬í•­)...</option>
        </select>
        <div class="new-novel-btn" onclick="openNovelModal()">ï¼‹</div>
      </div>
      <textarea id="mainInput" placeholder="ğŸ“Œ ì†Œì„¤ URL ë˜ëŠ” ì›ë¬¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
      <button class="btn-fire" onclick="fireEngine()">ğŸ”¥ ë²ˆì—­ ì‹œì‘</button>
    </div>
  </div>

  <!-- ğŸ›°ï¸ ì—”ì§„ íƒ­ -->
  <div id="panel-engine" style="display:none;">
    <div class="card">
      <div class="engine-label">STEP 1 â€” ì†Œì„¤ ì„ íƒ ë˜ëŠ” ìƒì„±</div>
      <div class="novel-select-row" style="margin-bottom:20px;">
        <select class="novel-select" id="engine-novel-select">
          <option value="">ì†Œì„¤ ì„ íƒ...</option>
        </select>
        <div class="new-novel-btn" onclick="openNovelModal()">ï¼‹</div>
      </div>

      <div class="engine-label">STEP 2 â€” URL íŒ¨í„´</div>
      <input class="modal-input" id="engine-url-pattern"
        placeholder="https://ixdzs.tw/read/128871/p{n}.html"
        oninput="updateUrlPreview()">
      <div style="font-size:11px;color:rgba(255,255,255,0.25);margin-top:-6px;margin-bottom:8px;">ìˆ«ì ìë¦¬ì— <span style="color:#00ffcc;font-family:monospace;">{n}</span> ì„ ë„£ìœ¼ì„¸ìš” &nbsp;ì˜ˆ) p{n}.html â†’ p1.html, p2.html...</div>
      <div id="url-preview" style="font-size:11px;color:#00ffcc;background:rgba(0,255,204,0.04);border:1px solid rgba(0,255,204,0.2);border-radius:8px;padding:8px 12px;margin-bottom:16px;font-family:monospace;word-break:break-all;display:none;"></div>

      <div class="engine-label">STEP 3 â€” í˜ì´ì§€ ë²”ìœ„</div>
      <div class="page-range-row">
        <div class="page-input-wrap">
          <div class="page-range-label">ì‹œì‘</div>
          <input type="number" class="page-input" id="engine-start" value="1" min="1">
        </div>
        <div class="page-sep">~</div>
        <div class="page-input-wrap">
          <div class="page-range-label">ë</div>
          <input type="number" class="page-input" id="engine-end" value="10" min="1">
        </div>
      </div>

      <button class="btn-fire" id="engine-start-btn" onclick="startAutoEngine()">ğŸš€ ìë™ ë²ˆì—­ ì‹œì‘</button>
    </div>

    <div id="engine-progress-panel">
      <div class="progress-header">
        <div class="progress-title">TRANSLATING</div>
        <div class="progress-fraction" id="progress-fraction">0 / 0</div>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progress-bar"></div>
      </div>
      <div id="engine-log"></div>
    </div>
  </div>

  <!-- ì§„í–‰ íƒ­ -->
  <div id="panel-progress" style="display:none;">
    <div id="novel-list-progress"><div class="empty-state">íƒ­ì„ ëˆ„ë¥´ë©´ ë¡œë”©ë©ë‹ˆë‹¤</div></div>
  </div>

  <!-- ì„œì¬ íƒ­ -->
  <div id="panel-done" style="display:none;">
    <div id="novel-list-done"><div class="empty-state">íƒ­ì„ ëˆ„ë¥´ë©´ ë¡œë”©ë©ë‹ˆë‹¤</div></div>
  </div>
</div>

<script>
  let SUPABASE_URL = '', SUPABASE_KEY = '';
  let currentTab = 'translate', currentNovel = null, allNovels = [];
  let selectedEmoji = 'ğŸ“–', lastTranslated = '', lastOriginal = '';
  let engineRunning = false;
  const statusText = document.getElementById('engine-status-text');

  function sbH() {
    return { 'Content-Type':'application/json', 'apikey': SUPABASE_KEY, 'Authorization':'Bearer '+SUPABASE_KEY };
  }

  // â”€â”€ ì´ˆê¸°í™” â”€â”€
  async function init() {
    try {
      var r = await fetch('/api/config');
      if (!r.ok) throw new Error('config ì˜¤ë¥˜ HTTP ' + r.status);
      var cfg = await r.json();
      SUPABASE_URL = cfg.supabaseUrl; SUPABASE_KEY = cfg.supabaseKey;
      if (!SUPABASE_URL || !SUPABASE_KEY) throw new Error('í‚¤ ëˆ„ë½');
    } catch(e) {
      document.querySelector('.init-text').textContent = 'CONFIG ERROR: ' + e.message;
      document.querySelector('.init-loader').style.display = 'none'; return;
    }
    document.getElementById('init-screen').style.display = 'none';
    try {
      var r2 = await fetch(SUPABASE_URL+'/rest/v1/novels?status=eq.progress&order=created_at.desc', { headers: sbH() });
      if (r2.ok) { allNovels = await r2.json(); updateQuickSelects(allNovels); }
    } catch(e) {}
  }

  // â”€â”€ íƒ­ â”€â”€
  function switchTab(tab) {
    currentTab = tab;
    ['translate','engine','progress','done'].forEach(function(t) {
      document.getElementById('tab-'+t).classList.toggle('active', t===tab);
      document.getElementById('panel-'+t).style.display = t===tab ? 'block' : 'none';
    });
    if (tab==='progress') loadNovels('progress');
    if (tab==='done')     loadNovels('done');
  }

  function updateQuickSelects(novels) {
    ['quick-novel-select','save-novel-select','engine-novel-select'].forEach(function(id) {
      var sel = document.getElementById(id); if (!sel) return;
      var prev = sel.value;
      sel.innerHTML = id==='quick-novel-select' ? '<option value="">ì €ì¥í•  ì†Œì„¤ ì„ íƒ (ì„ íƒì‚¬í•­)...</option>' : '<option value="">ì†Œì„¤ ì„ íƒ...</option>';
      (novels||[]).forEach(function(n) {
        var opt = document.createElement('option');
        opt.value = n.id; opt.textContent = (n.cover_emoji||'ğŸ“–')+' '+n.title;
        sel.appendChild(opt);
      });
      if (prev) sel.value = prev;
    });
  }

  async function loadNovels(status) {
    var listEl = document.getElementById('novel-list-'+status); if (!listEl) return;
    listEl.innerHTML = '<div class="empty-state">LOADING...</div>';
    try {
      var res = await fetch(SUPABASE_URL+'/rest/v1/novels?status=eq.'+status+'&order=created_at.desc', { headers: sbH() });
      if (!res.ok) throw new Error('HTTP '+res.status);
      var novels = await res.json();
      if (status==='progress') { allNovels = novels; updateQuickSelects(novels); }
      if (!novels.length) { listEl.innerHTML='<div class="empty-state">'+(status==='progress'?'ì§„í–‰ ì¤‘ì¸ ì†Œì„¤ ì—†ìŒ':'ì„œì¬ê°€ ë¹„ì–´ìˆì–´ìš”')+'</div>'; return; }
      listEl.innerHTML = '';
      novels.forEach(function(n) { listEl.appendChild(makeNovelCard(n)); });
    } catch(e) { listEl.innerHTML='<div class="empty-state">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message+'</div>'; }
  }

  function makeNovelCard(novel) {
    var card = document.createElement('div'); card.className = 'novel-card';
    card.innerHTML =
      '<div class="novel-emoji">'+(novel.cover_emoji||'ğŸ“–')+'</div>'+
      '<div class="novel-info">'+
        '<div class="novel-title-text">'+escHtml(novel.title)+'</div>'+
        (novel.author?'<div class="novel-author-text">'+escHtml(novel.author)+'</div>':'')+
        '<div class="novel-meta-row">'+
          '<span class="novel-chap-count" id="cc-'+novel.id+'">... ì±•í„°</span>'+
          '<span class="status-badge '+(novel.status==='done'?'status-done':'status-progress')+'">'+
            (novel.status==='done'?'âœ… ì™„ë£Œ':'âœï¸ ì§„í–‰ì¤‘')+'</span>'+
        '</div></div>'+
      '<div class="novel-btns">'+
        '<div class="n-icon-btn lib">'+(novel.status==='done'?'âœï¸':'ğŸ“š')+'</div>'+
        '<div class="n-icon-btn del">ğŸ—‘ï¸</div>'+
      '</div>';
    fetchChapCount(novel.id);
    card.querySelector('.novel-info').addEventListener('click', function(){ openChapterView(novel); });
    card.querySelector('.novel-emoji').addEventListener('click', function(){ openChapterView(novel); });
    card.querySelector('.lib').addEventListener('click', function(e){ e.stopPropagation(); toggleStatus(novel); });
    card.querySelector('.del').addEventListener('click', function(e){ e.stopPropagation(); deleteNovel(novel.id); });
    return card;
  }

  function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  async function fetchChapCount(id) {
    try {
      var r = await fetch(SUPABASE_URL+'/rest/v1/novel_chapters?novel_id=eq.'+id+'&select=id', { headers: sbH() });
      var d = await r.json(); var el = document.getElementById('cc-'+id);
      if (el) el.textContent = (Array.isArray(d)?d.length:'?')+' ì±•í„°';
    } catch(e) {}
  }

  async function toggleStatus(novel) {
    var ns = novel.status==='done'?'progress':'done';
    if (!confirm(ns==='done'?'ì„œì¬ë¡œ ì´ë™í• ê¹Œìš”?':'ì§„í–‰ ì¤‘ìœ¼ë¡œ ë˜ëŒë¦´ê¹Œìš”?')) return;
    await fetch(SUPABASE_URL+'/rest/v1/novels?id=eq.'+novel.id, { method:'PATCH', headers:sbH(), body:JSON.stringify({status:ns}) });
    loadNovels(currentTab);
  }

  async function deleteNovel(id) {
    if (!confirm('ì†Œì„¤ê³¼ ëª¨ë“  ì±•í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) return;
    await fetch(SUPABASE_URL+'/rest/v1/novel_chapters?novel_id=eq.'+id, { method:'DELETE', headers:sbH() });
    await fetch(SUPABASE_URL+'/rest/v1/novels?id=eq.'+id, { method:'DELETE', headers:sbH() });
    loadNovels(currentTab);
  }

  // â”€â”€ ì†Œì„¤ ëª¨ë‹¬ â”€â”€
  function openNovelModal() {
    selectedEmoji='ğŸ“–';
    document.getElementById('novel-title-input').value='';
    document.getElementById('novel-author-input').value='';
    document.querySelectorAll('.emoji-btn').forEach(function(b){ b.classList.toggle('active', b.dataset.emoji==='ğŸ“–'); });
    document.getElementById('novel-modal').style.display='flex';
    setTimeout(function(){ document.getElementById('novel-title-input').focus(); }, 200);
  }
  function closeNovelModal() { document.getElementById('novel-modal').style.display='none'; }
  document.querySelectorAll('.emoji-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.emoji-btn').forEach(function(b){ b.classList.remove('active'); });
      btn.classList.add('active'); selectedEmoji = btn.dataset.emoji;
    });
  });

  async function saveNovel() {
    var title = document.getElementById('novel-title-input').value.trim();
    if (!title) { alert('ì†Œì„¤ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
    var author = document.getElementById('novel-author-input').value.trim() || null;
    var res = await fetch(SUPABASE_URL+'/rest/v1/novels', {
      method:'POST', headers:Object.assign({}, sbH(), {'Prefer':'return=representation'}),
      body: JSON.stringify({ title, author, cover_emoji: selectedEmoji, status:'progress' })
    });
    var data = await res.json(); closeNovelModal();
    var fresh = await fetch(SUPABASE_URL+'/rest/v1/novels?status=eq.progress&order=created_at.desc', { headers:sbH() });
    allNovels = await fresh.json(); updateQuickSelects(allNovels);
    if (data && data[0]) {
      document.getElementById('quick-novel-select').value = data[0].id;
      document.getElementById('engine-novel-select').value = data[0].id;
    }
    if (currentTab==='progress') loadNovels('progress');
  }

  // â”€â”€ ì±•í„° ë·° â”€â”€
  function openChapterView(novel) {
    currentNovel = novel;
    document.getElementById('ch-novel-title').textContent = novel.title;
    document.getElementById('ch-novel-author').textContent = novel.author || '';
    document.getElementById('chapter-view').style.display = 'block';
    loadChapters();
  }
  function closeChapterView() { document.getElementById('chapter-view').style.display='none'; currentNovel=null; }

  async function loadChapters() {
    var listEl = document.getElementById('chapter-list');
    listEl.innerHTML = '<div class="empty-state" style="padding:30px 0">LOADING...</div>';
    var res = await fetch(SUPABASE_URL+'/rest/v1/novel_chapters?novel_id=eq.'+currentNovel.id+'&order=chapter_num.asc', { headers:sbH() });
    var chapters = await res.json();
    if (!chapters.length) { listEl.innerHTML='<div class="empty-state" style="padding:30px 0">ì €ì¥ëœ ì±•í„°ê°€ ì—†ì–´ìš”</div>'; return; }
    listEl.innerHTML = '';
    var isCompiled = currentNovel.cover_emoji === 'ğŸ“•';
    chapters.forEach(function(ch) {
      var card = document.createElement('div'); card.className = 'chapter-card';
      card.innerHTML =
        '<div class="chapter-num-label">CHAPTER '+ch.chapter_num+'</div>'+
        '<div class="chapter-preview-text">'+escHtml((ch.translated||ch.original||'').substring(0,200))+'</div>'+
        '<div class="chapter-action-row">'+
          '<div class="ch-act-btn view">ğŸ“– ë³´ê¸°</div>'+
          '<div class="ch-act-btn del">ğŸ—‘ï¸ ì‚­ì œ</div>'+
        '</div>';
      card.querySelector('.view').addEventListener('click', function(){ showChapterDetail(ch, isCompiled); });
      card.querySelector('.chapter-preview-text').addEventListener('click', function(){ showChapterDetail(ch, isCompiled); });
      card.querySelector('.del').addEventListener('click', function(){ deleteChapter(ch.id); });
      listEl.appendChild(card);
    });
  }

  function showChapterDetail(ch, isCompiled) {
    var detailEl=document.getElementById('chapter-detail'), numEl=document.getElementById('detail-num'), wrap=document.getElementById('detail-text');
    var text = ch.translated||ch.original||'';
    if (isCompiled) {
      numEl.textContent=''; var html='';
      var tm=text.match(/â•+\n\s+(.+?)\n/), am=text.match(/ì €ì:\s*(.+?)\n/);
      if (tm) { html+='<div class="compiled-title-block"><div class="compiled-title-text">ğŸ“• '+escHtml(tm[1].trim())+'</div>'+(am?'<div class="compiled-author-text">'+escHtml(am[1].trim())+'</div>':'')+'</div>'; }
      var sp=text.split(/â”€+\n\s+ç¬¬\s*(\d+)\s+ç« \s*\nâ”€+/);
      if (sp.length>1) { for(var i=1;i<sp.length;i+=2){ html+='<div class="compiled-chapter-divider">ç¬¬ '+sp[i]+' ç« </div>'+renderParagraphs((sp[i+1]||'').trim()); } }
      else { html+=renderParagraphs(text); }
      wrap.innerHTML=html;
    } else { numEl.textContent='CHAPTER '+ch.chapter_num; wrap.innerHTML=renderParagraphs(text); }
    detailEl.style.display='block'; detailEl.scrollTop=0;
  }

  async function deleteChapter(id) {
    if (!confirm('ì´ ì±•í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
    await fetch(SUPABASE_URL+'/rest/v1/novel_chapters?id=eq.'+id, { method:'DELETE', headers:sbH() });
    loadChapters();
  }

  async function compileToDone() {
    if (!currentNovel || !confirm('ëª¨ë“  ì±•í„°ë¥¼ í•©ë³¸ìœ¼ë¡œ ì„œì¬ì— ì €ì¥í• ê¹Œìš”?')) return;
    document.getElementById('loading-overlay').style.display='flex'; statusText.textContent='í•©ë³¸ í¸ì§‘ ì¤‘...';
    var res = await fetch(SUPABASE_URL+'/rest/v1/novel_chapters?novel_id=eq.'+currentNovel.id+'&order=chapter_num.asc', { headers:sbH() });
    var chapters = await res.json();
    if (!chapters.length) { alert('ì±•í„°ê°€ ì—†ì–´ìš”!'); document.getElementById('loading-overlay').style.display='none'; return; }
    var compiled = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  '+currentNovel.title+'\n'+(currentNovel.author?'  ì €ì: '+currentNovel.author+'\n':'')+'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n\n';
    chapters.forEach(function(ch){ compiled+='â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  ç¬¬ '+ch.chapter_num+' ç« \nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n'+(ch.translated||ch.original||'').trim()+'\n\n\n'; });
    var nr=await fetch(SUPABASE_URL+'/rest/v1/novels', { method:'POST', headers:Object.assign({},sbH(),{'Prefer':'return=representation'}), body:JSON.stringify({title:currentNovel.title+' ã€í•©ë³¸ã€‘',author:currentNovel.author||null,cover_emoji:'ğŸ“•',status:'done'}) });
    var nn=await nr.json();
    await fetch(SUPABASE_URL+'/rest/v1/novel_chapters', { method:'POST', headers:sbH(), body:JSON.stringify({novel_id:nn[0].id,chapter_num:1,original:'',translated:compiled}) });
    document.getElementById('loading-overlay').style.display='none'; alert('ğŸ“• í•©ë³¸ì´ ì„œì¬ì— ì €ì¥ëì–´ìš”!');
  }

  async function moveToLibrary() {
    if (!currentNovel || !confirm('ì„œì¬ë¡œ ì´ë™í• ê¹Œìš”?')) return;
    await fetch(SUPABASE_URL+'/rest/v1/novels?id=eq.'+currentNovel.id, { method:'PATCH', headers:sbH(), body:JSON.stringify({status:'done'}) });
    closeChapterView(); if (currentTab==='progress') loadNovels('progress');
  }

  // â”€â”€ ë‹¨ì¼ ë²ˆì—­ â”€â”€
  function setStatus(txt) { statusText.innerText=txt; }
  function logStep(msg, type) {
    var log=document.getElementById('strategy-log');
    var c=type==='success'?'#00ffcc':type==='fail'?'#ff4444':'#ccc';
    log.innerHTML+='<span style="color:'+c+'">'+escHtml(msg)+'</span>\n'; log.scrollTop=log.scrollHeight;
  }
  function renderParagraphs(text) {
    return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .split(/\n{2,}/).map(function(p){ var c=p.replace(/\n/g,'<br>').trim(); return c?'<p class="trans-paragraph">'+c+'</p>':''; }).filter(Boolean).join('');
  }
  function copyResult() {
    navigator.clipboard.writeText(document.getElementById('res-box').innerText).then(function(){
      var b=document.querySelector('.copy-icon-btn'); b.innerText='âœ…'; setTimeout(function(){b.innerText='ğŸ“‹';},1500);
    });
  }
  function closeResult() { document.getElementById('res-box').style.display='none'; document.getElementById('result-bottom-bar').style.display='none'; }

  function extractTextFromDoc(doc) {
    doc.querySelectorAll('script,style,ins,iframe,noscript,svg,header,footer,nav,aside,.ads,.ad,.banner,.menu,.comment,#comment,.sidebar').forEach(function(e){e.remove();});
    var sels=['#content','.content','#chaptercontent','.chapter-content','#bookcontent','.book-content','article','main','.main-content','#main'];
    var bodyEl=null;
    for(var i=0;i<sels.length;i++){ var el=doc.querySelector(sels[i]); if(el&&el.innerText&&el.innerText.trim().length>200){bodyEl=el;break;} }
    if(!bodyEl) bodyEl=doc.body;
    bodyEl.querySelectorAll('p,div,br,li,h3,h4,h5,h6,tr,blockquote').forEach(function(el){ el.insertAdjacentText('beforebegin',el.tagName==='BR'?'\n':'\n\n'); if(el.tagName!=='BR') el.insertAdjacentText('afterend','\n\n'); });
    return (bodyEl.innerText||bodyEl.textContent||'').replace(/\t/g,' ').replace(/\r\n/g,'\n').replace(/\r/g,'\n').replace(/[ \t]{2,}/g,' ').replace(/\n{4,}/g,'\n\n\n').trim();
  }

  var PROXIES = [
    { name:'CorsProxy.io', url:function(u){return 'https://corsproxy.io/?'+encodeURIComponent(u);} },
    { name:'AllOrigins',   url:function(u){return 'https://api.allorigins.win/get?url='+encodeURIComponent(u);} },
    { name:'CodeTabs',     url:function(u){return 'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(u);} }
  ];

  // í¬ë¡¤ë§: ì„œë²„ì‚¬ì´ë“œ ìš°ì„  â†’ í”„ë¡ì‹œ í´ë°±
  async function crawlPage(url) {
    // 1ìˆœìœ„: Vercel ì„œë²„ì‚¬ì´ë“œ í¬ë¡¤ëŸ¬ (CORS ì™„ì „ ìš°íšŒ)
    try {
      var cr = await fetch('/api/crawl', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url}) });
      if (cr.ok) {
        var cd = await cr.json();
        if (cd.text && cd.text.length > 50) return cd.text;
      }
    } catch(e) {}
    // 2ìˆœìœ„: í´ë¼ì´ì–¸íŠ¸ í”„ë¡ì‹œ í´ë°±
    for (var i=0; i<PROXIES.length; i++) {
      try {
        var res = await fetch(PROXIES[i].url(url));
        var text = PROXIES[i].name==='AllOrigins' ? (await res.json()).contents : await res.text();
        if (text && text.length > 200) {
          var doc = new DOMParser().parseFromString(text, 'text/html');
          var extracted = extractTextFromDoc(doc);
          if (extracted.length > 50) return extracted;
        }
      } catch(e) {}
    }
    throw new Error('ëª¨ë“  í¬ë¡¤ë§ ë°©ë²• ì‹¤íŒ¨');
  }

  async function translateText(text) {
    var res = await fetch('/api/translate', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text}) });
    if (!res.ok) throw new Error('ë²ˆì—­ API HTTP ' + res.status);
    var data = await res.json();
    if (!data.result) throw new Error('ë²ˆì—­ ê²°ê³¼ ì—†ìŒ');
    return data.result;
  }

  async function fireEngine() {
    var input = document.getElementById('mainInput').value.trim();
    if (!input) { alert('ì›ë¬¸ ë˜ëŠ” URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
    document.getElementById('loading-overlay').style.display='flex';
    document.getElementById('strategy-log').innerHTML='';
    var rawData = input;
    try {
      if (input.startsWith('http')) {
        setStatus('í¬ë¡¤ë§ ì¤‘...');
        logStep('CRAWL: ì„œë²„ í¬ë¡¤ëŸ¬ ì‹œë„...');
        try {
          rawData = await crawlPage(input);
          logStep('SUCCESS: '+rawData.length+'ì íšë“', 'success');
        } catch(e) { throw new Error('í¬ë¡¤ë§ ì‹¤íŒ¨: '+e.message); }
      }
      setStatus('ì œë¯¸ë‚˜ì´ ê°ë…ê´€ ëª¨ë“œ ê°€ë™...');
      logStep('API: ë²ˆì—­ ì„œë²„ ì—°ê²°...');
      var translated = await translateText(rawData);
      logStep('SUCCESS: ë²ˆì—­ ì™„ë£Œ', 'success');
      lastTranslated=translated; lastOriginal=rawData;
      var rb=document.getElementById('res-box');
      rb.innerHTML=renderParagraphs(translated); rb.style.display='block'; rb.scrollTop=0;
      document.getElementById('result-bottom-bar').style.display='flex';
      document.getElementById('loading-overlay').style.display='none';
    } catch(e) {
      setStatus('ì—”ì§„ ì¤‘ë‹¨ë¨'); logStep('ERROR: '+e.message,'fail');
      document.getElementById('loading-overlay').style.display='none';
    }
  }

  // â”€â”€ ğŸ›°ï¸ ìë™ ì—”ì§„ â”€â”€
  function engineLog(msg, type) {
    var log=document.getElementById('engine-log');
    var cls=type==='success'?'log-success':type==='fail'?'log-fail':type==='working'?'log-working':'log-info';
    log.innerHTML+='<div class="'+cls+'">'+escHtml(msg)+'</div>'; log.scrollTop=log.scrollHeight;
  }
  function setProgress(done, total) {
    document.getElementById('progress-fraction').textContent=done+' / '+total;
    document.getElementById('progress-bar').style.width=(total>0?Math.round(done/total*100):0)+'%';
  }

  // â”€â”€ URL ë¯¸ë¦¬ë³´ê¸° â”€â”€
  function updateUrlPreview() {
    var pattern = document.getElementById('engine-url-pattern').value.trim();
    var start   = parseInt(document.getElementById('engine-start').value) || 1;
    var preview = document.getElementById('url-preview');
    if (!pattern || !pattern.includes('{n}')) { preview.style.display='none'; return; }
    var ex1 = pattern.replace(/{n}/g, start);
    var ex2 = pattern.replace(/{n}/g, start+1);
    var ex3 = pattern.replace(/{n}/g, start+2);
    preview.textContent = ex1 + '  \u2192  ' + ex2 + '  \u2192  ' + ex3 + '  ...';
    preview.style.display = 'block';
  }
  document.addEventListener('DOMContentLoaded', function() {
    var si = document.getElementById('engine-start');
    var ei = document.getElementById('engine-end');
    if (si) si.addEventListener('input', updateUrlPreview);
    if (ei) ei.addEventListener('input', updateUrlPreview);
  });

  async function startAutoEngine() {
    if (engineRunning) return;
    var novelId  = document.getElementById('engine-novel-select').value;
    var pattern  = document.getElementById('engine-url-pattern').value.trim();
    var startNum = parseInt(document.getElementById('engine-start').value)||1;
    var endNum   = parseInt(document.getElementById('engine-end').value)||1;

    if (!novelId)  { alert('ì†Œì„¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
    if (!pattern)  { alert('URL íŒ¨í„´ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!\n\nì˜ˆì‹œ:\nhttps://ixdzs.tw/read/128871/p{n}.html\nhttps://example.com/chapter-{n}.html'); return; }
    if (!pattern.includes('{n}')) { alert('{n} ì´ ì—†ì–´ìš”!\n\nìˆ«ìê°€ ë°”ë€ŒëŠ” ìë¦¬ì— {n} ì„ ë„£ì–´ì£¼ì„¸ìš”.\n\nì˜ˆì‹œ:\np1.html â†’ p{n}.html\nchapter-1.html â†’ chapter-{n}.html'); return; }
    if (startNum > endNum) { alert('ì‹œì‘ í˜ì´ì§€ê°€ ì¢…ë£Œ í˜ì´ì§€ë³´ë‹¤ í´ ìˆ˜ ì—†ì–´ìš”!'); return; }

    var total = endNum - startNum + 1;
    engineRunning = true;
    var btn = document.getElementById('engine-start-btn');
    btn.disabled=true; btn.textContent='â³ ì§„í–‰ ì¤‘...';
    document.getElementById('engine-progress-panel').style.display='block';
    document.getElementById('engine-log').innerHTML='';
    setProgress(0, total);

    // ê¸°ì¡´ ì±•í„° ìˆ˜ íŒŒì•… (ì´ì–´ì„œ ì €ì¥í•  ë•Œë¥¼ ìœ„í•´)
    var existRes = await fetch(SUPABASE_URL+'/rest/v1/novel_chapters?novel_id=eq.'+novelId+'&select=id', { headers:sbH() });
    var existing = await existRes.json();
    var chapOffset = Array.isArray(existing) ? existing.length : 0;

    var doneCount = 0;

    for (var i=0; i<total; i++) {
      var pageNum = startNum + i;
      var chapNum = chapOffset + i + 1;
      var url = pattern.replace(/{n}/g, pageNum);

      engineLog('â”€â”€ CH'+chapNum+' | í˜ì´ì§€ '+pageNum, 'info');
      engineLog('  ğŸ“¡ í¬ë¡¤ë§: '+url, 'working');

      var rawText, translated;

      try {
        rawText = await crawlPage(url);
        engineLog('  âœ… í¬ë¡¤ë§ ì™„ë£Œ ('+rawText.length+'ì)', 'success');
      } catch(e) {
        engineLog('  âŒ í¬ë¡¤ë§ ì‹¤íŒ¨: '+e.message, 'fail');
        engineLog('  ğŸ›‘ ì—”ì§„ ì¦‰ì‹œ ì¤‘ë‹¨', 'fail'); break;
      }

      engineLog('  ğŸ¤– ë²ˆì—­ ì¤‘...', 'working');
      try {
        translated = await translateText(rawText);
        engineLog('  âœ… ë²ˆì—­ ì™„ë£Œ ('+translated.length+'ì)', 'success');
      } catch(e) {
        engineLog('  âŒ ë²ˆì—­ ì‹¤íŒ¨: '+e.message, 'fail');
        engineLog('  ğŸ›‘ ì—”ì§„ ì¦‰ì‹œ ì¤‘ë‹¨', 'fail'); break;
      }

      try {
        var sr = await fetch(SUPABASE_URL+'/rest/v1/novel_chapters', {
          method:'POST', headers:sbH(),
          body: JSON.stringify({ novel_id: novelId, chapter_num: chapNum, original: rawText, translated: translated })
        });
        if (!sr.ok) throw new Error('HTTP '+sr.status);
        engineLog('  ğŸ’¾ ì €ì¥ ì™„ë£Œ â†’ CH'+chapNum, 'success');
      } catch(e) {
        engineLog('  âŒ ì €ì¥ ì‹¤íŒ¨: '+e.message, 'fail');
        engineLog('  ğŸ›‘ ì—”ì§„ ì¦‰ì‹œ ì¤‘ë‹¨', 'fail'); break;
      }

      doneCount++;
      setProgress(doneCount, total);

      // ì±•í„° ê°„ ë”œë ˆì´ (Gemini ë ˆì´íŠ¸ ë¦¬ë°‹ ë°©ì§€)
      if (i < total-1) {
        engineLog('  â± 2ì´ˆ ëŒ€ê¸°...', 'info');
        await new Promise(function(r){ setTimeout(r, 2000); });
      }
    }

    // ì™„ë£Œ ì²˜ë¦¬
    engineRunning = false;
    btn.disabled=false; btn.textContent='ğŸš€ ìë™ ë²ˆì—­ ì‹œì‘';

    if (doneCount === total) {
      engineLog('', 'info');
      engineLog('ğŸ‰ ì „ì²´ ì™„ë£Œ! '+doneCount+'ê°œ ì±•í„° ì €ì¥ë¨', 'success');
      engineLog('ğŸ“š ì„œì¬ë¡œ ìë™ ì´ë™...', 'success');
      try {
        await fetch(SUPABASE_URL+'/rest/v1/novels?id=eq.'+novelId, { method:'PATCH', headers:sbH(), body:JSON.stringify({status:'done'}) });
      } catch(e) {}
      setTimeout(function(){ switchTab('done'); }, 1500);
    } else {
      engineLog('', 'info');
      engineLog('âš ï¸ '+doneCount+'/'+total+' ì±•í„° ì €ì¥ í›„ ì¤‘ë‹¨ë¨', 'fail');
      engineLog('âœï¸ ì§„í–‰ íƒ­ì—ì„œ ì €ì¥ëœ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”', 'info');
    }
  }

  // â”€â”€ ë‹¨ì¼ ë²ˆì—­ ì €ì¥ ëª¨ë‹¬ â”€â”€
  async function updateChapterNumPreview() {
    var nid=document.getElementById('save-novel-select').value, label=document.getElementById('save-chapter-num-label');
    if (!nid) { label.textContent='ì†Œì„¤ì„ ì„ íƒí•˜ë©´ ì±•í„° ë²ˆí˜¸ê°€ í‘œì‹œë©ë‹ˆë‹¤'; return; }
    try {
      var r=await fetch(SUPABASE_URL+'/rest/v1/novel_chapters?novel_id=eq.'+nid+'&select=id',{headers:sbH()});
      var ex=await r.json(); label.textContent='CHAPTER '+((Array.isArray(ex)?ex.length:0)+1)+'ë¡œ ì €ì¥ë©ë‹ˆë‹¤';
    } catch(e) {}
  }
  async function openSaveModal() {
    var res=await fetch(SUPABASE_URL+'/rest/v1/novels?status=eq.progress&order=created_at.desc',{headers:sbH()});
    var novels=await res.json(); var sel=document.getElementById('save-novel-select');
    sel.innerHTML='<option value="">ì†Œì„¤ ì„ íƒ...</option>';
    (novels||[]).forEach(function(n){ var o=document.createElement('option'); o.value=n.id; o.textContent=(n.cover_emoji||'ğŸ“–')+' '+n.title; sel.appendChild(o); });
    var q=document.getElementById('quick-novel-select').value;
    if (q) { sel.value=q; await updateChapterNumPreview(); }
    else document.getElementById('save-chapter-num-label').textContent='ì†Œì„¤ì„ ì„ íƒí•˜ë©´ ì±•í„° ë²ˆí˜¸ê°€ í‘œì‹œë©ë‹ˆë‹¤';
    sel.onchange=updateChapterNumPreview;
    document.getElementById('save-modal').style.display='flex';
  }
  function closeSaveModal() { document.getElementById('save-modal').style.display='none'; }
  async function confirmSaveChapter() {
    var nid=document.getElementById('save-novel-select').value;
    if (!nid) { alert('ì†Œì„¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
    try {
      var r=await fetch(SUPABASE_URL+'/rest/v1/novel_chapters?novel_id=eq.'+nid+'&select=id',{headers:sbH()});
      var ex=await r.json(); var nextNum=(Array.isArray(ex)?ex.length:0)+1;
      var sr=await fetch(SUPABASE_URL+'/rest/v1/novel_chapters',{method:'POST',headers:sbH(),body:JSON.stringify({novel_id:nid,chapter_num:nextNum,original:lastOriginal,translated:lastTranslated})});
      if (!sr.ok) throw new Error('HTTP '+sr.status);
      closeSaveModal(); alert('CHAPTER '+nextNum+' ì €ì¥ ì™„ë£Œ! âœ…');
    } catch(e) { alert('ì €ì¥ ì‹¤íŒ¨: '+e.message); }
  }

  init();
</script>
</body>
</html>
