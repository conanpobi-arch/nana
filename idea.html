<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>NANA LAB - ì•„ì´ë””ì–´ ì²´í¬</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root { --neon: #00ffcc; --border: rgba(0,255,204,0.2); }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html { height: 100%; background: #000; }
    body { min-height: 100%; background: #000; color: #fff; font-family: 'Noto Sans KR', sans-serif; }

    #galaxy-bg { position: fixed; inset: 0; z-index: 0; background: radial-gradient(circle at center, #001220 0%, #000 100%); pointer-events: none; }

    .home-btn { position: fixed; top: 20px; left: 20px; text-decoration: none; font-size: 24px; color: var(--neon); z-index: 100; transition: 0.3s; }

    .container { position: relative; z-index: 2; max-width: 700px; margin: 0 auto; padding: 70px 20px 40px; }

    .header { text-align: center; margin-bottom: 18px; }
    .page-title { font-family: 'Orbitron'; color: var(--neon); text-shadow: 0 0 15px var(--neon); font-size: 1.6rem; letter-spacing: 6px; }
    .page-sub { font-size: 11px; color: rgba(0,255,204,0.5); margin-top: 8px; letter-spacing: 2px; font-family: 'Orbitron'; }

    .tab-bar { display: flex; gap: 8px; margin-bottom: 18px; }
    .tab-btn { flex: 1; padding: 10px; background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 12px; color: #aaa; font-family: 'Orbitron'; font-size: 11px; letter-spacing: 1px; cursor: pointer; transition: 0.2s; text-align: center; user-select: none; }
    .tab-btn.active { background: rgba(0,255,204,0.15); border-color: var(--neon); color: var(--neon); }

    .section-label { font-size: 11px; color: rgba(0,255,204,0.7); letter-spacing: 3px; font-family: 'Orbitron'; margin-bottom: 10px; }

    .field-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 20px; }
    .field-btn { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 12px; padding: 11px 14px; cursor: pointer; transition: 0.2s; font-size: 13px; color: #ccc; display: flex; align-items: center; gap: 8px; user-select: none; -webkit-user-select: none; }
    .field-btn span { font-size: 18px; pointer-events: none; }
    .field-btn.active { background: rgba(0,255,204,0.15); border-color: var(--neon); color: var(--neon); box-shadow: 0 0 12px rgba(0,255,204,0.2); }

    .input-area { margin-bottom: 15px; }
    textarea { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 14px; color: #fff; padding: 15px; font-size: 14px; outline: none; height: 130px; resize: none; font-family: 'Noto Sans KR'; line-height: 1.7; transition: border-color 0.3s; }
    textarea:focus { border-color: var(--neon); }
    textarea::placeholder { color: rgba(255,255,255,0.25); }

    .btn-fire { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 14px; font-weight: 900; font-family: 'Orbitron'; cursor: pointer; font-size: 13px; letter-spacing: 2px; box-shadow: 0 5px 20px rgba(0,255,204,0.3); }

    #history-panel { display: none; }
    .history-card { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 14px; padding: 15px; margin-bottom: 12px; transition: 0.2s; }
    .history-card-field { font-size: 11px; color: var(--neon); font-family: 'Orbitron'; letter-spacing: 1px; margin-bottom: 6px; pointer-events: none; }
    .history-card-idea { font-size: 13px; color: #ddd; line-height: 1.5; margin-bottom: 6px; pointer-events: none; }
    .history-card-date { font-size: 11px; color: rgba(255,255,255,0.3); pointer-events: none; }
    .history-card-body { cursor: pointer; }
    .history-card-actions { display: flex; gap: 8px; margin-top: 10px; }
    .hc-btn { flex: 1; padding: 8px 4px; border-radius: 8px; font-size: 12px; cursor: pointer; border: 1px solid var(--border); background: rgba(255,255,255,0.04); color: #aaa; text-align: center; transition: 0.2s; user-select: none; }
    .hc-btn.share:active, .hc-btn.share:hover { border-color: var(--neon); color: var(--neon); }
    .hc-btn.del:active, .hc-btn.del:hover { border-color: #ff4444; color: #ff4444; }
    .history-empty { text-align: center; color: rgba(255,255,255,0.3); font-size: 13px; padding: 60px 0; font-family: 'Orbitron'; letter-spacing: 2px; }

    /* ë¡œë”© */
    #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
    .loader { width: 46px; height: 46px; border: 3px solid rgba(0,255,204,0.1); border-top: 3px solid var(--neon); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 18px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .load-text { color: var(--neon); font-family: 'Orbitron'; font-size: 13px; letter-spacing: 2px; }

    /* ê²°ê³¼ */
    #res-box { display: none; position: fixed; inset: 0; background: #050a14; z-index: 5000; overflow-y: auto; padding: 50px 28px 140px; font-family: 'Noto Sans KR'; line-height: 2.1; font-size: 16px; color: #ececec; word-break: keep-all; -webkit-overflow-scrolling: touch; }
    .res-field-badge { display: inline-block; background: rgba(0,255,204,0.15); border: 1px solid var(--neon); border-radius: 20px; padding: 5px 16px; font-size: 12px; color: var(--neon); font-family: 'Orbitron'; letter-spacing: 2px; margin-bottom: 25px; }
    .res-paragraph { display: block; margin-bottom: 28px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,255,204,0.05); }
    .res-section-title { color: var(--neon); font-weight: 700; font-size: 1.05em; display: block; margin-top: 30px; margin-bottom: 8px; border-left: 3px solid var(--neon); padding-left: 12px; }

    #res-bottom-bar { display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 5001; background: rgba(0,10,25,0.98); border-top: 1px solid var(--border); backdrop-filter: blur(25px); padding: 20px; align-items: center; gap: 12px; }
    .copy-btn { width: 55px; height: 55px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; }
    .back-btn { flex: 1; height: 55px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; border-radius: 14px; font-weight: 900; font-family: 'Orbitron'; font-size: 14px; cursor: pointer; }

    /* ê³µìœ  ëª¨ë‹¬ */
    #share-modal { display: none; position: fixed; inset: 0; z-index: 8000; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); align-items: flex-end; justify-content: center; }
    .share-sheet { width: 100%; max-width: 700px; background: rgba(0,15,35,0.98); border: 1px solid var(--border); border-radius: 24px 24px 0 0; padding: 30px 25px 50px; }
    .share-title { font-family: 'Orbitron'; color: var(--neon); font-size: 13px; letter-spacing: 2px; margin-bottom: 20px; text-align: center; }
    .share-btns { display: flex; flex-direction: column; gap: 12px; }
    .share-opt-btn { width: 100%; padding: 16px; border-radius: 14px; font-size: 14px; font-weight: 700; cursor: pointer; border: 1px solid var(--border); background: rgba(255,255,255,0.04); color: #fff; text-align: left; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
    .share-opt-btn:active { border-color: var(--neon); background: rgba(0,255,204,0.08); }
    .share-cancel-btn { width: 100%; padding: 14px; border-radius: 14px; font-size: 13px; cursor: pointer; border: 1px solid var(--border); background: transparent; color: #aaa; margin-top: 8px; font-family: 'Orbitron'; }
  </style>
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"></script>
</head>
<body>
<div id="galaxy-bg"></div>
<a href="index.html" class="home-btn">ğŸ </a>

<div id="loading-overlay">
  <div class="loader"></div>
  <div class="load-text">IDEA ANALYZING...</div>
</div>

<div class="container">
  <div class="header">
    <div class="page-title">IDEA CHECK</div>
    <div class="page-sub">AI-POWERED IDEA ANALYZER</div>
  </div>

  <div class="tab-bar">
    <div class="tab-btn active" id="tab-new" onclick="switchTab('new')">ğŸ’¡ NEW IDEA</div>
    <div class="tab-btn" id="tab-history" onclick="switchTab('history')">ğŸ“‚ HISTORY</div>
  </div>

  <!-- ìƒˆ ì•„ì´ë””ì–´ íŒ¨ë„ -->
  <div id="new-panel">
    <div class="section-label">STEP 1 â€” ë¶„ì•¼ ì„ íƒ</div>
    <div class="field-grid">
      <div class="field-btn" data-field="ìŠ¤íƒ€íŠ¸ì—… / ì°½ì—…" onclick="selectField(this)"><span>ğŸš€</span>ìŠ¤íƒ€íŠ¸ì—… / ì°½ì—…</div>
      <div class="field-btn" data-field="ì•± / ì›¹ ì„œë¹„ìŠ¤" onclick="selectField(this)"><span>ğŸ“±</span>ì•± / ì›¹ ì„œë¹„ìŠ¤</div>
      <div class="field-btn" data-field="íˆ¬ì / ì¬í…Œí¬" onclick="selectField(this)"><span>ğŸ’°</span>íˆ¬ì / ì¬í…Œí¬</div>
      <div class="field-btn" data-field="ì½˜í…ì¸  / ë¯¸ë””ì–´" onclick="selectField(this)"><span>ğŸ¬</span>ì½˜í…ì¸  / ë¯¸ë””ì–´</div>
      <div class="field-btn" data-field="ì»¤ë¨¸ìŠ¤ / ì œí’ˆ" onclick="selectField(this)"><span>ğŸ›ï¸</span>ì»¤ë¨¸ìŠ¤ / ì œí’ˆ</div>
      <div class="field-btn" data-field="í—¬ìŠ¤ì¼€ì–´ / ì˜ë£Œ" onclick="selectField(this)"><span>ğŸ¥</span>í—¬ìŠ¤ì¼€ì–´ / ì˜ë£Œ</div>
      <div class="field-btn" data-field="ê²Œì„ / ì—”í„°í…Œì¸ë¨¼íŠ¸" onclick="selectField(this)"><span>ğŸ®</span>ê²Œì„ / ì—”í„°í…Œì¸ë¨¼íŠ¸</div>
      <div class="field-btn" data-field="ë¶€ë™ì‚° / ì¸í…Œë¦¬ì–´" onclick="selectField(this)"><span>ğŸ </span>ë¶€ë™ì‚° / ì¸í…Œë¦¬ì–´</div>
      <div class="field-btn" data-field="AI / ìë™í™”" onclick="selectField(this)"><span>ğŸ¤–</span>AI / ìë™í™”</div>
      <div class="field-btn" data-field="êµìœ¡ / ìê¸°ê³„ë°œ" onclick="selectField(this)"><span>ğŸ“š</span>êµìœ¡ / ìê¸°ê³„ë°œ</div>
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <div class="section-label" style="margin-bottom:0">STEP 2 â€” ì•„ì´ë””ì–´ ìƒì„¸ ë‚´ìš©</div>
      <div onclick="document.getElementById('ideaInput').value=''" style="font-size:22px; cursor:pointer; color:rgba(0,255,204,0.5); transition:0.2s;" onmouseover="this.style.color='#00ffcc'" onmouseout="this.style.color='rgba(0,255,204,0.5)'">ğŸ—‘ï¸</div>
    </div>
    <div class="input-area">
      <textarea id="ideaInput" placeholder="ì•„ì´ë””ì–´ë¥¼ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea>
    </div>
    <button class="btn-fire" onclick="analyzeIdea()">ğŸ’¡ IDEA ANALYZE START</button>
  </div>

  <!-- íˆìŠ¤í† ë¦¬ íŒ¨ë„ -->
  <div id="history-panel">
    <div id="history-list"></div>
  </div>
</div>

<!-- ê²°ê³¼ -->
<div id="res-box"></div>
<div id="res-bottom-bar">
  <div class="copy-btn" onclick="copyResult()">ğŸ“‹</div>
  <button class="back-btn" onclick="closeResult()">ğŸ”„ ìƒˆ ì•„ì´ë””ì–´ ë¶„ì„</button>
</div>

<!-- ê³µìœ  ëª¨ë‹¬ -->
<div id="share-modal" onclick="closeShare()">
  <div class="share-sheet" onclick="event.stopPropagation()">
    <div class="share-title">ğŸ“¤ SHARE IDEA</div>
    <div class="share-btns">
      <button class="share-opt-btn" onclick="shareEmail()"><span style="font-size:22px">ğŸ“§</span><span>ì´ë©”ì¼ë¡œ ë³´ë‚´ê¸°</span></button>
      <button class="share-opt-btn" onclick="shareKakao()"><span style="font-size:22px">ğŸ’¬</span><span>ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë³´ë‚´ê¸°</span></button>
      <button class="share-opt-btn" onclick="shareCopy()"><span style="font-size:22px">ğŸ“‹</span><span>í´ë¦½ë³´ë“œ ë³µì‚¬</span></button>
    </div>
    <button class="share-cancel-btn" onclick="closeShare()">ì·¨ì†Œ</button>
  </div>
</div>

<script>
  Kakao.init('0fd231ff7768019f7db8b055f3aa98f0');

  const SUPABASE_URL = 'https://hbfvyhlrnccccerzbami.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiZnZ5aGxybmNjY2NlcnpiYW1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODc2NzIsImV4cCI6MjA4NzE2MzY3Mn0.V9LJZAzCGinYmwzvWGLbfLhAFRnz4pDG_rVaTwTg74A';

  let selectedField = '';
  let _shareField = '', _shareIdea = '', _shareResult = '';

  const placeholders = {
    'ìŠ¤íƒ€íŠ¸ì—… / ì°½ì—…': 'ì–´ë–¤ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ëŠ” ì°½ì—… ì•„ì´ë””ì–´ì¸ê°€ìš”? ì‹œì¥ ê·œëª¨ë‚˜ ìˆ˜ìµ ëª¨ë¸ë„ í•¨ê»˜ ì ì–´ì£¼ì„¸ìš”.',
    'ì•± / ì›¹ ì„œë¹„ìŠ¤': 'ì–´ë–¤ ì•±ì´ë‚˜ ì„œë¹„ìŠ¤ì¸ê°€ìš”? ì£¼ìš” ê¸°ëŠ¥ê³¼ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì ì–´ì£¼ì„¸ìš”.',
    'íˆ¬ì / ì¬í…Œí¬': 'ì–´ë–¤ íˆ¬ì ì•„ì´ë””ì–´ì¸ê°€ìš”? ì˜ˆìƒ ìˆ˜ìµë¥ , ë¦¬ìŠ¤í¬, íˆ¬ì ê¸°ê°„ ë“±ì„ ì ì–´ì£¼ì„¸ìš”.',
    'ì½˜í…ì¸  / ë¯¸ë””ì–´': 'ì–´ë–¤ ì½˜í…ì¸ ë¥¼ ë§Œë“¤ë ¤ í•˜ë‚˜ìš”? ì±„ë„, í˜•ì‹, íƒ€ê²Ÿ ì‹œì²­ìë¥¼ ì ì–´ì£¼ì„¸ìš”.',
    'ì»¤ë¨¸ìŠ¤ / ì œí’ˆ': 'ì–´ë–¤ ì œí’ˆì´ë‚˜ ì‡¼í•‘ ì•„ì´ë””ì–´ì¸ê°€ìš”? ì œí’ˆ íŠ¹ì§•ê³¼ íŒë§¤ ë°©ì‹ì„ ì ì–´ì£¼ì„¸ìš”.',
    'í—¬ìŠ¤ì¼€ì–´ / ì˜ë£Œ': 'ì–´ë–¤ í—¬ìŠ¤ì¼€ì–´ ì•„ì´ë””ì–´ì¸ê°€ìš”? ëŒ€ìƒ í™˜ìêµ°ì´ë‚˜ í•´ê²°í•˜ë ¤ëŠ” ì˜ë£Œ ë¬¸ì œë¥¼ ì ì–´ì£¼ì„¸ìš”.',
    'ê²Œì„ / ì—”í„°í…Œì¸ë¨¼íŠ¸': 'ì–´ë–¤ ê²Œì„ì´ë‚˜ ì—”í„°í…Œì¸ë¨¼íŠ¸ ì•„ì´ë””ì–´ì¸ê°€ìš”? ì¥ë¥´, í•µì‹¬ ì¬ë¯¸ ìš”ì†Œë¥¼ ì ì–´ì£¼ì„¸ìš”.',
    'ë¶€ë™ì‚° / ì¸í…Œë¦¬ì–´': 'ì–´ë–¤ ë¶€ë™ì‚° ë˜ëŠ” ì¸í…Œë¦¬ì–´ ì•„ì´ë””ì–´ì¸ê°€ìš”? ì§€ì—­, ê·œëª¨, ë°©ì‹ì„ ì ì–´ì£¼ì„¸ìš”.',
    'AI / ìë™í™”': 'ì–´ë–¤ AI ë˜ëŠ” ìë™í™” ì•„ì´ë””ì–´ì¸ê°€ìš”? ì–´ë–¤ ì‘ì—…ì„ ìë™í™”í•˜ë ¤ëŠ”ì§€ ì ì–´ì£¼ì„¸ìš”.',
    'êµìœ¡ / ìê¸°ê³„ë°œ': 'ì–´ë–¤ êµìœ¡ ì•„ì´ë””ì–´ì¸ê°€ìš”? í•™ìŠµ ëŒ€ìƒ, ë°©ì‹, ì»¤ë¦¬í˜ëŸ¼ ë°©í–¥ì„ ì ì–´ì£¼ì„¸ìš”.',
  };

  // â”€â”€ íƒ­ ì „í™˜ â”€â”€
  function switchTab(tab) {
    document.getElementById('tab-new').classList.toggle('active', tab === 'new');
    document.getElementById('tab-history').classList.toggle('active', tab === 'history');
    document.getElementById('new-panel').style.display = tab === 'new' ? 'block' : 'none';
    document.getElementById('history-panel').style.display = tab === 'history' ? 'block' : 'none';
    if (tab === 'history') loadHistory();
  }

  // â”€â”€ ë¶„ì•¼ ì„ íƒ â”€â”€
  function selectField(el) {
    document.querySelectorAll('.field-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    selectedField = el.dataset.field;
    const textarea = document.getElementById('ideaInput');
    textarea.placeholder = placeholders[selectedField] || 'ì•„ì´ë””ì–´ë¥¼ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”.';
    setTimeout(() => {
      document.querySelector('.input-area').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 150);
  }

  // â”€â”€ ë¶„ì„ â”€â”€
  async function analyzeIdea() {
    const idea = document.getElementById('ideaInput').value.trim();
    if (!selectedField) { alert('ë¶„ì•¼ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
    if (!idea) { alert('ì•„ì´ë””ì–´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
    document.getElementById('loading-overlay').style.display = 'flex';
    try {
      const res = await fetch('/api/idea', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ field: selectedField, idea })
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      await saveToSupabase(selectedField, idea, data.result);
      const savedField = selectedField;
      // ì´ˆê¸°í™”
      document.getElementById('ideaInput').value = '';
      document.getElementById('ideaInput').placeholder = 'ì•„ì´ë””ì–´ë¥¼ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”.';
      document.querySelectorAll('.field-btn').forEach(b => b.classList.remove('active'));
      selectedField = '';
      renderResult(savedField, idea, data.result);
    } catch (e) {
      document.getElementById('loading-overlay').style.display = 'none';
      alert('ì˜¤ë¥˜: ' + e.message);
    }
  }

  // â”€â”€ Supabase ì €ì¥ â”€â”€
  async function saveToSupabase(field, idea, result) {
    try {
      await fetch(SUPABASE_URL + '/rest/v1/ideas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_KEY,
          'Authorization': 'Bearer ' + SUPABASE_KEY,
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ field: field, idea: idea, result: result })
      });
    } catch (e) {
      console.warn('ì €ì¥ ì‹¤íŒ¨:', e.message);
    }
  }

  // â”€â”€ íˆìŠ¤í† ë¦¬ ë¡œë“œ â”€â”€
  async function loadHistory() {
    const listEl = document.getElementById('history-list');
    listEl.innerHTML = '<div class="history-empty">LOADING...</div>';
    try {
      const res = await fetch(SUPABASE_URL + '/rest/v1/ideas?order=created_at.desc&limit=50', {
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
      });
      const data = await res.json();
      if (!data.length) {
        listEl.innerHTML = '<div class="history-empty">ì €ì¥ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }
      listEl.innerHTML = '';
      data.forEach(function(item) {
        const date = new Date(item.created_at).toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        const card = document.createElement('div');
        card.className = 'history-card';
        card.innerHTML =
          '<div class="history-card-body">' +
            '<div class="history-card-field">ğŸ’¡ ' + item.field + '</div>' +
            '<div class="history-card-idea">' + item.idea.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>' +
            '<div class="history-card-date">' + date + '</div>' +
          '</div>' +
          '<div class="history-card-actions">' +
            '<div class="hc-btn share">ğŸ“¤ ê³µìœ </div>' +
            '<div class="hc-btn del">ğŸ—‘ï¸ ì‚­ì œ</div>' +
          '</div>';

        // ë³¸ë¬¸ í´ë¦­ â†’ ê²°ê³¼ ë³´ê¸°
        card.querySelector('.history-card-body').addEventListener('click', function() {
          renderResult(item.field, item.idea, item.result);
        });

        // ê³µìœ  ë²„íŠ¼
        card.querySelector('.hc-btn.share').addEventListener('click', function(e) {
          e.stopPropagation();
          openShare(item.field, item.idea, item.result);
        });

        // ì‚­ì œ ë²„íŠ¼
        card.querySelector('.hc-btn.del').addEventListener('click', function(e) {
          e.stopPropagation();
          deleteIdea(item.id, card);
        });

        listEl.appendChild(card);
      });
    } catch (e) {
      listEl.innerHTML = '<div class="history-empty">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    }
  }

  // â”€â”€ ì‚­ì œ â”€â”€
  async function deleteIdea(id, cardEl) {
    if (!confirm('ì´ ì•„ì´ë””ì–´ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      await fetch(SUPABASE_URL + '/rest/v1/ideas?id=eq.' + id, {
        method: 'DELETE',
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
      });
      cardEl.remove();
      if (!document.querySelector('.history-card')) {
        document.getElementById('history-list').innerHTML = '<div class="history-empty">ì €ì¥ëœ ì•„ì´ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      }
    } catch (e) {
      alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
    }
  }

  // â”€â”€ ê³µìœ  â”€â”€
  function openShare(field, idea, result) {
    _shareField = field;
    _shareIdea = idea;
    _shareResult = result;
    document.getElementById('share-modal').style.display = 'flex';
  }

  function closeShare() {
    document.getElementById('share-modal').style.display = 'none';
  }

  function getShareText() {
    return '[NANA LAB ì•„ì´ë””ì–´ ë¶„ì„]\n\në¶„ì•¼: ' + _shareField + '\n\nğŸ“ ì•„ì´ë””ì–´:\n' + _shareIdea + '\n\nğŸ“Š ë¶„ì„ ê²°ê³¼:\n' + _shareResult;
  }

  function shareEmail() {
    var subject = encodeURIComponent('[ì•„ì´ë””ì–´] ' + _shareField + ' - ' + _shareIdea.slice(0,20));
    var body = encodeURIComponent(getShareText());
    window.open('mailto:?subject=' + subject + '&body=' + body);
    closeShare();
  }

  function shareKakao() {
    var text = getShareText();
    if (navigator.share) {
      navigator.share({ title: '[ì•„ì´ë””ì–´] ' + _shareField, text: text });
    } else {
      navigator.clipboard.writeText(text).then(function() {
        alert('í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ëì–´ìš”!\nì¹´ì¹´ì˜¤í†¡ì—ì„œ ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš” ğŸ˜Š');
      });
    }
    closeShare();
  }

  function shareCopy() {
    navigator.clipboard.writeText(getShareText()).then(function() {
      alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ëì–´ìš”!');
    });
    closeShare();
  }

  // â”€â”€ ê²°ê³¼ ë Œë”ë§ â”€â”€
  function renderResult(field, idea, text) {
    var rb = document.getElementById('res-box');
    var escaped = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    var lines = escaped.split('\n');
    var ideaEsc = idea.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    var html = '<div class="res-field-badge">ğŸ’¡ ' + field + '</div>';
    html += '<div style="background:rgba(0,255,204,0.05);border:1px solid rgba(0,255,204,0.15);border-radius:12px;padding:14px 16px;margin-bottom:25px;font-size:14px;color:#ccc;line-height:1.8;white-space:pre-wrap;">' + ideaEsc + '</div>';
    var buffer = [];

    function flushBuffer() {
      if (!buffer.length) return;
      var content = buffer.join('<br>').trim();
      if (content) html += '<p class="res-paragraph">' + content + '</p>';
      buffer = [];
    }

    lines.forEach(function(line) {
      var trimmed = line.trim();
      if (!trimmed) {
        flushBuffer();
      } else if (/^(\d+\.|[âœ…âš ï¸ğŸ”´ğŸŸ¡ğŸŸ¢ğŸ”¥ğŸ’¡ğŸ“ŒğŸ¯ğŸ‘‰â–¶])/.test(trimmed)) {
        flushBuffer();
        html += '<span class="res-section-title">' + trimmed + '</span>';
      } else {
        buffer.push(trimmed);
      }
    });
    flushBuffer();

    rb.innerHTML = html;
    rb.style.display = 'block';
    rb.scrollTop = 0;
    document.getElementById('res-bottom-bar').style.display = 'flex';
    document.getElementById('loading-overlay').style.display = 'none';
  }

  function closeResult() {
    document.getElementById('res-box').style.display = 'none';
    document.getElementById('res-bottom-bar').style.display = 'none';
    switchTab('new');
  }

  function copyResult() {
    var text = document.getElementById('res-box').innerText;
    navigator.clipboard.writeText(text).then(function() {
      var btn = document.querySelector('.copy-btn');
      btn.innerText = 'âœ…';
      setTimeout(function() { btn.innerText = 'ğŸ“‹'; }, 1500);
    });
  }
</script>
</body>
</html>
