<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>NANA LAB - í• ì¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root { --neon: #00ffcc; --border: rgba(0,255,204,0.2); }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html { background: #000; }
    body { min-height: 100vh; background: #000; color: #fff; font-family: 'Noto Sans KR', sans-serif; }

    #galaxy-bg { position: fixed; inset: 0; z-index: 0; background: radial-gradient(circle at center, #001220 0%, #000 100%); pointer-events: none; }

    .home-btn { position: fixed; top: 20px; left: 20px; text-decoration: none; font-size: 24px; color: var(--neon); z-index: 100; transition: 0.3s; }

    .container { position: relative; z-index: 2; max-width: 700px; margin: 0 auto; padding: 70px 20px 120px; }

    .header { text-align: center; margin-bottom: 22px; }
    .page-title { font-family: 'Orbitron'; color: var(--neon); text-shadow: 0 0 15px var(--neon); font-size: 1.6rem; letter-spacing: 6px; }
    .page-sub { font-size: 11px; color: rgba(0,255,204,0.5); margin-top: 8px; letter-spacing: 2px; font-family: 'Orbitron'; }

    /* íƒ­ */
    .tab-bar { display: flex; gap: 8px; margin-bottom: 18px; }
    .tab-btn { flex: 1; padding: 10px; background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 12px; color: #aaa; font-family: 'Orbitron'; font-size: 11px; letter-spacing: 1px; cursor: pointer; transition: 0.2s; text-align: center; user-select: none; }
    .tab-btn.active { background: rgba(0,255,204,0.15); border-color: var(--neon); color: var(--neon); }

    /* í• ì¼ ëª©ë¡ */
    .todo-item { background: rgba(0,255,204,0.04); border: 1px solid var(--border); border-radius: 14px; padding: 14px 16px; margin-bottom: 10px; transition: 0.2s; }
    .todo-item.done { opacity: 0.45; }
    .todo-top { display: flex; align-items: flex-start; gap: 12px; }
    .todo-check { width: 24px; height: 24px; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: 0.2s; margin-top: 2px; }
    .todo-check.checked { background: var(--neon); border-color: var(--neon); color: #000; }
    .todo-body { flex: 1; }
    .todo-title { font-size: 15px; color: #eee; line-height: 1.5; word-break: keep-all; }
    .todo-item.done .todo-title { text-decoration: line-through; color: #666; }
    .todo-meta { display: flex; align-items: center; gap: 8px; margin-top: 6px; flex-wrap: wrap; }
    .todo-date { font-size: 11px; color: rgba(0,255,204,0.6); font-family: 'Orbitron'; letter-spacing: 1px; }
    .importance-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
    .imp-high { background: rgba(255,68,68,0.15); color: #ff6666; border: 1px solid rgba(255,68,68,0.3); }
    .imp-normal { background: rgba(0,255,204,0.1); color: var(--neon); border: 1px solid var(--border); }
    .imp-low { background: rgba(255,255,255,0.05); color: #888; border: 1px solid rgba(255,255,255,0.1); }
    .todo-memo { font-size: 12px; color: #888; margin-top: 5px; line-height: 1.6; }
    .todo-del { font-size: 16px; cursor: pointer; color: rgba(255,255,255,0.2); flex-shrink: 0; padding: 4px; transition: 0.2s; }
    .todo-del:hover { color: #ff4444; }

    /* ìº˜ë¦°ë” */
    .calendar-wrap { background: rgba(0,15,35,0.7); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
    .cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
    .cal-title { font-family: 'Orbitron'; color: var(--neon); font-size: 13px; letter-spacing: 2px; }
    .cal-nav { background: transparent; border: 1px solid var(--border); color: var(--neon); border-radius: 8px; padding: 4px 10px; cursor: pointer; font-size: 14px; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .cal-day-label { text-align: center; font-size: 10px; color: rgba(255,255,255,0.3); font-family: 'Orbitron'; padding: 4px 0; }
    .cal-day-label:first-child { color: #ff6666; }
    .cal-day-label:last-child { color: #6699ff; }
    .cal-cell { text-align: center; padding: 6px 2px; border-radius: 8px; font-size: 13px; color: #aaa; cursor: pointer; transition: 0.2s; position: relative; min-height: 36px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .cal-cell:hover { background: rgba(0,255,204,0.1); color: #fff; }
    .cal-cell.today { background: rgba(255,220,0,0.15); color: #ffd700; font-weight: 700; border: 1px solid #ffd700; }
    .cal-cell.selected { background: rgba(255,255,255,0.15); color: #fff; font-weight: 700; border: 1px solid rgba(255,255,255,0.5); }
    .cal-cell.has-todo::after { content: ''; width: 4px; height: 4px; background: var(--neon); border-radius: 50%; position: absolute; bottom: 3px; }
    .cal-cell.empty { cursor: default; }
    .cal-cell.other-month { color: rgba(255,255,255,0.2); }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state { text-align: center; color: rgba(255,255,255,0.3); font-size: 13px; padding: 50px 0; font-family: 'Orbitron'; letter-spacing: 2px; }

    /* í•˜ë‹¨ ì¶”ê°€ ë²„íŠ¼ */
    .add-fab { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, var(--neon), #00b4ff); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; box-shadow: 0 5px 20px rgba(0,255,204,0.4); z-index: 50; color: #000; font-weight: 900; transition: 0.2s; border: none; }
    .add-fab:active { transform: scale(0.93); }

    /* ì¶”ê°€ ëª¨ë‹¬ */
    #add-modal { display: none; position: fixed; inset: 0; z-index: 8000; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); align-items: flex-end; justify-content: center; }
    .modal-sheet { width: 100%; max-width: 700px; background: rgba(0,15,35,0.98); border: 1px solid var(--border); border-radius: 24px 24px 0 0; padding: 28px 24px 50px; }
    .modal-title { font-family: 'Orbitron'; color: var(--neon); font-size: 13px; letter-spacing: 3px; margin-bottom: 20px; text-align: center; }
    .modal-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 12px; color: #fff; padding: 13px 15px; font-size: 14px; outline: none; font-family: 'Noto Sans KR'; margin-bottom: 12px; transition: border-color 0.3s; }
    .modal-input:focus { border-color: var(--neon); }
    .modal-input::placeholder { color: rgba(255,255,255,0.25); }
    .modal-row { display: flex; gap: 10px; margin-bottom: 12px; }
    .modal-row .modal-input { margin-bottom: 0; }
    .imp-select { display: flex; gap: 8px; margin-bottom: 18px; }
    .imp-btn { flex: 1; padding: 9px; border-radius: 10px; font-size: 12px; cursor: pointer; border: 1px solid var(--border); background: rgba(255,255,255,0.04); color: #aaa; text-align: center; transition: 0.2s; user-select: none; }
    .imp-btn.active-high { background: rgba(255,68,68,0.15); border-color: #ff4444; color: #ff6666; }
    .imp-btn.active-normal { background: rgba(0,255,204,0.15); border-color: var(--neon); color: var(--neon); }
    .imp-btn.active-low { background: rgba(255,255,255,0.08); border-color: #888; color: #aaa; }
    .modal-btns { display: flex; gap: 10px; }
    .modal-cancel { flex: 1; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: transparent; color: #aaa; font-size: 13px; cursor: pointer; font-family: 'Orbitron'; }
    .modal-save { flex: 2; padding: 14px; border-radius: 12px; background: linear-gradient(135deg, var(--neon), #00b4ff); color: #000; border: none; font-weight: 900; font-size: 13px; cursor: pointer; font-family: 'Orbitron'; letter-spacing: 1px; }

    /* ë¡œë”© */
    #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; }
    .loader { width: 40px; height: 40px; border: 3px solid rgba(0,255,204,0.1); border-top: 3px solid var(--neon); border-radius: 50%; animation: spin 1s infinite linear; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div id="galaxy-bg"></div>
<a href="index.html" class="home-btn">ğŸ </a>

<div id="loading-overlay"><div class="loader"></div></div>

<div class="container">
  <div class="header">
    <div class="page-title">TODO</div>
    <div class="page-sub">TASK & SCHEDULE MANAGER</div>
  </div>

  <div class="tab-bar">
    <div class="tab-btn active" id="tab-todo" onclick="switchTab('todo')">âœ… í• ì¼</div>
    <div class="tab-btn" id="tab-cal" onclick="switchTab('cal')">ğŸ“… ìº˜ë¦°ë”</div>
  </div>

  <!-- í• ì¼ íŒ¨ë„ -->
  <div id="todo-panel">
    <div id="todo-list"><div class="empty-state">LOADING...</div></div>
  </div>

  <!-- ìº˜ë¦°ë” íŒ¨ë„ -->
  <div id="cal-panel" style="display:none">
    <div class="calendar-wrap">
      <div class="cal-header">
        <button class="cal-nav" onclick="changeMonth(-1)">â—€</button>
        <div class="cal-title" id="cal-title"></div>
        <button class="cal-nav" onclick="changeMonth(1)">â–¶</button>
      </div>
      <div class="cal-grid" id="cal-grid"></div>
    </div>
    <div id="cal-todo-list"><div class="empty-state" style="padding:30px 0">ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div></div>
  </div>
</div>

<!-- ì¶”ê°€ FAB -->
<button class="add-fab" onclick="openModal()">+</button>

<!-- ì¶”ê°€ ëª¨ë‹¬ -->
<div id="add-modal" onclick="closeModal()">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-title">+ NEW TASK</div>
    <input class="modal-input" id="input-title" placeholder="í• ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
    <textarea class="modal-input" id="input-memo" placeholder="ë©”ëª¨ (ì„ íƒì‚¬í•­)" style="height:70px;resize:none;"></textarea>
    <div class="modal-row">
      <input class="modal-input" id="input-date" type="date">
      <input class="modal-input" id="input-time" type="time">
    </div>
    <div class="imp-select">
      <div class="imp-btn active-high" data-imp="high" onclick="selectImp(this)">ğŸ”´ ë†’ìŒ</div>
      <div class="imp-btn" data-imp="normal" onclick="selectImp(this)">ğŸŸ¡ ë³´í†µ</div>
      <div class="imp-btn" data-imp="low" onclick="selectImp(this)">âšª ë‚®ìŒ</div>
    </div>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="modal-save" onclick="saveTodo()">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://hbfvyhlrnccccerzbami.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiZnZ5aGxybmNjY2NlcnpiYW1pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODc2NzIsImV4cCI6MjA4NzE2MzY3Mn0.V9LJZAzCGinYmwzvWGLbfLhAFRnz4pDG_rVaTwTg74A';

  let currentTab = 'todo';
  let selectedImp = 'high';
  let calYear, calMonth, selectedDate = null;
  let allTodos = [];

  const today = new Date();
  calYear = today.getFullYear();
  calMonth = today.getMonth();

  // â”€â”€ íƒ­ ì „í™˜ â”€â”€
  function switchTab(tab) {
    currentTab = tab;
    document.getElementById('tab-todo').classList.toggle('active', tab === 'todo');
    document.getElementById('tab-cal').classList.toggle('active', tab === 'cal');
    document.getElementById('todo-panel').style.display = tab === 'todo' ? 'block' : 'none';
    document.getElementById('cal-panel').style.display = tab === 'cal' ? 'block' : 'none';
    if (tab === 'cal') renderCalendar();
  }

  // â”€â”€ Supabase í—¤ë” â”€â”€
  function sbHeaders() {
    return { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY };
  }

  // â”€â”€ í• ì¼ ë¡œë“œ â”€â”€
  async function loadTodos() {
    try {
      var res = await fetch(SUPABASE_URL + '/rest/v1/todos?order=date.asc,created_at.asc', { headers: sbHeaders() });
      allTodos = await res.json();
      renderTodos(allTodos);
    } catch(e) {
      document.getElementById('todo-list').innerHTML = '<div class="empty-state">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
    }
  }

  // â”€â”€ í• ì¼ ë Œë”ë§ â”€â”€
  function renderTodos(todos) {
    var listEl = document.getElementById('todo-list');
    if (!todos.length) { listEl.innerHTML = '<div class="empty-state">í• ì¼ì´ ì—†ì–´ìš” ğŸ˜Š</div>'; return; }

    // ì™„ë£Œ ì•ˆëœ ê²ƒ ë¨¼ì €, ì™„ë£Œëœ ê²ƒ ë’¤ë¡œ
    var sorted = todos.slice().sort(function(a, b) { return a.done - b.done; });
    listEl.innerHTML = '';
    sorted.forEach(function(item) { listEl.appendChild(makeTodoCard(item)); });
  }

  function makeTodoCard(item) {
    var card = document.createElement('div');
    card.className = 'todo-item' + (item.done ? ' done' : '');
    card.dataset.id = item.id;

    var impClass = item.importance === 'high' ? 'imp-high' : item.importance === 'low' ? 'imp-low' : 'imp-normal';
    var impLabel = item.importance === 'high' ? 'ğŸ”´ ë†’ìŒ' : item.importance === 'low' ? 'âšª ë‚®ìŒ' : 'ğŸŸ¡ ë³´í†µ';
    var dateStr = '';
    if (item.date) {
      dateStr = item.date;
      if (item.time) dateStr += ' ' + item.time.slice(0,5);
    }

    card.innerHTML =
      '<div class="todo-top">' +
        '<div class="todo-check ' + (item.done ? 'checked' : '') + '">âœ“</div>' +
        '<div class="todo-body">' +
          '<div class="todo-title">' + item.title.replace(/</g,'&lt;') + '</div>' +
          '<div class="todo-meta">' +
            (dateStr ? '<span class="todo-date">ğŸ“… ' + dateStr + '</span>' : '') +
            '<span class="importance-badge ' + impClass + '">' + impLabel + '</span>' +
          '</div>' +
          (item.memo ? '<div class="todo-memo">' + item.memo.replace(/</g,'&lt;') + '</div>' : '') +
        '</div>' +
        '<div class="todo-del">ğŸ—‘ï¸</div>' +
      '</div>';

    card.querySelector('.todo-check').addEventListener('click', function() { toggleDone(item.id, !item.done, card); });
    card.querySelector('.todo-del').addEventListener('click', function() { deleteTodo(item.id, card); });
    return card;
  }

  // â”€â”€ ì™„ë£Œ í† ê¸€ â”€â”€
  async function toggleDone(id, done, card) {
    try {
      await fetch(SUPABASE_URL + '/rest/v1/todos?id=eq.' + id, {
        method: 'PATCH',
        headers: sbHeaders(),
        body: JSON.stringify({ done: done })
      });
      card.classList.toggle('done', done);
      card.querySelector('.todo-check').classList.toggle('checked', done);
      // allTodos ì—…ë°ì´íŠ¸
      allTodos.forEach(function(t) { if (t.id === id) t.done = done; });
      // ì •ë ¬ ì¬ì ìš©
      renderTodos(allTodos);
    } catch(e) {}
  }

  // â”€â”€ ì‚­ì œ â”€â”€
  async function deleteTodo(id, card) {
    if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
    try {
      await fetch(SUPABASE_URL + '/rest/v1/todos?id=eq.' + id, {
        method: 'DELETE', headers: sbHeaders()
      });
      allTodos = allTodos.filter(function(t) { return t.id !== id; });
      renderTodos(allTodos);
      renderCalendar();
    } catch(e) {}
  }

  // â”€â”€ ëª¨ë‹¬ â”€â”€
  function openModal(date) {
    // ì„ íƒëœ ë‚ ì§œ or ì˜¤ëŠ˜ ë‚ ì§œ
    var d = date || new Date().toISOString().slice(0,10);
    document.getElementById('input-date').value = d;
    document.getElementById('input-time').value = '';
    document.getElementById('input-title').value = '';
    document.getElementById('input-memo').value = '';
    document.getElementById('add-modal').style.display = 'flex';
    setTimeout(function() { document.getElementById('input-title').focus(); }, 200);
  }

  function closeModal() {
    document.getElementById('add-modal').style.display = 'none';
  }

  function selectImp(el) {
    document.querySelectorAll('.imp-btn').forEach(function(b) { b.className = 'imp-btn'; });
    selectedImp = el.dataset.imp;
    el.classList.add('active-' + selectedImp);
  }

  // â”€â”€ ì €ì¥ â”€â”€
  async function saveTodo() {
    var title = document.getElementById('input-title').value.trim();
    if (!title) { alert('í• ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
    var date = document.getElementById('input-date').value || null;
    var time = document.getElementById('input-time').value || null;
    var memo = document.getElementById('input-memo').value.trim() || null;

    document.getElementById('loading-overlay').style.display = 'flex';
    try {
      var res = await fetch(SUPABASE_URL + '/rest/v1/todos', {
        method: 'POST',
        headers: Object.assign({}, sbHeaders(), { 'Prefer': 'return=representation' }),
        body: JSON.stringify({ title: title, memo: memo, date: date, time: time, importance: selectedImp, done: false })
      });
      var newItems = await res.json();
      if (newItems && newItems[0]) { allTodos.push(newItems[0]); }
      renderTodos(allTodos);
      if (currentTab === 'cal') renderCalendar();
      closeModal();
    } catch(e) { alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
    document.getElementById('loading-overlay').style.display = 'none';
  }

  // â”€â”€ ìº˜ë¦°ë” â”€â”€
  function renderCalendar() {
    var title = calYear + 'ë…„ ' + (calMonth + 1) + 'ì›”';
    document.getElementById('cal-title').textContent = title;

    var grid = document.getElementById('cal-grid');
    grid.innerHTML = '';

    // ìš”ì¼ í—¤ë”
    ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(function(d) {
      var el = document.createElement('div');
      el.className = 'cal-day-label';
      el.textContent = d;
      grid.appendChild(el);
    });

    var firstDay = new Date(calYear, calMonth, 1).getDay();
    var lastDate = new Date(calYear, calMonth + 1, 0).getDate();
    var todayStr = today.toISOString().slice(0,10);

    // ë¹ˆ ì¹¸
    for (var i = 0; i < firstDay; i++) {
      var el = document.createElement('div');
      el.className = 'cal-cell empty';
      grid.appendChild(el);
    }

    // ë‚ ì§œ
    for (var d = 1; d <= lastDate; d++) {
      var dateStr = calYear + '-' + String(calMonth+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
      var hasTodo = allTodos.some(function(t) { return t.date === dateStr; });
      var el = document.createElement('div');
      el.className = 'cal-cell' + (dateStr === todayStr ? ' today' : '') + (dateStr === selectedDate ? ' selected' : '') + (hasTodo ? ' has-todo' : '');
      el.textContent = d;
      el.dataset.date = dateStr;
      el.addEventListener('click', function() { selectCalDate(this.dataset.date); });
      grid.appendChild(el);
    }

    if (selectedDate) showCalTodos(selectedDate);
  }

  function changeMonth(dir) {
    calMonth += dir;
    if (calMonth < 0) { calMonth = 11; calYear--; }
    if (calMonth > 11) { calMonth = 0; calYear++; }
    renderCalendar();
  }

  function selectCalDate(date) {
    selectedDate = date;
    renderCalendar();
    showCalTodos(date);
    openModal(date);
  }

  function showCalTodos(date) {
    var listEl = document.getElementById('cal-todo-list');
    var filtered = allTodos.filter(function(t) { return t.date === date; });
    if (!filtered.length) {
      listEl.innerHTML = '<div class="empty-state" style="padding:30px 0">' + date + ' í• ì¼ ì—†ìŒ</div>';
      return;
    }
    listEl.innerHTML = '';
    filtered.forEach(function(item) { listEl.appendChild(makeTodoCard(item)); });
  }

  // ì´ˆê¸° ë¡œë“œ
  loadTodos();
</script>
</body>
</html>
